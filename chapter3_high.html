<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentellect - Calm Math Games</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Base Styles ===== */
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1e3a8a;
      --secondary: #f59e0b;
      --accent: #ec4899;
      --text: #1e293b;
      --text-light: #64748b;
      --text-lighter: #94a3b8;
      --bg: #f8fafc;
      --white: #ffffff;
      --gray: #e2e8f0;
      --gray-light: #f1f5f9;
      --success: #10b981;
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      --hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    h1, h2, h3, h4 {
      font-weight: 700;
      line-height: 1.2;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    section {
      padding: 60px 0;
    }

    .section-title {
      text-align: center;
      margin-bottom: 40px;
    }

    .section-title h2 {
      font-size: 2.2rem;
      color: var(--primary);
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }

    .section-title h2::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--secondary);
      border-radius: 2px;
    }

    .section-title p {
      color: var(--text-light);
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }

    .btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      cursor: pointer;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
    }

    .btn-secondary {
      background-color: var(--white);
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background-color: var(--primary);
      color: var(--white);
      transform: translateY(-2px);
    }
    
    /* Re-scoped button styles from other games */
    .calm-btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      cursor: pointer;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
    }
    .calm-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
    }
    .calm-btn.ghost {
      background-color: var(--white);
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .calm-btn.ghost:hover {
      background-color: var(--primary);
      color: var(--white);
    }
    
    /* Added small button style for new games */
    .calm-btn-small {
      padding: 10px 20px;
      font-size: 0.95em;
    }
    
    /* Adding a ghost style for the new small button */
    .calm-btn-small.ghost {
      background-color: var(--white);
      color: var(--primary);
      border: 2px solid var(--gray);
    }
    .calm-btn-small.ghost:hover {
      background-color: var(--gray-light);
      border-color: var(--primary-light);
    }

    /* ===== Animations ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .animate {
      animation: fadeIn 0.8s ease forwards;
    }

    .delay-1 { animation-delay: 0.2s; }
    .delay-2 { animation-delay: 0.4s; }
    .delay-3 { animation-delay: 0.6s; }

    /* ===== Header/Navbar ===== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background-color: var(--white);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    header.scrolled {
      padding: 10px 0;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: var(--white);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.2);
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      transition: all 0.3s ease;
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 30px;
    }

    .nav-links a {
      font-weight: 500;
      position: relative;
      padding: 5px 0;
      transition: color 0.3s ease;
    }

    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 3px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* CSS FOR CALCULUS QUEST
  You can paste this inside the <style> tag in your <head>
  or link it as a separate .css file.
*/

/* Styles for the new game card */
#calculus-quest-game .cq-island-title {
  font-size: 1.3rem;
  color: var(--primary);
  margin: 25px 0 10px;
  padding-bottom: 5px;
  border-bottom: 2px solid var(--gray-light);
}

#calculus-quest-game .cq-problem-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
}

#calculus-quest-game .cq-problem-btn {
  font-family: 'Courier New', Courier, monospace;
  font-size: 1.1em;
  padding: 12px;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  /* ADDING A TRANSITION FOR THE HOVER ANIMATION */
  transition: all 0.2s ease;
}

/* NEW HOVER ANIMATION FOR BUTTONS */
#calculus-quest-game .cq-problem-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--hover-shadow);
  border-color: var(--primary-light);
}

/* Styles for the Solution Modal */
.cq-modal {
  display: none; /* Hidden by default */
  position: fixed;
  z-index: 2000; /* High z-index to be on top */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(30, 41, 59, 0.6); /* Use text color with alpha */
  backdrop-filter: blur(5px);
  animation: fadeIn 0.3s ease; /* Use existing fadeIn for the background */
}

.cq-modal-content {
  background-color: var(--bg);
  margin: 5% auto;
  padding: 25px;
  border: 1px solid var(--gray);
  border-radius: 16px;
  width: 90%;
  max-width: 800px;
  box-shadow: var(--hover-shadow);
  position: relative;
  /* APPLYING THE NEW POP-IN ANIMATION */
  animation: cq-modal-pop 0.3s ease-out;
}

/* NEW KEYFRAME ANIMATION */
@keyframes cq-modal-pop {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.cq-modal-close-btn {
  color: var(--text-light);
  position: absolute;
  top: 15px;
  right: 25px;
  font-size: 2.5rem;
  font-weight: 700;
  border: none;
  background: none;
  cursor: pointer;
  line-height: 1;
}
.cq-modal-close-btn:hover {
  color: var(--text);
}

/* Styles for the solution box inside the modal */
#cq-modal-solution {
  max-height: 60vh;
  overflow-y: auto;
  background-color: var(--white); /* Brighter background for steps */
  padding: 20px;
}
#cq-modal-solution p {
  margin-bottom: 12px;
  line-height: 1.7;
}
#cq-modal-solution code {
  font-family: 'Courier New', Courier, monospace;
  background: var(--gray-light);
  border: 1px solid var(--gray);
  padding: 2px 5px;
  border-radius: 4px;
  font-size: 0.95em;
}
#cq-modal-solution h4 {
  color: var(--primary-dark);
  font-weight: 700;
  margin-top: 15px;
  margin-bottom: 10px;
  border-bottom: 1px solid var(--gray);
  padding-bottom: 5px;
}
#cq-modal-solution h4:first-child {
  margin-top: 0;
}

/* Table styles for Tabular Method */
.cq-table {
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 1em;
  width: 100%;
  font-family: 'Courier New', Courier, monospace;
}
.cq-table th, .cq-table td {
  border: 1px solid var(--gray);
  padding: 8px 12px;
  text-align: left;
}
.cq-table th {
  background-color: var(--gray-light);
  color: var(--primary-dark);
}
.cq-table tr:nth-child(even) {
  background-color: var(--white);
}

/* --- START: Variable Sorter Styles --- */
#variable-sorter-game .problem-display {
    background: var(--gray-light);
    border: 1px solid var(--gray);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    min-height: 90px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    font-family: 'Times New Roman', Times, serif;
    text-align: center;
    transition: all 0.5s ease-in-out;
}

#variable-sorter-game .guide-message {
    background-color: #e0f2fe; /* Light blue */
    border: 2px solid var(--primary-light);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    font-size: 1.1em;
    line-height: 1.6;
    text-align: center;
    color: #0c4a6e;
    opacity: 0;
    animation: vs-fadeIn 0.5s ease-out forwards;
}
@keyframes vs-fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

#variable-sorter-game #vs-game-area {
    position: relative;
    min-height: 300px;
    transition: all 0.5s ease-in-out;
}

/* Phase 1: Sorting (Drag & Drop) */
#variable-sorter-game #vs-sort-phase {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
#variable-sorter-game .sort-zone {
    background: var(--gray-light);
    border: 2px dashed var(--gray);
    border-radius: 8px;
    padding: 15px;
    min-height: 200px;
}
#variable-sorter-game .sort-zone h3 {
    text-align: center;
    color: var(--text-light);
    font-family: 'Roboto Mono', monospace;
}
#variable-sorter-game .drop-area {
    min-height: 100px;
    border-radius: 8px;
    transition: all 0.2s ease;
}
#variable-sorter-game .sort-zone.y-zone .drop-area.hover { background: #e0f2fe; }
#variable-sorter-game .sort-zone.x-zone .drop-area.hover { background: #fff7e6; }

#variable-sorter-game .toolbox {
    grid-column: 1 / -1;
    padding: 15px;
    background: var(--gray-light);
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
}
#variable-sorter-game .brick {
    padding: 15px 20px;
    background: var(--white);
    border: 2px solid var(--gray);
    border-radius: 8px;
    cursor: grab;
    font-family: 'Roboto Mono', monospace;
    font-size: 1.2em;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
}
#variable-sorter-game .brick:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}
#variable-sorter-game .brick.dragging { opacity: 0.4; }
#variable-sorter-game .brick.dropped { display: none; }

#variable-sorter-game .drop-area .brick {
    cursor: default;
    background: var(--success);
    border-color: #059669;
    color: var(--white);
    margin: 10px;
}
#variable-sorter-game .drop-area .brick.x-brick {
    background: var(--secondary);
    border-color: #d97706;
    color: #422006;
}

/* Phase 2: Solving (Animated) */
#variable-sorter-game #vs-solve-phase {
    display: none; /* Hidden by default */
    font-family: 'Roboto Mono', monospace;
    font-size: 1.2em;
    line-height: 2;
    text-align: center;
}
#variable-sorter-game .solve-step {
    background: var(--gray-light);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease-out;
}
#variable-sorter-game .solve-step.visible {
    opacity: 1;
    transform: translateY(0);
}
#variable-sorter-game .final-answer {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--success);
}

/* Animation Classes */
#variable-sorter-game .wiggle-reject {
    animation: vs-wiggle 0.4s ease;
}
@keyframes vs-wiggle {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    60% { transform: translateX(8px); }
}

/* Calm Button */
#variable-sorter-game #vs-restart-btn {
    display: none; /* Hidden by default */
    margin: 20px auto 0;
    /* Uses .calm-btn class */
}
/* --- END: Variable Sorter Styles --- */


    .wz-guide-message {
      background-color: #e0f2fe; /* Using a light blue from the theme */
      border: 2px solid var(--primary-light);
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
      font-size: 1.15em;
      line-height: 1.6;
      text-align: center;
      color: #0c4a6e;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    /* This holds the buttons, adapted to the theme */
    .wz-spellbook {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    /* Use the existing .calm-btn class, but add glowing animation */
    .glowing-spell {
      animation: wz-glow 1.5s infinite alternate;
    }
    @keyframes wz-glow {
      from { box-shadow: 0 0 5px #fff, 0 0 10px var(--secondary), 0 0 15px var(--secondary); }
      to { box-shadow: 0 0 20px #fff, 0 0 30px var(--secondary), 0 0 40px var(--secondary); }
    }
    
    /* Problem transformation animations */
    .wz-transform-out {
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.4s ease-in-out;
    }
    .wz-transform-in {
      opacity: 1;
      transform: scale(1);
      transition: all 0.4s ease-in-out;
    }
    
    /* We can reuse the existing .shake keyframes */
    .nav-links a:hover::after,
    .nav-links a.active::after {
      width: 100%;
    }

    .nav-links a.active {
      color: var(--primary);
      font-weight: 600;
    }

    .auth-buttons {
      display: flex;
      gap: 15px;
    }

    .login-btn {
      padding: 8px 20px;
      border-radius: 50px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      color: var(--primary);
    }

    .signup-btn {
      padding: 8px 20px;
      border-radius: 50px;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      color: var(--white);
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(30, 64, 175, 0.25);
    }

    .signup-btn:hover {
      background: linear-gradient(to right, var(--primary-dark), var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(30, 64, 175, 0.35);
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
    }
    
    /* ===== Hero Section ===== */
    .hero {
      position: relative;
      padding: 160px 0 70px;
      background: linear-gradient(135deg, var(--primary), #004e92);
      color: var(--white);
      overflow: hidden;
      text-align: center;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjA1KSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3QgZmlsbD0idXJsKCNwYXR0ZXJuKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==');
    }

    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
    }

    .hero h1 {
      font-size: 2.8rem;
      margin-bottom: 20px;
      line-height: 1.2;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .hero h1 span {
      color: var(--secondary);
      position: relative;
    }

    .hero h1 span::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(255, 255, 255, 0.3);
      z-index: -1;
      border-radius: 4px;
    }

    .hero p {
      font-size: 1.2rem;
      margin-bottom: 40px;
      opacity: 0.9;
    }

    .hero-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .hero .btn-secondary {
      background-color: transparent;
      color: var(--white);
      border-color: var(--white);
    }

    .hero .btn-secondary:hover {
      background-color: var(--white);
      color: var(--primary);
    }

    .floating-shape {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      z-index: 0;
      animation: float 6s ease-in-out infinite;
    }

    .shape-1 {
      width: 150px;
      height: 150px;
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .shape-2 {
      width: 100px;
      height: 100px;
      bottom: 15%;
      right: 10%;
      animation-delay: 0.5s;
    }

    .shape-3 {
      width: 80px;
      height: 80px;
      top: 30%;
      right: 20%;
      animation-delay: 1s;
    }
    
    /* ===== Card Styles ===== */
    .card {
      background-color: var(--white);
      border-radius: 16px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      transition: width 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .card:hover::before {
      width: 8px;
    }

    h2 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 20px;
      font-weight: 600;
    }

    h3 {
      color: var(--primary);
      font-size: 1.4rem;
      margin: 20px 0 15px;
      font-weight: 600;
      position: relative;
      padding-left: 15px;
    }
    
    h3::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--secondary);
      border-radius: 50%;
    }

    p {
      color: var(--text-light);
      margin-bottom: 15px;
      line-height: 1.7;
    }
    /* --- START: Fraction Architect Styles --- */
#architect-game .problem-display {
    background: var(--gray-light);
    border: 1px solid var(--gray);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    min-height: 90px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    font-family: 'Times New Roman', Times, serif;
    text-align: center;
}

#architect-game .guide-message {
    background-color: #e0f2fe;
    border: 2px solid var(--primary-light);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    font-size: 1.1em;
    line-height: 1.6;
    text-align: center;
    color: #0c4a6e;
}

#architect-game #game-area {
    transition: all 0.5s ease-in-out;
}

/* Blueprint Area (Dropzones) */
#architect-game .blueprint-area {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    background: var(--gray-light);
    padding: 30px;
    border-radius: 8px;
    border: 2px dashed var(--gray);
}

#architect-game .dropzone {
    width: 150px;
    height: 70px;
    background: var(--white);
    border: 2px dashed var(--primary-light);
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5em;
    font-family: 'Roboto Mono', monospace;
    transition: all 0.2s ease;
}
#architect-game .dropzone.hover {
    background-color: #e0f2fe;
    transform: scale(1.05);
}
#architect-game .dropzone.filled {
    border-style: solid;
    border-color: var(--success);
    background-color: #d1fae5;
}

/* Toolbox (Draggable Bricks) */
#architect-game .toolbox {
    margin-top: 20px;
    padding: 20px;
    background: var(--gray-light);
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
}

#architect-game .brick {
    padding: 15px 20px;
    background: var(--white);
    border: 2px solid var(--gray);
    border-radius: 8px;
    cursor: grab;
    font-family: 'Roboto Mono', monospace;
    font-size: 1.1em;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
}
#architect-game .brick:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}
#architect-game .brick.dragging {
    opacity: 0.4;
    box-shadow: none;
    transform: scale(0.95);
}

/* Solve Area (Animated) */
#architect-game #solve-phase {
    text-align: center;
    margin-top: 20px;
    font-size: 1.2em;
    line-height: 1.8;
    position: relative;
}
#architect-game .solve-box {
    background: var(--gray-light);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--gray);
    margin-bottom: 10px;
}
#architect-game .cover-hand {
    position: absolute;
    font-size: 3em;
    opacity: 0;
    transition: all 0.4s ease;
}

/* Animation Classes */
#architect-game .wiggle-reject {
    animation: architect-wiggle 0.4s ease;
    border-color: var(--danger) !important;
}
@keyframes architect-wiggle {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    60% { transform: translateX(8px); }
}

#architect-game .fade-in {
    animation: architect-fade-in 0.5s ease-out;
}
@keyframes architect-fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Ensure restart button uses existing theme class */

/* --- END: Fraction Architect Styles --- */
    /* General Inputs (for new games) */
    input[type="text"], input[type="number"] {
      padding: 10px;
      border: 1px solid var(--gray);
      border-radius: 8px;
      font-size: 1em;
      margin: 0 5px;
      min-width: 100px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    /* General Feedback Results (for new games) */
    .result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      display: none; /* Hidden by default */
    }
    .result.success {
      background-color: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
      display: block;
    }
    .result.error {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      display: block;
    }
    .small {
      font-size: 0.9em;
      color: var(--text-light);
    }


    /* ===== Self-Care Notes ===== */
    .self-care {
      background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      border-left: 5px solid var(--accent);
      animation: pulse 3s infinite;
    }

    .self-care h4 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .self-care p {
      color: var(--text);
      font-size: 1.1rem;
      margin-bottom: 0;
    }

    /* ===== Completion Message ===== */
    .completion {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #dbeafe, #e0f2fe);
      border-radius: 16px;
      margin: 30px 0;
      animation: fadeIn 1s ease;
    }

    .completion h3 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 15px;
    }

    .completion p {
      font-size: 1.1rem;
      color: var(--text);
    }

    /* ===== Footer ===== */
    .footer {
      background: linear-gradient(to bottom, var(--primary-dark), #0f172a);
      color: var(--white);
      padding: 60px 0 20px;
      position: relative;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 10px;
      background: linear-gradient(90deg, var(--secondary), var(--primary));
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      margin-bottom: 40px;
    }

    .footer-about {
      grid-column: span 2;
    }

    .footer-logo {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .footer-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--white), var(--gray));
      color: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .footer-about p {
      opacity: 0.8;
      margin-bottom: 25px;
      line-height: 1.7;
    }

    .social-links {
      display: flex;
      gap: 15px;
    }

    .social-link {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .social-link:hover {
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
    }

    .footer-links h3 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      position: relative;
      padding-bottom: 10px;
      color: var(--white);
    }

    .footer-links h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 40px;
      height: 3px;
      background: linear-gradient(to right, var(--secondary), var(--accent));
    }

    .footer-links ul {
      list-style: none;
    }

    .footer-links li {
      margin-bottom: 12px;
    }

    .footer-links a {
      opacity: 0.8;
      transition: all 0.3s ease;
      position: relative;
      padding-left: 15px;
    }

    .footer-links a::before {
      content: 'â†’';
      position: absolute;
      left: 0;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .footer-links a:hover {
      opacity: 1;
      padding-left: 20px;
    }

    .footer-links a:hover::before {
      opacity: 1;
      left: -5px;
    }

    .footer-bottom {
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .footer-bottom p {
      opacity: 0.7;
      margin-bottom: 15px;
    }

    .footer-tags {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .tag {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 5px 15px;
      border-radius: 50px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .tag:hover {
      background: linear-gradient(to right, var(--secondary), var(--accent));
      color: var(--text);
      transform: translateY(-2px);
    }

    /* --- START: Antiderivative Coaster Styles --- */

#coaster-game .problem-display {
    background: var(--gray-light);
    border: 1px solid var(--gray);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    min-height: 90px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    font-family: 'Times New Roman', Times, serif;
    text-align: center;
}

#coaster-game .guide-message {
    background-color: #e3f2fd; /* Light blue */
    border: 2px solid var(--primary-light);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    font-size: 1.1em;
    line-height: 1.6;
    text-align: center;
    color: var(--primary);
}

#coaster-game #game-area {
    position: relative;
}

/* Graph Canvas */
#coaster-game #coaster-canvas-container {
    position: relative;
    height: 300px;
    background: var(--gray-light);
    border-radius: 8px;
}
#coaster-game #coaster-car {
    position: absolute;
    font-size: 2rem;
    opacity: 0;
    transition: all 1s ease-in-out;
    /* Start off-screen */
    left: -50px; 
    top: 150px;
    z-index: 10;
}

/* Control Buttons */
#coaster-game .controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 20px;
}

/* Use your existing .calm-btn class */
#coaster-game .calm-btn {
    font-family: 'Roboto', sans-serif;
    font-size: 1.1em;
    font-weight: 700;
    padding: 20px;
    background-color: var(--primary);
    color: var(--white);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 15px rgba(41, 98, 255, 0.3);
}
#coaster-game .calm-btn:hover:not(:disabled) {
    background-color: #2979ff;
    transform: translateY(-3px);
}
#coaster-game .calm-btn:disabled {
    background: var(--gray);
    color: var(--text-light);
    cursor: not-allowed;
    box-shadow: none;
}

/* Step-by-step calculation box */
#coaster-game #calculation-box {
    margin-top: 20px;
    padding: 20px;
    background: var(--gray-light);
    border-radius: 8px;
    min-height: 100px;
    font-size: 1.2em;
    font-family: 'Roboto Mono', monospace;
    line-height: 1.8;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease;
}
#coaster-game #calculation-box.visible {
    opacity: 1;
    transform: translateY(0);
}

#coaster-game .final-answer {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--success);
}

/* Restart Button */
#coaster-game #restart-btn {
    display: none; /* Hidden by default */
    margin: 20px auto 0;
    background: var(--secondary);
    color: var(--text);
    box-shadow: 0 4px 15px rgba(255, 196, 0, 0.4);
}
#coaster-game #restart-btn:hover {
    background: #ffd740;
}
/* --- END: Antiderivative Coaster Styles --- */
    
    /* ===== Floating Action Button ===== */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 6px 15px rgba(30, 64, 175, 0.3);
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    
    .fab:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.4);
    }

    /* ===== Visual Elements ===== */
    .math-emoji {
      font-size: 1.8rem;
      margin: 0 8px;
      animation: float 3s ease-in-out infinite;
    }
    
    /* This class is for the new games to display math formulas */
    .math-formula {
      font-family: 'Times New Roman', Times, serif;
      font-size: 1.5em;
      color: var(--primary-dark);
      background: var(--gray-light);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      border: 1px solid var(--gray);
    }
      .visual-element {
      text-align: center;
      margin: 15px 0;
    }

    .emoji-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 12px 0;
    }

    /* ===== Game Styles ===== */
    .game-container {
      background: #e6f2ff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
    }

    /* ===== Differential Drift Game Styles ===== */
    .diff-drift-game {
      background: var(--white);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(11,39,64,0.04);
      margin: 20px 0;
    }

    .diff-drift-header {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 18px;
    }

    .diff-drift-header h1 {
      font-size: 1.6rem;
      margin: 0;
      color: var(--primary);
    }

    .diff-drift-header p {
      margin: 4px 0 0;
      color: var(--text-light);
    }

    .diff-drift-grid {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
    }

    .diff-drift-card {
      background: var(--white);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(11,39,64,0.04);
    }

    .diff-drift-big {
      font-size: 1.15rem;
    }

    .diff-drift-small {
      font-size: 0.92rem;
      color: var(--text-light);
    }

    .diff-drift-levels {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }

    .diff-drift-levelBtn {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(11,39,64,0.06);
      background: linear-gradient(180deg,#fff,#fbfdff);
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .diff-drift-levelBtn.selected {
      box-shadow: 0 6px 20px rgba(125,211,252,0.12);
      border: 1px solid rgba(125,211,252,0.24);
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      color: #072033;
    }

    .diff-drift-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }

    .diff-drift-xfinal {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(11,39,64,0.06);
      font-size: 1rem;
    }

    .diff-drift-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(11,39,64,0.02), rgba(11,39,64,0.01));
      border: 1px dashed rgba(11,39,64,0.03);
    }

    .diff-drift-steps {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(180deg,#fbfdff,rgba(11,39,64,0.01));
      color: var(--text-light);
    }

    .diff-drift-blobArea {
      height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      background: linear-gradient(180deg,#f9feff,#ffffff);
      border: 1px solid rgba(11,39,64,0.03);
    }

    .diff-drift-curve {
      width: 100%;
      height: 100%;
    }

    .diff-drift-blob {
      position: absolute;
      left: 20%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #053246;
      box-shadow: 0 8px 24px rgba(7,32,48,0.08);
      background: linear-gradient(180deg, var(--primary-light), var(--accent));
      transition: transform 700ms cubic-bezier(.2,.9,.3,1), left 700ms cubic-bezier(.2,.9,.3,1), top 700ms;
    }

    .diff-drift-bubble {
      position: absolute;
      transform: translate(-50%,-130%);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 8px 20px rgba(7,32,48,0.06);
      font-weight: 600;
    }

    .diff-drift-calmMsg {
      margin-top: 8px;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .diff-drift-meter {
      height: 12px;
      border-radius: 999px;
      background: rgba(11,39,64,0.04);
      overflow: hidden;
      margin-top: 12px;
    }

    .diff-drift-meterFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transition: width 800ms cubic-bezier(.2,.9,.3,1);
    }

    .diff-drift-footerTip {
      margin-top: 12px;
      color: var(--text-light);
      font-size: 0.92rem;
    }

    .diff-drift-btnSoft {
      padding: 10px 12px;
      border-radius: 10px;
      border: 0;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      color: #072033;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .diff-drift-btnSoft:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.2);
    }

    .diff-drift-btnGhost {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(11,39,64,0.06);
      background: transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .diff-drift-btnGhost:hover {
      background: rgba(11,39,64,0.02);
    }

    .diff-drift-confetti {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    /* --- START: Area Surveyor Styles --- */

/* Scoping all rules to the game's ID */
#area-surveyor-game .problem-display {
    background: var(--gray-light);
    border: 1px solid var(--gray);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    min-height: 90px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    font-family: 'Times New Roman', Times, serif;
    text-align: center;
}

#area-surveyor-game .guide-message {
    background-color: #e0f2fe; /* Light blue */
    border: 2px solid var(--primary-light);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    font-size: 1.1em;
    line-height: 1.6;
    text-align: center;
    color: #0c4a6e;
}

#area-surveyor-game #as-game-area {
    position: relative;
    min-height: 300px;
}

/* Phase 1: Finding Bounds */
#area-surveyor-game #as-phase-1-bounds {
    font-family: 'Roboto Mono', monospace;
    font-size: 1.5em;
    text-align: center;
    padding: 20px;
}
#area-surveyor-game .bound-step {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease-out;
}
#area-surveyor-game .bound-step.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Phase 2: Building (Drag & Drop) */
#area-surveyor-game #as-phase-2-build {
    display: none; /* Hidden by default */
}
#area-surveyor-game .blueprint-area {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    background: var(--gray-light);
    padding: 30px;
    border-radius: 8px;
    border: 2px dashed var(--gray);
    font-size: 2.5em;
    font-family: 'Roboto Mono', monospace;
    color: var(--text-light);
}
#area-surveyor-game .dropzone {
    width: 100px;
    height: 70px;
    background: var(--white);
    border: 2px dashed var(--primary-light);
    border-radius: 8px;
    display: inline-block;
    vertical-align: middle;
    transition: all 0.2s ease;
}
#area-surveyor-game .dropzone.func { width: 200px; }
#area-surveyor-game .dropzone.hover { background-color: #e0f2fe; }
#area-surveyor-game .dropzone.filled {
    border-style: solid;
    border-color: var(--success);
    background-color: #d1fae5;
}

#area-surveyor-game .toolbox {
    margin-top: 20px;
    padding: 20px;
    background: var(--gray-light);
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
}
#area-surveyor-game .brick {
    padding: 15px 20px;
    background: var(--white);
    border: 2px solid var(--gray);
    border-radius: 8px;
    cursor: grab;
    font-family: 'Roboto Mono', monospace;
    font-size: 1.1em;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
#area-surveyor-game .brick.dragging { opacity: 0.4; }

/* Phase 3 & 4: Solving & Graphing */
#area-surveyor-game #as-phase-3-solve {
    display: none; /* Hidden */
    font-family: 'Roboto Mono', monospace;
    font-size: 1.2em;
    line-height: 1.8;
    text-align: center;
}
#area-surveyor-game .solve-step {
    background: var(--gray-light);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease-out;
}
#area-surveyor-game .solve-step.visible {
    opacity: 1;
    transform: translateY(0);
}
#area-surveyor-game #as-coaster-canvas-container {
    position: relative;
    height: 250px;
    background: var(--gray-light);
    border-radius: 8px;
    margin-top: 20px;
}

/* Animation Classes */
#area-surveyor-game .wiggle-reject {
    animation: as-wiggle 0.4s ease;
    border-color: var(--danger) !important;
}
@keyframes as-wiggle {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    60% { transform: translateX(8px); }
}
#area-surveyor-game .final-answer {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--success);
}

/* Calm Button */
#area-surveyor-game #as-restart-btn {
    display: none; /* Hidden by default */
    margin: 20px auto 0;
    /* Uses your existing .calm-btn class */
}
/* --- END: Area Surveyor Styles --- */
    
    /* Scoped styles for #starry-game to avoid interfering with site CSS */
    #starry-game .step-btn {  display: inline-block;
          padding: 12px 28px;
          border-radius: 50px;
          font-weight: 600;
          transition: all 0.3s ease;
          text-align: center;
          cursor: pointer; }
    #starry-game .btn-primary {
          background-color: var(--primary);
          color: var(--white);
          box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }

    #starry-game .step-btn-primary:hover {
          background-color: var(--primary-dark);
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }

    #starry-game .step-btn-secondary {
          background-color: var(--white);
          color: var(--primary);
          border: 2px solid var(--primary);
        }

    #starry-game .step-btn-secondary:hover {
          background-color: var(--primary);
          color: var(--white);
          transform: translateY(-2px);
        }
    #starry-game .quiet { border-radius:10px; padding:8px 10px; background: var(--gray-light); border: 1px solid var(--gray); cursor: pointer; }
    #starry-game .quiet:hover { background: var(--gray); }
    #starry-game .steps { color: var(--text-lighter); font-size:0.95rem; }
    #starry-game .formula-box { font-family: 'Courier New', monospace; font-size:1rem; padding:10px; border-radius:8px; background: var(--gray-light); border: 1px solid var(--gray);}
    #starry-game .answer { padding:10px; border-radius:8px; border:1px solid var(--gray); background:var(--white); font-size: 1em;}
    #starry-game .hint { color:var(--text-lighter); }
    #starry-game .progress-container { background:var(--gray); border-radius:999px; height:10px; overflow:hidden; }
    #starry-game .progress-bar { background: linear-gradient(to right, var(--primary), var(--secondary)); height:100%; width:0; transition: width 700ms ease; }

    /* Scoped game styles */
    #diff-game-card .step-btn.selected {
      box-shadow: 0 6px 20px rgba(125,211,252,0.12);
      border: 1px solid rgba(125,211,252,0.24);
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      color: #072033;
    }
    #diff-game-card .step-btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      cursor: pointer;
      background-color: var(--white);
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    #diff-game-card .step-btn:hover {
      background-color: var(--primary);
      color: var(--white);
    }

    #diff-game-card .formula-box { font-family:'Courier New', monospace; font-size:1rem; padding:10px; border-radius:8px; background: var(--gray-light); border: 1px solid var(--gray);}
    #diff-game-card .steps { color:var(--text-light); font-size:0.98rem; }
    #diff-game-card .solution { background:var(--gray-light); padding:10px; border-left:4px solid var(--secondary); border-radius:6px; }
    #diff-game-card .answer { padding:10px; border-radius:8px; border:1px solid var(--gray); background:var(--white); font-size: 1em;}
    #diff-game-card input[type="range"] { accent-color: var(--primary); }
    #diff-game-card .progress-container { background:var(--gray); border-radius:999px; height:10px; overflow:hidden; }
    #diff-game-card .progress-bar { background: linear-gradient(to right, var(--primary), var(--secondary)); height:100%; width:0; transition:width 700ms ease; }
    #diff-game-card .quiet { border-radius:10px; padding:8px 10px; background: var(--gray-light); border: 1px solid var(--gray); cursor: pointer; }
    #diff-game-card .quiet:hover { background: var(--gray); }
    
    
    /* --- START: STYLES FROM ORIGINAL FILE (for approximation games) --- */

    /* --- Game 1: Approximation Builder (Drag/Drop) --- */
    .recipe-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .step-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--gray-light);
      border: 1px solid var(--gray);
      border-radius: 8px;
    }
    .step-label {
      font-weight: 500;
      min-width: 180px;
      color: var(--text);
    }
    .dropzone {
      min-width: 100px;
      min-height: 44px;
      background: #e0f2fe;
      border: 2px dashed var(--primary-light);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: monospace;
      font-size: 1.1em;
      transition: background-color 0.2s;
    }
    .dropzone.filled {
      background: #bae6fd;
      border-style: solid;
      border-color: var(--primary-light);
    }
    .dropzone.correct {
      background: #d1fae5;
      border-color: var(--success);
    }
    .dropzone.wrong {
      background: #fee2e2;
      border-color: #fca5a5;
    }
    .tile-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: var(--gray-light);
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .tile {
      padding: 8px 12px;
      background: var(--white);
      border: 1px solid var(--gray);
      border-radius: 5px;
      cursor: grab;
      font-family: monospace;
      font-size: 1.1em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }
    .tile:active {
      cursor: grabbing;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transform: scale(0.95);
    }
    .tile.hidden {
      opacity: 0.4;
    }

    /* --- Game 2: Implicit Chain (Quest) --- */
    .quest-level {
      background: var(--gray-light);
      border: 1px solid var(--gray);
      border-radius: 8px;
      padding: 20px;
    }
    .quest-level .steps {
      font-size: 1.1em;
      line-height: 1.8;
      color: var(--text-light);
    }
    .quest-level .steps strong {
      color: var(--primary);
    }
    .quest-level .step-check {
      margin-top: 15px;
      display: flex;
      align-items: center;
    }
    .quest-level input {
      width: 220px;
    }
    .step-feedback {
      font-size: 1.2rem;
      font-weight: 500;
      margin-left: 12px;
    }
    .step-feedback.correct { color: var(--success); }
    .step-feedback.incorrect { color: #ef4444; }

    /* --- Game 3: Differential Gauges --- */
    .gauge-inputs {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 16px;
      align-items: center;
    }
    .gauge-inputs label {
      font-weight: 600;
      text-align: right;
      color: var(--text);
    }
    .gauge-display {
      display: flex;
      gap: 30px;
      justify-content: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--gray);
    }
    .gauge-container {
      text-align: center;
    }
    .gauge {
      width: 200px;
      height: 100px;
      background: var(--gray-light);
      border: 1px solid var(--gray);
      border-radius: 100px 100px 0 0;
      position: relative;
      overflow: hidden;
    }
    .gauge-fill {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      transform-origin: bottom center;
      transition: transform 0.6s ease-out;
    }
    #dyGauge .gauge-fill {
      background: linear-gradient(90deg, var(--primary-light), var(--primary));
      transform: rotate(-90deg); /* Start at 0 */
    }
    #deltaGauge .gauge-fill {
      background: linear-gradient(90deg, var(--success), #059669);
      transform: rotate(-90deg); /* Start at 0 */
    }
    .gauge-label {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text);
    }
    .gauge-value {
      font-size: 1.3em;
      font-weight: 700;
      font-family: monospace;
      margin-top: 8px;
    }
    
    /* --- END: STYLES FROM ORIGINAL FILE --- */
    
    
    /* --- START: NEW INTEGRAL GAME STYLES --- */
    
    /* Game 1: Potion Matcher */
    #potion-choices {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 25px;
    }
    .potion-btn {
      background: var(--white);
      border: 2px solid var(--gray);
      border-radius: 12px;
      padding: 15px;
      width: 200px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1em;
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
      color: var(--text);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }
    .potion-btn:hover {
      border-color: var(--primary-light);
      box-shadow: 0 6px 15px rgba(0,0,0,0.07);
      transform: translateY(-3px);
    }
    .potion-btn.correct {
      border-color: var(--success);
      background: #f0fdf4;
      transform: scale(1.05);
    }
    .potion-btn.wrong {
      border-color: #fca5a5;
      background: #fef2f2;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* Game 2: U-Sub Quest */
    .usub-step {
      background: var(--gray-light);
      border: 1px solid var(--gray);
      border-radius: 8px;
      padding: 20px;
      margin-top: 15px;
    }
    .usub-step label {
      font-weight: 600;
      color: var(--text);
      display: block;
      margin-bottom: 10px;
    }
    .usub-step .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .usub-step input {
      flex-grow: 1;
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.1em;
    }
    .usub-step .math-label {
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.2em;
      color: var(--text-light);
    }

    /* --- START: Solution Box Style --- */
    .solution-box {
      background: var(--gray-light);
      border: 1px solid var(--gray);
      border-left: 4px solid var(--secondary);
      border-radius: 8px;
      padding: 16px;
      margin-top: 15px;
      display: none; /* Hidden by default */
    }
    .solution-box h4 {
      color: var(--primary-dark);
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 12px;
    }
    .solution-box p {
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.6;
    }
    .solution-box p code {
      font-family: 'Courier New', Courier, monospace;
      background: var(--white);
      border: 1px solid var(--gray);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 0.95em;
    }
    /* --- END: Solution Box Style --- */
    
    /* --- END: NEW INTEGRAL GAME STYLES --- */
    

    /* ===== Responsive Styles ===== */
    @media (max-width: 992px) {
      .nav-links {
        gap: 20px;
      }
      
      .footer-content {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .footer-about {
        grid-column: span 2;
      }

      .diff-drift-grid {
        grid-template-columns: 1fr;
      }
      
      /* Responsive grids for new games */
      #diff-game-card .diff-grid, #starry-game .diff-grid {
        grid-template-columns: 1fr;
      }
      .gauge-inputs {
        grid-template-columns: 1fr;
      }
      .gauge-inputs label {
        text-align: left;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 15px 0;
      }
      
      .nav-links {
        display: none;
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      .hero h1 {
        font-size: 2.2rem;
      }
      
      .hero-buttons {
        flex-direction: column;
        gap: 15px;
      }
      
      .footer-content {
        grid-template-columns: 1fr;
      }
      
      .footer-about {
        grid-column: span 1;
      }
      
      /* Responsive for new games */
      .potion-btn {
        width: 100%;
      }
      .usub-step .input-group {
        flex-direction: column;
        align-items: flex-start;
      }
      .usub-step input {
        width: 100%;
      }
    }

    @media (max-width: 576px) {
      .section-title h2 {
        font-size: 1.8rem;
      }
      
      .hero {
        padding: 140px 0 60px;
      }
      
      .hero h1 {
        font-size: 1.8rem;
      }
      
      .hero p {
        font-size: 1rem;
      }

      .diff-drift-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .diff-drift-xfinal {
        width: 100%;
      }
      
      /* Responsive for new games */
      .step-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .quest-level .step-check {
        flex-direction: column;
        align-items: flex-start;
      }
      .quest-level input {
        width: 100%;
        margin-top: 5px;
      }
      .step-feedback {
        margin-left: 0;
        margin-top: 5px;
      }
      .gauge-display {
        flex-direction: column;
        align-items: center;
      }
    }
    
  </style>
</head>
<body>
  <header id="header">
    <div class="container">
      <nav class="navbar">
        <a href="#" class="logo">
          <div class="logo-icon">S</div>
          <span class="logo-text">Sentellect</span>
        </a>
        
        <ul class="nav-links">
          <li><a href="#" class="active">Home</a></li>
          <li><a href="#basics">Basics</a></li>
          <li><a href="#game">Game</a></li>
      
        </ul>
        
      
        
        <button class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </button>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
    
    <div class="container">
      <div class="hero-content">
        <h1 class="animate">Integration</h1>
        <p class="animate delay-1">Explore differentials and integrals with gentle, interactive games. No pressure, just small steps.</p>
        <div class="hero-buttons">
          <a href="#game" class="btn btn-primary animate delay-2">Play Games</a>
          <a href="#basics" class="btn btn-secondary animate delay-3">Learn Basics</a>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <section id="basics" class="section">
      <div class="card animate">
        <h2>Understanding the Concepts</h2>
        
        <h3>Î”y and dy (Differentials)</h3>
        <p>This concept helps us approximate change. <strong>Î”y</strong> is the *exact* change in a function, while <strong>dy</strong> is the *estimated* change using the tangent line. For small changes, they are very close!</p>

        <h3>âˆ« Indefinite Integrals (Antiderivatives)</h3>
        <p>This is the reverse of differentiation. You're finding the original function when you're given its derivative. The "Power Rule" for integration is a key tool:</p>
        <p class="math-formula">âˆ« x<sup>n</sup> dx = (x<sup>n+1</sup> / (n+1)) + C</p>
        <p>Don't forget the <strong>"+ C"</strong> (the constant of integration)!</p>

        <h3><em>u</em>-Substitution</h3>
        <p>This is a technique for more complex integrals. You simplify the problem by finding an "inside function" (which you call <strong><em>u</em></strong>) and its derivative (<strong><em>du</em></strong>).</p>
        
        <div class="self-care animate delay-1">
          <h4>ðŸ’– You Can Do This! ðŸ’–</h4>
          <p>Calculus can be challenging, but breaking it down step by step makes it manageable. Take your time! ðŸŒŸ</p>
        </div>
      </div>
    </section>

    <section id="game" class="section">
      <div class="card animate delay-1">
        <h2>Calm Practice Zone</h2>
        <p>Explore calculus concepts in a calm, interactive environment. No pressure, just gentle learning.</p>
        
        <div class="diff-drift-game">
          <div class="diff-drift-header">
            <div style="font-size:1.6rem">ðŸŒ¿</div>
            <div>
              <h1>Differential Drift â€” Calm Math Game</h1>
              <p class="diff-drift-small">Small steps. Gentle motion. No rush â€” learn how Î”y and dy compare.</p>
            </div>
          </div>
          <div class="diff-drift-grid">
            <div class="diff-drift-card">
              <div class="diff-drift-big">Play gently â€” choose a simple level</div>

              <div class="diff-drift-levels" id="levels">
                <button class="diff-drift-levelBtn selected" id="lvl1"><span>(i) y = xÂ² âˆ’ 1</span><small class="diff-drift-small">3 â†’ 3.02</small></button>
                <button class="diff-drift-levelBtn" id="lvl2"><span>(ii) y = xÂ² + 2x</span><small class="diff-drift-small">2 â†’ 1.8</small></button>
                <button class="diff-drift-levelBtn" id="lvl3"><span>(iii) y = âˆšx</span><small class="diff-drift-small">4 â†’ 4.41</small></button>
              </div>

              <div class="diff-drift-controls">
                <label class="diff-drift-small" style="min-width:80px">Final x</label>
                <input class="diff-drift-xfinal" id="xFinal" type="number" step="0.001" />
                <button class="diff-drift-btnGhost" id="snap">Snap</button>
                <button class="diff-drift-btnSoft" id="showSteps">Show Calm Steps</button>
              </div>

              <div class="diff-drift-result" id="result">
                </div>

              <div class="diff-drift-blobArea" style="margin-top:12px">
                <svg class="diff-drift-curve" viewBox="0 0 600 320" preserveAspectRatio="none" id="curveSvg">
                  <defs>
                    <linearGradient id="g1" x1="0" x2="1">
                      <stop offset="0" stop-color="#e6f9ff" />
                      <stop offset="1" stop-color="#f7eefc" />
                    </linearGradient>
                  </defs>
                  <rect x="0" y="0" width="600" height="320" fill="url(#g1)"></rect>
                  <path id="curvePath" d="" fill="none" stroke="#bfe9ff" stroke-width="3" stroke-linecap="round"></path>
                  <g id="ticks"></g>
                </svg>

                <div class="diff-drift-blob" id="blob">Î”</div>
                <div class="diff-drift-bubble" id="bubble" style="left:270px;display:none">Hi â€” let's try!</div>
              </div>

              <div class="diff-drift-steps" id="stepsPanel" style="display:none">
                </div>

              <div class="diff-drift-calmMsg" id="calmMsg">Tip: Smaller changes in x usually make dy (the estimate) closer to Î”y (the true change).</div>
            </div>

            <div class="diff-drift-card">
              <div class="diff-drift-small">Explanation</div>
              <div style="margin-top:8px">
                <strong>Î”y = f(x + Î”x) âˆ’ f(x)</strong>
                <div class="diff-drift-small" style="margin-top:6px">This is the true change in y when x moves.</div>
              </div>

              <div style="margin-top:12px">
                <strong>dy = f'(x) Â· Î”x</strong>
                <div class="diff-drift-small" style="margin-top:6px">This is the linear estimate using the derivative at the original x.</div>
              </div>

              <div class="diff-drift-meter" aria-hidden="true">
                <div class="diff-drift-meterFill" id="meterFill"></div>
              </div>
              <div class="diff-drift-small" id="meterText" style="margin-top:8px">Approximation meter</div>

              <div class="diff-drift-footerTip" style="margin-top:14px">
                <button class="diff-drift-btnSoft" id="playHint">Play gentle tone</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card animate delay-1" id="starry-game" aria-live="polite">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3>Starry Garden â€” Calm Steps</h3>
              <p class="hint" style="margin:0">Short steps, soft animation. No rush.</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="quiet" id="sg-relax">Relax: on</button>
              <button class="quiet" id="sg-reset">Reset</button>
            </div>
          </div>

          <div style="margin-top:12px" id="sg-controls">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="step-btn btn-secondary" data-patch="p1">(i) xy + x = 4</button>
              <button class="step-btn btn-secondary" data-patch="p2">(ii) xÂ² + 2yÂ² = 16</button>
              <button class="step-btn btn-secondary" data-patch="p3">(iii) xâ´ + yÂ² = x yÂ²</button>
              <button class="step-btn btn-secondary" data-patch="p4">(iv) xy âˆ’ ln x = c</button>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start">
            <div>
              <div id="sg-garden" style="border-radius:10px;overflow:hidden;background:var(--gray-light);height:260px;position:relative">
                <svg viewBox="0 0 700 320" preserveAspectRatio="none" style="width:100%;height:100%">
                  <rect width="100%" height="100%" fill="transparent"/>
                  <path id="sg-curve" d="" fill="none" stroke="rgba(30,64,175,0.12)" stroke-width="3" stroke-linecap="round"></path>
                </svg>

                <div id="sg-firefly" style="position:absolute;left:110px;top:130px;transform:translate(-50%,-50%);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(180deg,var(--primary),var(--primary-light));color:var(--white);box-shadow:0 8px 20px rgba(30,64,175,0.16);">âœ¦</div>
                <div id="sg-bubble" style="position:absolute;display:none;padding:8px 10px;border-radius:999px;background:var(--white);color:var(--text);font-weight:700;transform:translate(-50%,-150%);"></div>
              </div>

              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="step-btn btn-primary" id="sg-show">Show step</button>
                <button class="quiet" id="sg-glide">Glide</button>
                <button class="quiet" id="sg-hint">Hint</button>
              </div>

              <div id="sg-steps" class="steps" style="margin-top:10px;min-height:64px"></div>
            </div>

            <div>
              <div class="formula-box" style="margin-bottom:12px">dy/dx (fill & check)</div>

              <div style="display:flex;gap:8px;align-items:center">
                <input id="sg-ans" class="answer" placeholder="e.g. -(y+1)/x" style="flex:1" />
                <button class="step-btn btn-primary" id="sg-check">Check</button>
              </div>

              <div id="sg-feedback" class="hint" style="margin-top:10px">Use the short steps above, then answer.</div>

              <div class="progress-container" style="margin-top:14px">
                <div class="progress-bar" id="sg-progress" style="width:0%"></div>
              </div>

              <div style="margin-top:12px">
                <button class="btn-secondary" id="sg-chime">Play chime</button>
              </div>
            </div>
          </div>
        </div>

        
        <div class="card animate delay-1" id="approx-builder">
          <h2>ðŸ§© Approximation Builder</h2>
          <p class="small">Let's approximate <strong>âˆš17</strong>. Drag the correct tiles to build the approximation "recipe." No rush.</p>

          <div class="recipe-steps">
            <div class="step-row">
              <span class="step-label">1. Function: <strong>f(x) =</strong></span>
              <div class="dropzone" data-slot="fx" data-answer="sqrt(x)"></div>
            </div>
            <div class="step-row">
              <span class="step-label">2. "Nice" Point: <strong>a =</strong></span>
              <div class="dropzone" data-slot="a" data-answer="16"></div>
            </div>
            <div class="step-row">
              <span class="step-label">3. Change in x: <strong>dx =</strong></span>
              <div class="dropzone" data-slot="dx" data-answer="1"></div>
            </div>
            <div class="step-row">
              <span class="step-label">4. Base Value: <strong>f(a) =</strong></span>
              <div class="dropzone" data-slot="fa" data-answer="4"></div>
            </div>
            <div class="step-row">
              <span class="step-label">5. Derivative: <strong>f'(x) =</strong></span>
              <div class="dropzone" data-slot="f_prime_x" data-answer="1/(2sqrt(x))"></div>
            </div>
            <div class="step-row">
              <span class="step-label">6. Slope at 'a': <strong>f'(a) =</strong></span>
              <div class="dropzone" data-slot="f_prime_a" data-answer="1/8"></div>
            </div>
          </div>

          <div class="tile-bank" id="builderTiles">
            <div class="tile" draggable="true" data-value="16">16</div>
            <div class="tile" draggable="true" data-value="sqrt(x)">âˆšx</div>
            <div class="tile" draggable="true" data-value="1">1</div>
            <div class="tile" draggable="true" data-value="4">4</div>
            <div class="tile" draggable="true" data-value="1/8">1/8</div>
            <div class="tile" draggable="true" data-value="17">17</div>
            <div class="tile" draggable="true" data-value="x^2">xÂ²</div>
            <div class="tile" draggable="true" data-value="1/(2sqrt(x))">1/(2âˆšx)</div>
            <div class="tile" draggable="true" data-value="2x">2x</div>
          </div>

          <button class="calm-btn" onclick="checkBuilder()" style="margin-top: 20px;">Check My Recipe</button>
          <div class="result" id="builderResult"></div>
        </div>
        
        <div class="card animate delay-2">
          <h2>ðŸ§  Implicit Chain Quest</h2>
          <p class="small">Let's find <strong>dy/dx</strong> for <strong>xy + x = 4</strong>. We'll differentiate each part one by one.</p>

          <div class="quest-level" id="implicit-quest">
            <div class="steps">
              <strong>Gentle Hints:</strong><br>
              1ï¸âƒ£ Differentiate `xy` (use the product rule!)<br>
              2ï¸âƒ£ Differentiate `x`<br>
              3ï¸âƒ£ Differentiate `4`<br>
              4ï¸âƒ£ Put it all together and solve for `dy/dx`.
            </div>
            
            <div class="step-check">
              d/dx(xy) = <input id="imp1" placeholder="e.g. y + x*y'">
              <span id="fb1" class="step-feedback"></span>
            </div>
            <div class="step-check">
              d/dx(x) = <input id="imp2" placeholder="e.g. 1">
              <span id="fb2" class="step-feedback"></span>
            </div>
            <div class="step-check">
              d/dx(4) = <input id="imp3" placeholder="e.g. 0">
              <span id="fb3" class="step-feedback"></span>
            </div>
            <hr style="border:0; border-top: 1px solid var(--gray); margin: 20px 0;">
            <div class="step-check">
              Final Answer: dy/dx = <input id="impFinal" placeholder="Solve for dy/dx">
            </div>
            
            <button class="calm-btn" onclick="checkImplicit()" style="margin-top: 20px;">Check Final Answer</button>
            <div class="result" id="implicitResult"></div>
          </div>
        </div>

        <div class="card animate delay-3">
          <h2>ðŸ“Š Differential Gauges</h2>
          <p class="small">Compare the <strong>Actual Change (Î´y)</strong> with the <strong>Approximate Change (dy)</strong>.
            <br><strong>Problem:</strong> $y = x^2 - 1$, when $x$ changes from <strong>3</strong> to <strong>3.02</strong>.
          </p>

          <div class="gauge-inputs">
            <label for="g_f_prime">1. Find $f'(x)$:</label>
            <input id="g_f_prime" placeholder="Derivative of xÂ² - 1">
            
            <label for="g_dx">2. Find $dx$ (the change in $x$):</label>
            <input id="g_dx" placeholder="e.g. 3.02 - 3">
            
            <label for="g_dy">3. Find $dy = f'(a) \cdot dx$:</label>
            <input id="g_dy" placeholder="Plug in x=3 and dx">
          </div>

          <button class="calm-btn" onclick="checkGauges()" style="margin-top: 20px;">Compare Changes</button>

          <div class="gauge-display" id="gaugeDisplay" style="display:none;">
            <div class="gauge-container">
              <div class="gauge-label">Approximate $dy$</div>
              <div class="gauge" id="dyGauge">
                <div class="gauge-fill" id="dyFill"></div>
              </div>
              <div class="gauge-value" id="dyValue">0.00</div>
            </div>
            <div class="gauge-container">
              <div class="gauge-label">Actual $Î´y$</div>
              <div class="gauge" id="deltaGauge">
                <div class="gauge-fill" id="deltaFill"></div>
              </div>
              <div class="gauge-value" id="deltaValue">0.00</div>
            </div>
          </div>
          
          <div class="result" id="gaugeResult"></div>
        </div>

        <div class="card animate delay-1" id="diff-game-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 style="margin:0">Diff Dash â€” gentle guess game</h3>
              <div class="hint" style="margin-top:6px">Use differentials to estimate â€” slide to guess, score by closeness.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="quiet" id="dg-reset">Reset</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="step-btn" data-q="q1"> (i) â´âˆš17</button>
              <button class="step-btn" data-q="q2"> (ii) âµâˆš31</button>
              <button class="step-btn" data-q="q3"> (iii) cos 29Â°</button>
              <button class="step-btn" data-q="q4"> (iv) sin 61Â°</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px;align-items:start">
            <div>
              <div class="formula-box" id="dg-formula" style="margin-bottom:8px">Pick a problem â†’ press Compute</div>

              <div class="steps" id="dg-steps" style="min-height:64px"></div>

              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="step-btn btn-primary" id="dg-compute">Compute</button>
                <button class="quiet" id="dg-show">Show actual</button>
                <button class="quiet" id="dg-hint">Hint</button>
              </div>

              <div id="dg-result" class="solution" style="margin-top:12px;display:none">
                <div style="display:flex;justify-content:space-between">
                  <div><strong>Linear approx</strong></div>
                  <div id="dg-approx" class="math"></div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:8px">
                  <div class="small">Actual</div>
                  <div id="dg-actual" class="small"></div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:8px">
                  <div class="small">Error</div>
                  <div id="dg-error" class="small"></div>
                </div>
              </div>
            </div>

            <div>
              <div class="formula-box" style="margin-bottom:8px">Slide to guess</div>

              <div style="display:flex;gap:8px;align-items:center">
                <input id="dg-guess" type="range" min="-10" max="10" step="0.0001" value="0" style="width:100%;"/>
              </div>

              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <input id="dg-guess-val" class="answer" placeholder="your guess" style="flex:1" />
                <button class="step-btn btn-primary" id="dg-submit">Submit</button>
              </div>

              <div id="dg-feedback" class="hint" style="margin-top:10px">Submit your guess to score.</div>

              <div style="margin-top:12px">
                <div class="small">Round score</div>
                <div class="progress-container" style="margin-top:8px">
                  <div class="progress-bar" id="dg-progress" style="width:0%"></div>
                </div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
                  <div>
                    <div class="small">Total points</div>
                    <div id="dg-score" style="font-weight:700;font-size:1.3rem">0</div>
                  </div>
                  <div>
                    <button class="btn-secondary quiet" id="dg-next">Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card animate delay-1" id="integral-potion-game">
          <h2>ðŸ§ª Integral Potion Match</h2>
          <p class="small">Practice the Power Rule! Find the correct "antiderivative" potion for each ingredient.</p>
          
          <div class="math-formula" id="potion-problem">
            âˆ« 3xÂ² dx
          </div>
          
          <div id="potion-choices">
            </div>

          <div style="margin-top: 15px;">
            <button class="calm-btn calm-btn-small ghost" id="potion-show-steps">Show Calm Steps</button>
            <button class="calm-btn" id="next-potion-btn" style="display: none; margin-left: 10px;">Next Ingredient</button>
          </div>
          <div class="result" id="potion-result"></div>
          
          <div class="solution-box" id="potion-solution">
            <h4>Calm Steps</h4>
            <p><strong>Problem:</strong> <code id="potion-sol-q"></code></p>
            <p>1. <strong>Identify 'n':</strong> The exponent on <code>x</code> is <code id="potion-sol-n"></code>.</p>
            <p>2. <strong>Add 1 to n:</strong> <code>n + 1</code> = <code id="potion-sol-n1"></code>.</p>
            <p>3. <strong>Divide by (n+1):</strong> We divide the coefficient by this new exponent.</p>
            <p>4. <strong>Result:</strong> <code id="potion-sol-a"></code>. Don't forget <code>+ C</code>!</p>
          </div>
          </div>
        
        <div class="card animate delay-2" id="usub-quest-game">
          <h2>ðŸ§© U-Substitution Quest</h2>
          <p class="small">Let's solve a tricky integral one small step at a time. No rush!</p>
          
          <div class="math-formula" id="usub-problem">
            âˆ« (xÂ² + 1)Â³ Â· 2x dx
          </div>
          
          <div class="usub-step" id="usub-step1">
            <label for="usub-u-input">Step 1: What is the "inside" function, <strong>u</strong>?</label>
            <div class="input-group">
              <span class="math-label">u =</span>
              <input type="text" id="usub-u-input" placeholder="e.g. xÂ² + 1">
              <button class="calm-btn calm-btn-small" id="usub-check-u">Check u</button>
            </div>
            <div class="result" id="usub-u-result"></div>
          </div>
          
          <div class="usub-step" id="usub-step2" style="display: none;">
            <label for="usub-du-input">Step 2: Great! Now find the derivative of <strong>u</strong>.</label>
            <div class="input-group">
              <span class="math-label">du =</span>
              <input type="text" id="usub-du-input" placeholder="e.g. 2x">
              <span class="math-label">dx</span>
              <button class="calm-btn calm-btn-small" id="usub-check-du">Check du</button>
            </div>
            <div class="result" id="usub-du-result"></div>
          </div>
          
          <div class="usub-step" id="usub-step3" style="display: none;">
            <label for="usub-integral-input">Step 3: Perfect! The integral is now âˆ« uÂ³ du. What's the antiderivative?</label>
            <div class="input-group">
              <input type="text" id="usub-integral-input" placeholder="e.g. uâ´ / 4">
              <span class="math-label">+ C</span>
              <button class="calm-btn calm-btn-small" id="usub-check-integral">Check Integral</button>
            </div>
            <div class="result" id="usub-integral-result"></div>
          </div>
          
          <div class="usub-step" id="usub-step4" style="display: none;">
            <label for="usub-final-input">Step 4: Last step! Substitute <strong>u</strong> back into your answer.</label>
            <div class="input-group">
              <input type="text" id="usub-final-input" placeholder="e.g. (xÂ² + 1)â´ / 4">
              <span class="math-label">+ C</span>
              <button class="calm-btn calm-btn-small" id="usub-check-final">Check Final Answer</button>
            </div>
            <div class="result" id="usub-final-result"></div>
          </div>

          <div style="margin-top: 15px;">
            <button class="calm-btn calm-btn-small ghost" id="usub-show-steps">Show Calm Steps</button>
            <button class="calm-btn" id="next-usub-btn" style="display: none; margin-left: 10px;">Try Another One</button>
          </div>
          
          <div class="solution-box" id="usub-solution">
            <h4>Calm Steps</h4>
            <p><strong>Problem:</strong> <code id="usub-sol-q"></code></p>
            <p>1. <strong>Find u:</strong> The "inside" part is <code>u = <span id="usub-sol-u"></span></code>.</p>
            <p>2. <strong>Find du:</strong> The derivative is <code>du = <span id="usub-sol-du"></span> dx</code>. This matches the "outside" part!</p>
            <p>3. <strong>Substitute:</strong> The integral becomes <code><span id="usub-sol-intq"></span></code>.</p>
            <p>4. <strong>Integrate:</strong> Using the power rule, this is <code><span id="usub-sol-inta"></span> + C</code>.</p>
            <p>5. <strong>Substitute Back:</strong> Replace <code>u</code> to get the final answer: <code><span id="usub-sol-final"></span> + C</code>.</p>
          </div>
          </div>
        <div class="card animate delay-3" id="wizard-scroll-game">
          <h2>ðŸ“œ Wizard's Scroll (Guided Walkthrough)</h2>
          <p class="small">Let's solve a complex integral by transforming it one step at a time. Follow the wizard's hints!</p>
          
          <div class="math-formula wz-transform-in" id="wz-problem-display" style="font-size: 1.8em; min-height: 70px;">
            </div>

          <div class="wz-guide-message" id="wz-guide-message">
            </div>

          <div class="wz-spellbook">
            <button class="calm-btn" id="wz-spell-algebra">âœ¨ Algebra Wand</button>
            <button class="calm-btn" id="wz-spell-split">âœ‚ï¸ Split Fraction</button>
            <button class="calm-btn" id="wz-spell-usub">ðŸ’§ U-Sub Potion</button>
            <button class="calm-btn" id="wz-spell-arcsin">ðŸ›¡ï¸ Arcsin Shield</button>
          </div>
          
          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="calm-btn calm-btn-small ghost" id="wz-show-steps-btn">Show Calm Steps</button>
            <button class="calm-btn" id="wz-restart-btn" style="display: none;">Try Another Spell</button>
          </div>
          
          <div class="solution-box" id="wz-solution-box">
            <h4>Calm Steps Summary</h4>
            </div>
        </div>
        <!-- 
  HTML SNIPPET FOR CALCULUS QUEST
  Paste this inside your <section id="game" class="section"> tag, 
  right after the closing </div> of the "Wizard's Scroll" game.
-->

<!-- New Game: Calculus Quest -->
<div class="card animate delay-3" id="calculus-quest-game">
  <h2>ðŸ—ºï¸ Calculus Quest: The Integral Isles</h2>
  <p class="small">Welcome, adventurer! Your quest is to solve the ancient integral puzzles from the islands below. Click any puzzle to see its step-by-step solution. Good luck!</p>

  <!-- Island 1: Parts Peninsula -->
  <h3 class="cq-island-title">Island 1: The Parts Peninsula (Integration by Parts)</h3>
  <p class.small>Use the LIATE rule: <code>$$u$$</code> is the first type on the list, <code>$$dv$$</code> is the rest. <code>$$\int u \, dv = uv - \int v \, du$$</code></p>
  <div class="cq-problem-grid">
    <!-- Row 1 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_1">I. (i) $$x \sin x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_2">I. (ii) $$x^2 \ln x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_3">I. (iii) $$x \ln x$$</button>
    <!-- Row 2 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_4">I. (iv) $$\ln x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_5">I. (v) $$x^3 \ln x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_6">I. (vi) $$x^4 \ln x$$</button>
    <!-- Row 3 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_7">I. (vii) $$\tan^{-1} x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_8">I. (viii) $$x^2 \sin x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_9">I. (ix) $$x^2 \tan^{-1} x$$</button>
    <!-- Row 4 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_10">I. (x) $$x \tan^{-1} x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_11">I. (xi) $$x^3 \tan^{-1} x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_12">I. (xii) $$x^3 \cos x$$</button>
    <!-- Row 5 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_13">I. (xiii) $$\sin^{-1} x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_14">I. (xiv) $$x \sin^{-1} x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_15">I. (xv) $$e^x \sin x \cos x$$</button>
    <!-- Row 6 -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_17">I. (xvii) $$x \cos^2 x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_18">I. (xviii) $$x \sin^2 x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_19">I. (xix) $$(\ln x)^2$$</button>
    <!-- Special Problems -->
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_20">I. (xx) $$\ln(\tan x) \sec^2 x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p1_21">I. (xxi) $$\frac{x \sin^{-1} x}{\sqrt{1-x^2}}$$</button>
  </div>

  <!-- Island 2: Trig-Topia -->
  <h3 class="cq-island-title">Island 2: Trig-Topia (Trig Identities)</h3>
  <p class.small>Use identities like <code>$$\sec^2 x = 1 + \tan^2 x$$</code> or <code>$$\sin(2x) = 2\sin x \cos x$$</code> to simplify.</p>
  <div class="cq-problem-grid">
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_1">II. (i) $$\tan^4 x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_2">II. (ii) $$\sec^4 x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_3">II. (iii) $$e^x \sin 2x \cos x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_4">II. (iv) $$\tan^3 x \sec x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_5">II. (v) $$x^3 e^{5x}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_7">II. (vii) $$e^{2x} \cos 3x$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p2_8">II. (viii) $$\csc^3 x$$</button>
  </div>

  <!-- Island 3: Boss Lair -->
  <h3 class="cq-island-title">Island 3: Boss Lair (The Looping Dragon)</h3>
  <div class="cq-problem-grid">
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p3_1">Show: $$e^{ax} \sin(bx)$$</button>
  </div>
  
  <!-- Island 4: Substitution Straits -->
  <h3 class="cq-island-title">Island 4: The Substitution Straits (Trig Sub)</h3>
  <p class.small>Use <code>$$x = a \sin \theta$$</code> for <code>$$a^2-x^2$$</code>, <code>$$x = a \tan \theta$$</code> for <code>$$a^2+x^2$$</code>, or <code>$$x = a \sec \theta$$</code> for <code>$$x^2-a^2$$</code>.</p>
  <div class="cq-problem-grid">
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_1">IV. (i) $$\sqrt{a^2 - x^2}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_2">IV. (ii) $$\sqrt{x^2 - a^2}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_3">IV. (iii) $$\sqrt{4 - 5x^2}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_4">IV. (iv) $$\sqrt{3 - 4x^2}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_5">IV. (v) $$\sqrt{x^2 + 4}$$</button>
    <button class="calm-btn calm-btn-small ghost cq-problem-btn" data-id="p4_6">IV. (vi) $$x^2 e^{ax}$$</button>
  </div>
</div>

<!-- 
  MODAL HTML
  Paste this snippet just before your closing </body> tag, (after all your other content).
-->
<div id="quest-modal" class="cq-modal" style="display: none;">
  <div class="cq-modal-content">
    <button id="cq-modal-close" class="cq-modal-close-btn">&times;</button>
    <h2 id="cq-modal-title">Problem Solution</h2>
    <div class="math-formula" id="cq-modal-problem" style="font-size: 1.2em;">
      <!-- Problem will be injected here -->
    </div>
    <div id="cq-modal-solution" class="solution-box" style="display: block; text-align: left;">
      <!-- Solution steps will be injected here -->
    </div>
  </div>
</div>
<div class="card" id="architect-game">
    <h2>ðŸ—ï¸ The Fraction Architect</h2>
    
    <div class="problem-display" id="problem-display">
        $$ \int \frac{3x + 1}{x^2 - x - 6} dx $$
    </div>

    <div class="guide-message" id="guide-message">
        Hello, Architect! Let's <strong>factor the denominator</strong> first. (I've done it for you below!)
    </div>

    <div id="game-area">
        
        <div id="build-phase">
            <div class="blueprint-area">
                <div class="dropzone" data-correct-answer="A/(x-3)">...</div>
                <div style="font-size: 2em; color: var(--text-light);">+</div>
                <div class="dropzone" data-correct-answer="B/(x+2)">...</div>
            </div>
            
            <div class="toolbox">
                <div class="brick" draggable="true" data-value="A/(x-3)">$$ \frac{A}{x-3} $$</div>
                <div class="brick" draggable="true" data-value="B/(x-3)^2">$$ \frac{B}{(x-3)^2} $$</div>
                <div class="brick" draggable="true" data-value="B/(x+2)">$$ \frac{B}{x+2} $$</div>
                <div class="brick" draggable="true" data-value="Ax+B">$$ Ax+B $$</div>
            </div>
        </div>

        <div id="solve-phase" style="display: none;">
            <div class="solve-box" id="solve-a-box">
                <p>Let's find <strong>A</strong>. We cover <code>(x-3)</code> and plug in <code>x=3</code>.</p>
                <div style="font-size: 1.5em; position: relative; padding: 20px 0;">
                    $$ \frac{3x + 1}{\color{red}{(x - 3)}}(x + 2)} $$
                </div>
                <button class="calm-btn" id="solve-a-btn">Find A</button>
            </div>
            
            <div class="solve-box" id="solve-b-box" style="display: none;">
                <p>Now find <strong>B</strong>. We cover <code>(x+2)</code> and plug in <code>x=-2</code>.</p>
                <div style="font-size: 1.5em; position: relative; padding: 20px 0;">
                    $$ \frac{3x + 1}{(x - 3)}\color{blue}{(x + 2)} $$
                </div>
                <button class="calm-btn" id="solve-b-btn">Find B</button>
            </div>
        </div>

    </div>
    
    <div style="margin-top: 20px;">
      <button class="calm-btn" id="restart-btn">Start Over</button>
    </div>
    
</div>

<div class="card" id="coaster-game">
    <h2>ðŸŽ¢ The Antiderivative Coaster</h2>
    
    <div class="problem-display" id="problem-display">
        $$ \int_{0}^{2} (x^2 + 1) dx $$
    </div>

    <div class="guide-message" id="guide-message">
        Let's ride! First, the "track" (antiderivative) is built for us.
    </div>

    <div id="game-area">
        
        <div id="coaster-canvas-container">
            <canvas id="coaster-chart"></canvas>
            <div id="coaster-car">ðŸŽ¢</div>
        </div>

        <div class="controls">
            <button class="calm-btn" id="find-b-btn">1. Find Height at x=2</button>
            <button class="calm-btn" id="find-a-btn" disabled>2. Find Height at x=0</button>
        </div>
        
        <div id="calculation-box">
            </div>
        
        <button class="calm-btn" id="restart-btn">Ride Again!</button>

    </div>
</div>
<div class="card" id="area-surveyor-game">
    <h2>ðŸ—ºï¸ The Area Surveyor</h2>
    
    <div class="problem-display" id="as-problem-display">
        Find the area between the x-axis and the curve $$y = 4x - x^2$$
    </div>

    <div class="guide-message" id="as-guide-message">
        Let's find our 'survey plot' bounds, $a$ and $b$. We must find the x-intercepts by setting $y=0$.
    </div>

    <div id="as-game-area">
        
        <div id="as-phase-1-bounds">
            <div class="bound-step" id="as-bound-1">$$ 4x - x^2 = 0 $$</div>
            <div class="bound-step" id="as-bound-2">$$ x(4 - x) = 0 $$</div>
            <div class="bound-step" id="as-bound-3">$$ x = 0 \text{ or } x = 4 $$</div>
            <div class="bound-step" id="as-bound-4">$$ (a=0, b=4) $$</div>
        </div>

        <div id="as-phase-2-build">
            <div class="blueprint-area">
                $$ \int $$
                <div class="dropzone" id="as-drop-b" data-correct-answer="4">b?</div>
                <div class="dropzone" id="as-drop-a" data-correct-answer="0">a?</div>
                (
                <div class="dropzone func" id="as-drop-f" data-correct-answer="4x - x^2">f(x)?</div>
                ) $$ dx $$
            </div>
            
            <div class="toolbox">
                <div class="brick" draggable="true" data-value="4x - x^2">$$ 4x - x^2 $$</div>
                <div class="brick" draggable="true" data-value="0">$$ 0 $$</div>
                <div class="brick" draggable="true" data-value="4">$$ 4 $$</div>
                <div class="brick" draggable="true" data-value="x^2">$$ x^2 $$</div>
            </div>
        </div>

        <div id="as-phase-3-solve">
            <div class="solve-step" id="as-solve-1">
                <strong>Antiderivative:</strong> $$ \int (4x - x^2) dx $$
            </div>
            <div class="solve-step" id="as-solve-2">
                $$ = 4 \left( \frac{x^2}{2} \right) - \left( \frac{x^3}{3} \right) $$
            </div>
            <div class="solve-step" id="as-solve-3">
                <strong>Track:</strong> $$ F(x) = 2x^2 - \frac{x^3}{3} $$
            </div>
            <div class="solve-step" id="as-solve-4">
                <strong>Height at $b=4$:</strong> $$ F(4) = 2(4)^2 - \frac{(4)^3}{3} = 32 - \frac{64}{3} = \frac{32}{3} $$
            </div>
            <div class="solve-step" id="as-solve-5">
                <strong>Height at $a=0$:</strong> $$ F(0) = 2(0)^2 - \frac{(0)^3}{3} = 0 $$
            </div>
            <div class="solve-step" id="as-solve-6">
                <strong>Total Area = $F(b) - F(a)$</strong><br>
                $$ \frac{32}{3} - 0 = \span class="final-answer"> \frac{32}{3} </span> $$
            </div>
            <div id="as-coaster-canvas-container">
                <canvas id="as-coaster-chart"></canvas>
            </div>
        </div>

    </div>
    
    <button class="calm-btn" id="as-restart-btn">Survey Another Plot!</button>
    
</div>
<div class="card" id="variable-sorter-game">
    <h2>âš›ï¸ The Variable Sorter</h2>
    
    <div class="problem-display" id="vs-problem-display">
        </div>

    <div class="guide-message" id="vs-guide-message">
        </div>

    <div id="vs-game-area">
        
        <div id="vs-sort-phase">
            <div class="sort-zone y-zone">
                <h3>Y-Zone</h3>
                <div class="drop-area" id="vs-y-drop-area"></div>
            </div>
            <div class="sort-zone x-zone">
                <h3>X-Zone</h3>
                <div class="drop-area" id="vs-x-drop-area"></div>
            </div>
            <div class="toolbox" id="vs-toolbox">
                </div>
        </div>

        <div id="vs-solve-phase">
            <div class="solve-step" id="vs-solve-1"></div>
            <div class="solve-step" id="vs-solve-2"></div>
            <div class="solve-step" id="vs-solve-3"></div>
            <div class="solve-step" id="vs-solve-4"></div>
            <div class="solve-step" id="vs-solve-5"></div>
            <div class="solve-step" id="vs-solve-6"></div>
            <div class="solve-step" id="vs-solve-7"></div>
        </div>

    </div>
    
    <button class="calm-btn" id="vs-restart-btn">Sort Another!</button>
    
</div>

        <div class="self-care animate delay-2">
          <h4>ðŸ˜Œ Fun Learning Zone ðŸ˜Œ</h4>
          <p>Games make learning enjoyable! No pressure, just practice in a fun way. ðŸŽ¯ðŸŽ‰</p>
        </div>
      </div>
    </section>

  <div class="completion animate">
    <h3>ðŸŽ‰ Great Job! ðŸŽ‰</h3>
    <p>You've learned about Integration! Remember that understanding takes time and practice.</p>
    <p>ðŸŒŸ <strong>Be proud of what you've accomplished today!</strong> ðŸŒŸ</p>
    <div class="emoji-row">
      <span class="math-emoji">ðŸ¥³</span>
      <span class="math-emoji">ðŸ‘</span>
      <span class="math-emoji">ðŸ’«</span>
    </div>
  </div>
  </div>

  <div class="fab">
    <i class="fas fa-book-open"></i>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-about">
          <div class="footer-logo">
            <div class="footer-logo-icon">S</div>
            Sentellect
          </div>
          <p>Personalizing learning through emotions to improve educational experience for HSSC Mathematics.</p>
          <div class="social-links">
            <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
            <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
        
        <div class="footer-links">
          <h3>Platform</h3>
          <ul>
            <li><a href="#basics">Basics</a></li>
            <li><a href="#examples">Examples</a></li>
            <li><a href="#practice">Practice</a></li>
            <li><a href="#game">Game</a></li>
          </ul>
        </div>
        
        <div class="footer-links">
          <h3>Resources</h3>
          <ul>
            <li><a href="#resources">Study Materials</a></li>
            <li><a href="#">Support</a></li>
          </ul>
        </div>
        
        <div class="footer-links">
          <h3>Account</h3>
          <ul>
            <li><a href="#">Student Login</a></li>
            <li><a href="#">Create Account</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>Â© 2024 Sentellect. Final Year Project - Educational Technology.</p>
        <div class="footer-tags">
          <a href="#" class="tag">Integration</a>
          <a href="#" class="tag">Differentials</a>
          <a href="#" class="tag">Stress-Free Learning</a>
        </div>
      </div>
    </div>
  </footer>

  <canvas class="diff-drift-confetti" id="confettiCanvas"></canvas>

  <script>
    // --- This is the existing JavaScript for your differential games ---
    // --- It is unchanged and will continue to work ---
    
    // --- Problem definitions ---
    const problems = {
      lvl1: { name: "(i) y = x^2 - 1", f: x => x*x - 1, fp: x => 2*x, x0: 3, x1: 3.02 },
      lvl2: { name: "(ii) y = x^2 + 2x", f: x => x*x + 2*x, fp: x => 2*x + 2, x0: 2, x1: 1.8 },
      lvl3: { name: "(iii) y = sqrt(x)", f: x => Math.sqrt(x), fp: x => 1/(2*Math.sqrt(x)), x0: 4, x1: 4.41 }
    };

    // UI elements
    const lvlButtons = { lvl1: document.getElementById('lvl1'), lvl2: document.getElementById('lvl2'), lvl3: document.getElementById('lvl3') };
    const xFinalInput = document.getElementById('xFinal');
    const showStepsBtn = document.getElementById('showSteps');
    const resultDiv = document.getElementById('result');
    const stepsPanel = document.getElementById('stepsPanel');
    const meterFill = document.getElementById('meterFill');
    const meterText = document.getElementById('meterText');
    const calmMsg = document.getElementById('calmMsg');
    const snapBtn = document.getElementById('snap');
    const playHint = document.getElementById('playHint');

    const curveSvg = document.getElementById('curveSvg');
    const curvePath = document.getElementById('curvePath');
    const blob = document.getElementById('blob');
    const bubble = document.getElementById('bubble');

    let active = 'lvl1';
    let confettiTimer = null;

    // formatting helper
    function fmt(n){
      if (Math.abs(n) < 1e-6) return n.toFixed(6);
      return (Math.abs(n) < 1 ? n.toFixed(6).replace(/0+$/,'').replace(/\.$/,'') : (Number.isInteger(n) ? n.toString() : n.toFixed(6)));
    }

    // compute values
    function compute(key){
      const p = problems[key];
      const x0 = Number(p.x0);
      const x1 = Number(p.x1);
      const dx = x1 - x0;
      const y0 = p.f(x0);
      const y1 = p.f(x1);
      const deltaY = y1 - y0;
      const dy = p.fp(x0) * dx;
      const err = deltaY - dy;
      const relErr = Math.abs(err) / (Math.abs(deltaY) + 1e-9);
      return { x0, x1, dx, y0, y1, deltaY, dy, err, relErr };
    }

    // Render result and meter
    function render(key){
      const d = compute(key);
      xFinalInput.value = d.x1;
      resultDiv.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${problems[key].name}</strong></div>
          <div class="diff-drift-small">x: ${d.x0} â†’ <span style="font-family:ui-monospace">${fmt(d.x1)}</span></div>
        </div>
        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between"><span>Î”x</span><span class="diff-drift-small">${fmt(d.dx)}</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px"><span>Î”y (true)</span><span class="diff-drift-small">${fmt(d.deltaY)}</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px"><span>dy (estimate)</span><span class="diff-drift-small">${fmt(d.dy)}</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:8px"><span class="diff-drift-small">Difference (Î”y âˆ’ dy)</span><span class="diff-drift-small">${fmt(d.err)}</span></div>
        </div>
      `;

      // meter: closer -> fuller
      const closeness = Math.max(0, 1 - d.relErr); // 1 is perfect
      const pct = Math.min(1, closeness) * 100;
      meterFill.style.width = pct + '%';
      if (pct > 99) meterText.textContent = 'ðŸ’¯ Excellent â€” the linear estimate is very close';
      else if (pct > 95) meterText.textContent = 'ðŸ™‚ Very good approximation';
      else if (pct > 80) meterText.textContent = 'ðŸ™‚ Good â€” small difference';
      else meterText.textContent = 'ðŸ¤” Noticeable difference â€” try smaller Î”x';

      // steps panel
      stepsPanel.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px">Calm Steps â€” ${problems[key].name}</div>
        <div class="diff-drift-small">1) Î”x = final âˆ’ initial = ${fmt(d.x1)} âˆ’ ${fmt(d.x0)} = <strong>${fmt(d.dx)}</strong></div>
        <div class="diff-drift-small" style="margin-top:8px">2) Î”y = f(final) âˆ’ f(initial) = f(${fmt(d.x1)}) âˆ’ f(${fmt(d.x0)}) = <strong>${fmt(d.deltaY)}</strong></div>
        <div class="diff-drift-small" style="margin-top:8px">3) derivative at x = ${fmt(d.x0)} is f'(${fmt(d.x0)}) = <strong>${fmt(problems[key].fp(d.x0))}</strong></div>
        <div class="diff-drift-small" style="margin-top:8px">4) dy = f'(${fmt(d.x0)}) Ã— Î”x = <strong>${fmt(dyCalculator(key))}</strong></div>
      `;

      // move the blob along curve (gentle animation)
      drawCurveAndPlaceBlob(key);
    }

    function dyCalculator(key){
      const p = problems[key];
      const d = compute(key);
      return p.fp(d.x0) * d.dx;
    }

    // draw a smooth curve (simple mapping) for gentle visualization
    function drawCurveAndPlaceBlob(key){
      // map x range to svg width
      const svgW = 600, svgH = 320;
      // pick a visible x-range centered around x0 and x1 for gentle motion
      const p = problems[key];
      const d = compute(key);
      const minX = Math.min(d.x0, d.x1) - Math.abs(d.dx) - 1;
      const maxX = Math.max(d.x0, d.x1) + Math.abs(d.dx) + 1;
      const xs = [];
      for(let i=0;i<=80;i++){
        const t = i/80;
        xs.push(minX + t*(maxX-minX));
      }
      // get y values
      const ys = xs.map(x => p.f(x));
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      // scale functions
      const sx = x => {
        if (maxX===minX) return svgW*0.5;
        return 40 + ( (x - minX) / (maxX - minX) ) * (svgW - 80);
      };
      const sy = y => {
        if (maxY===minY) return svgH*0.5;
        // invert y so higher y go up visually (smaller pixel)
        return 40 + ( (maxY - y) / (maxY - minY) ) * (svgH - 80);
      };
      // build path
      let path = '';
      xs.forEach((x,i)=>{
        const cx = sx(x), cy = sy(ys[i]);
        path += (i===0?`M ${cx} ${cy}`:` L ${cx} ${cy}`);
      });
      curvePath.setAttribute('d', path);
      // place blob at x0 initially, then animate to x1
      const startX = sx(d.x0), startY = sy(p.f(d.x0));
      const endX = sx(d.x1), endY = sy(p.f(d.x1));
      // set bubble content
      bubble.style.display = 'none';
      // animate blob gently: move to start quickly then glide to end slowly
      blob.style.transition = 'none';
      blob.style.left = `${startX}px`;
      blob.style.top = `${startY}px`;
      // small bounce
      blob.style.transform = 'translate(-50%,-50%) scale(0.98)';
      setTimeout(()=> {
        blob.style.transition = 'left 850ms cubic-bezier(.2,.9,.3,1), top 850ms cubic-bezier(.2,.9,.3,1), transform 850ms';
        blob.style.left = `${endX}px`;
        blob.style.top = `${endY}px`;
        blob.style.transform = 'translate(-50%,-50%) scale(1)';
      }, 60);
      // show bubble with dy after glide
      setTimeout(()=> {
        bubble.style.display = 'block';
        bubble.style.left = `${endX}px`;
        bubble.textContent = `dy â‰ˆ ${fmt(d.dy)}`;
        // gentle glow
        blob.animate([{boxShadow: '0 8px 24px rgba(7,32,48,0.08)'},{boxShadow: '0 18px 40px rgba(125,211,252,0.25)'}], {duration:600, direction:'alternate', iterations:2});
      }, 920);
      // show small applause (confetti) if very close
      if ( (1 - d.relErr) > 0.995 ){
        smallConfettiBurst();
      }
    }

    // level selection handlers
    Object.keys(lvlButtons).forEach(k => {
      lvlButtons[k].addEventListener('click', ()=> {
        // update selected UI
        Object.keys(lvlButtons).forEach(x => lvlButtons[x].classList.remove('selected'));
        lvlButtons[k].classList.add('selected');
        active = k;
        // restore preset final x (snap behavior)
        xFinalInput.value = problems[active].x1;
        render(active);
      });
    });

    // show/hide steps
    showStepsBtn.addEventListener('click', ()=>{
      if (stepsPanel.style.display === 'none' || stepsPanel.style.display === '') {
        stepsPanel.style.display = 'block';
        showStepsBtn.textContent = 'Hide Calm Steps';
      } else {
        stepsPanel.style.display = 'none';
        showStepsBtn.textContent = 'Show Calm Steps';
      }
    });

    // when user edits final x
    xFinalInput.addEventListener('input', ()=>{
      const v = Number(xFinalInput.value);
      if (!isNaN(v)) {
        problems[active].x1 = v;
        render(active);
      }
    });

    // snap to preset
    snapBtn.addEventListener('click', ()=> {
      const presets = { lvl1: 3.02, lvl2: 1.8, lvl3: 4.41 };
      problems[active].x1 = presets[active];
      xFinalInput.value = presets[active];
      render(active);
    });

    // sound hint (gentle tone)
    playHint.addEventListener('click', ()=> {
      playGentleTone();
      calmMsg.textContent = 'Nice â€” a soft tone to breathe with. Inhaleâ€¦ exhaleâ€¦';
      setTimeout(()=> calmMsg.textContent = 'Tip: Smaller changes in x usually make dy (the estimate) closer to Î”y (the true change).', 2400);
    });

    // tiny audio function (soft sine)
    function playGentleTone(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 440;
        g.gain.value = 0.0001;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.06, ctx.currentTime + 0.05);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.2);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 1400);
      }catch(e){
        // audio blocked or not supported quietly ignore
      }
    }

    // --- Confetti (very small burst, not overwhelming) ---
    const confCanvas = document.getElementById('confettiCanvas');
    const cctx = confCanvas.getContext('2d');
    function resizeCanvas(){ confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function smallConfettiBurst(){
      // only a very short burst - 30 pieces
      const pieces = [];
      const colors = ['#7dd3fc','#c7b3ff','#fbe7c6','#bff7d4'];
      for(let i=0;i<30;i++){
        pieces.push({
          x: window.innerWidth/2 + (Math.random()-0.5)*200,
          y: window.innerHeight/2 + (Math.random()-0.5)*120,
          vx: (Math.random()-0.5)*6,
          vy: -6 - Math.random()*4,
          r: 6 + Math.random()*6,
          color: colors[Math.floor(Math.random()*colors.length)],
          rot: Math.random()*360,
          vr: (Math.random()-0.5)*10
        });
      }
      const ttl = 1600;
      const start = performance.now();
      (function anim(now){
        const t = now - start;
        cctx.clearRect(0,0,confCanvas.width, confCanvas.height);
        pieces.forEach(p=>{
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.18;
          cctx.save();
          cctx.translate(p.x,p.y);
          cctx.rotate(p.rot * Math.PI/180);
          cctx.fillStyle = p.color;
          cctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.7);
          cctx.restore();
        });
        if (t < ttl) requestAnimationFrame(anim);
        else cctx.clearRect(0,0,confCanvas.width, confCanvas.height);
      })(performance.now());
    }

    // --- Initial render and small intro ---
    // set initial xFinal and render
    if (xFinalInput) { // Add null check for safety
        xFinalInput.value = problems[active].x1;
        render(active);
    }


    // tiny breathing intro
    if (calmMsg) { // Add null check
        setTimeout(()=> {
        calmMsg.textContent = 'Ready? Choose a level and press "Show Calm Steps" when you want a guided explanation.';
        }, 600);
    }

    // Header scroll effect
    window.addEventListener('scroll', function() {
      const header = document.getElementById('header');
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Animation on scroll
    document.addEventListener('DOMContentLoaded', function() {
      const animateElements = document.querySelectorAll('.animate');
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const delay = entry.target.classList.contains('delay-1') ? 0.2 : 
                         entry.target.classList.contains('delay-2') ? 0.4 :
                         entry.target.classList.contains('delay-3') ? 0.6 : 0;
            
            setTimeout(() => {
              entry.target.style.opacity = 1;
              entry.target.style.transform = 'translateY(0)';
            }, delay * 1000);
          }
        });
      }, { threshold: 0.1 });
      
      animateElements.forEach(element => {
        element.style.opacity = 0;
        element.style.transform = 'translateY(20px)';
        element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(element);
      });
    });


   
(function(){
  // --- This is the script for Starry Garden ---
  const root = document.getElementById('starry-game');
  if (!root) {
    // This is okay, the game just isn't on this page.
    return;
  }

  // Element refs
  const patches = {
    p1: {
      name: 'xy + x = 4',
      steps: ['d(xy)+d(x)=0', "d(xy)=x y' + y", "x y' + y + 1 = 0", "y' = -(y+1)/x"],
      expr: '-(y+1)/x'
    },
    p2: {
      name: 'x^2 + 2y^2 = 16',
      steps: ['2x + 4y y\' = 0', "y' = -x/(2y)"],
      expr: '-x/(2*y)'
    },
    p3: {
      name: 'x^4 + y^2 = x y^2',
      steps: ['4x^3 + 2y y\' = y^2 + 2x y y\'', "collect y' â†’ y' = (y^2 - 4x^3)/(2y(1-x))"],
      expr: '(y*y - 4*x*x*x)/(2*y*(1 - x))'
    },
    p4: {
      name: 'xy - ln x = c',
      steps: ["x y' + y - 1/x = 0", "y' = (1 - x*y)/x^2"],
      expr: '(1 - x*y)/(x*x)'
    }
  };

  const el = (sel, ctx=root) => ctx.querySelector(sel);
  const all = (sel, ctx=root) => Array.from(ctx.querySelectorAll(sel));

  const controls = el('#sg-controls');
  const buttons = all('[data-patch]', controls);
  const showBtn = el('#sg-show');
  const glideBtn = el('#sg-glide');
  const hintBtn = el('#sg-hint');
  const stepsBox = el('#sg-steps');
  const curvePath = el('#sg-curve');
  const garden = el('#sg-garden');
  const firefly = el('#sg-firefly');
  const bubble = el('#sg-bubble');
  const checkBtn = el('#sg-check');
  const ansInput = el('#sg-ans');
  const feedback = el('#sg-feedback');
  const progress = el('#sg-progress');
  const relaxToggle = el('#sg-relax');
  const resetBtn = el('#sg-reset');
  const chimeBtn = el('#sg-chime');

  const confCanvas = document.createElement('canvas');
  confCanvas.style.position = 'fixed';
  confCanvas.style.left = 0;
  confCanvas.style.top = 0;
  confCanvas.style.pointerEvents = 'none';
  confCanvas.style.zIndex = 9999;
  document.body.appendChild(confCanvas);
  const confCtx = confCanvas.getContext('2d');
  function resizeConf(){ confCanvas.width = innerWidth; confCanvas.height = innerHeight; }
  window.addEventListener('resize', resizeConf); resizeConf();

  // state
  let active_sg = 'p1'; // Renamed to avoid conflict
  let stepIndex = 0;
  let relax = true;

  // utilities
  function setActivePatch(key){
    active_sg = key;
    // highlight
    buttons.forEach(b => b.classList.toggle('selected', b.dataset.patch === key));
    // reset UI areas
    stepsBox.innerHTML = '';
    stepIndex = 0;
    ansInput.value = '';
    feedback.textContent = 'Use short steps, then answer.';
    updateProgress(0);
    drawCurve_sg(); // Renamed
    placeFireflyStart();
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => setActivePatch(btn.dataset.patch));
  });

  function showNextStep(){
    const s = patches[active_sg].steps;
    if (stepIndex >= s.length) { stepIndex = 0; stepsBox.innerHTML = ''; showBtn.textContent = 'Show step'; return; }
    const line = s[stepIndex++];
    const elRow = document.createElement('div'); elRow.className = 'stepRow';
    elRow.innerHTML = `<div style="font-weight:600">${line}</div>`;
    stepsBox.appendChild(elRow);
    showBtn.textContent = stepIndex >= s.length ? 'Hide steps' : 'Next step';
  }

  showBtn.addEventListener('click', showNextStep);

  hintBtn.addEventListener('click', () => {
    const hint = {
      p1: 'Product rule: d(xy) = x y\' + y',
      p2: 'Chain: d(y^2) = 2y y\'',
      p3: 'Collect y\' terms then factor',
      p4: 'd(ln x) = 1/x'
    }[active_sg];
    feedback.textContent = hint;
  });

  function drawCurve_sg(){ // Renamed
    // lightweight visual-only curve. safe numeric formulas for visualization.
    const w = 700, h = 320;
    const xs = [];
    for (let i=0;i<=120;i++) xs.push(-3 + i*(6/120));
    const ys = xs.map(x => {
      try {
        if (active_sg === 'p1') return (4 - x)/x;
        if (active_sg === 'p2') { const v = (16 - x*x)/2; return v >= 0 ? Math.sqrt(v) : NaN; }
        if (active_sg === 'p3') { const denom = 1 - x; if (Math.abs(denom) < 1e-6) return NaN; const v = Math.pow(x,4)/denom; return v >= 0 ? Math.sqrt(v) : NaN; }
        if (active_sg === 'p4') { if (x <= 0) return NaN; return (1 + Math.log(x))/x; }
      } catch(e) { return NaN; }
    });

    const valid = ys.filter(v => isFinite(v));
    if (!valid.length) { curvePath.setAttribute('d',''); return; }
    const minY = Math.min(...valid), maxY = Math.max(...valid);
    const minX = Math.min(...xs), maxX = Math.max(...xs);

    const sx = x => 20 + ((x - minX)/(maxX - minX)) * (w - 40);
    const sy = y => 20 + ((maxY - y)/(maxY - minY)) * (h - 40);

    let d = '';
    for (let i=0;i<xs.length;i++){
      const y = ys[i];
      if (!isFinite(y)) continue;
      const px = sx(xs[i]), py = sy(y);
      d += (d === '' ? `M ${px} ${py}` : ` L ${px} ${py}`);
    }
    curvePath.setAttribute('d', d);
  }

  function placeFireflyStart(){
    firefly.style.transition = 'none';
    firefly.style.left = '110px';
    firefly.style.top = '130px';
    bubble.style.display = 'none';
  }

  function glide(){
    drawCurve_sg(); // Renamed
    // pick a safe sample point for each patch
    const sample = {
      p1: {x:3, y:(4-3)/3},
      p2: {x:2, y: Math.sqrt((16 - 4)/2)},
      p3: {x:0.5, y: Math.sqrt(Math.pow(0.5,4)/(1 - 0.5))},
      p4: {x:1.5, y: (1 + Math.log(1.5))/1.5}
    }[active_sg];

    if (!sample) return;
    // map to svg coords (reuse drawCurve mapping logic but simplified)
    const w = 700, h = 320;
    const xs = [];
    for (let i=0;i<=120;i++) xs.push(-3 + i*(6/120));
    const ys = xs.map(x => {
      try {
        if (active_sg === 'p1') return (4 - x)/x;
        if (active_sg === 'p2') { const v = (16 - x*x)/2; return v >= 0 ? Math.sqrt(v) : NaN; }
        if (active_sg === 'p3') { const denom = 1 - x; if (Math.abs(denom) < 1e-6) return NaN; const v = Math.pow(x,4)/denom; return v >= 0 ? Math.sqrt(v) : NaN; }
        if (active_sg === 'p4') { if (x <= 0) return NaN; return (1 + Math.log(x))/x; }
      } catch(e) { return NaN; }
    });

    const valid = ys.filter(v => isFinite(v));
    if (!valid.length) return;
    const minY = Math.min(...valid), maxY = Math.max(...valid);
    const minX = Math.min(...xs), maxX = Math.max(...xs);

    const sx = x => 20 + ((x - minX)/(maxX - minX)) * (w - 40);
    const sy = y => 20 + ((maxY - y)/(maxY - minY)) * (h - 40);

    const fx = sx(sample.x), fy = sy(sample.y);

    firefly.style.transition = relax ? 'left 900ms, top 900ms, transform 500ms' : 'none';
    firefly.style.left = fx + 'px';
    firefly.style.top = fy + 'px';
    firefly.style.transform = 'translate(-50%,-50%) scale(1.02)';

    setTimeout(() => {
      try {
        const f = new Function('x','y','return (' + patches[active_sg].expr + ');');
        const val = f(sample.x, sample.y);
        bubble.textContent = 'dy â‰ˆ ' + (isFinite(val) ? Number(val).toFixed(5) : 'N/A');
      } catch(e) {
        bubble.textContent = 'dy â‰ˆ N/A';
      }
      bubble.style.left = fx + 'px';
      bubble.style.top = fy + 'px';
      bubble.style.display = 'block';
    }, relax ? 980 : 10);
  }

  glideBtn.addEventListener('click', glide);

  function numericEqual(userExp, correctExp){
    try {
      const u = userExp.replace(/\^/g,'**');
      const c = correctExp.replace(/\^/g,'**');
      const samples = [{x:2,y:1},{x:3,y:2},{x:1.5,y:0.8},{x:0.9,y:0.4}];
      for (const p of samples){
        if (p.x === 0) continue;
        const A = new Function('x','y','return (' + u + ');');
        const B = new Function('x','y','return (' + c + ');');
        const av = A(p.x,p.y), bv = B(p.x,p.y);
        if (!isFinite(av) || !isFinite(bv)) continue;
        if (Math.abs(av - bv) > 1e-5 * Math.max(1, Math.abs(bv))) return false;
      }
      return true;
    } catch(e){
      return false;
    }
  }

  checkBtn.addEventListener('click', () => {
    const user = ansInput.value.trim();
    if (!user) { feedback.textContent = 'Try an expression like -(y+1)/x'; return; }
    const ok = numericEqual(user, patches[active_sg].expr);
    if (ok) {
      feedback.textContent = 'Nice match! âœ¨';
      updateProgress(100);
      tinyConfetti_sg(); // Renamed
      gentleChime();
    } else {
      feedback.textContent = 'Not yet â€” check the short steps.';
      updateProgress(35);
    }
  });

  function updateProgress(pct){
    progress.style.width = pct + '%';
  }

  relaxToggle.addEventListener('click', () => {
    relax = !relax;
    relaxToggle.textContent = 'Relax: ' + (relax ? 'on' : 'off');
  });

  resetBtn.addEventListener('click', () => {
    setActivePatch('p1');
  });

  chimeBtn.addEventListener('click', gentleChime);

  function gentleChime(){
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = 660;
      o.connect(g); g.connect(ctx.destination);
      g.gain.value = 0.0001;
      o.start();
      g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.6);
      setTimeout(()=>{ o.stop(); ctx.close(); }, 800);
    } catch(e){}
  }

  function tinyConfetti_sg(){ // Renamed
    resizeConf();
    const pieces = [];
    const cols = ['#9ef3dd','#9ed0ff','#ffd7a6','#c7b3ff'];
    for (let i=0;i<40;i++){
      pieces.push({
        x: innerWidth * 0.5 + (Math.random()-0.5) * 300,
        y: innerHeight * 0.45 + (Math.random()-0.5) * 140,
        vx: (Math.random()-0.5) * 6, vy: -6 - Math.random()*4,
        r: 6 + Math.random()*6, col: cols[Math.floor(Math.random()*cols.length)],
        rot: Math.random()*360, vr: (Math.random()-0.5)*10
      });
    }
    const start = performance.now();
    (function anim(now){
      const t = now - start;
      confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
      pieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += 0.18; p.rot += p.vr*0.02;
        confCtx.save();
        confCtx.translate(p.x, p.y);
        confCtx.rotate(p.rot * Math.PI/180);
        confCtx.fillStyle = p.col;
        confCtx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.8);
        confCtx.restore();
      });
      if (t < 1400) requestAnimationFrame(anim);
      else confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
    })(performance.now());
  }

  // init
  setActivePatch('p1');
  drawCurve_sg(); // Renamed
  placeFireflyStart();

})();

(function(){
  // --- This is the script for Approximation Builder ---
  const root = document.getElementById('approx-builder');
  if (!root) return; // Game not on page

  // Make tiles draggable
  const builderTiles = root.querySelectorAll("#builderTiles .tile");
  const builderDropzones = root.querySelectorAll("#approx-builder .dropzone");
  let draggedTile = null;

  builderTiles.forEach(tile => {
    tile.addEventListener("dragstart", (e) => {
      draggedTile = tile;
      e.dataTransfer.setData("text/plain", tile.dataset.value);
      setTimeout(() => tile.classList.add("hidden"), 0);
    });
    tile.addEventListener("dragend", () => {
      if (draggedTile) { // Check if draggedTile is not null
        draggedTile.classList.remove("hidden");
      }
      draggedTile = null;
    });
  });

  builderDropzones.forEach(zone => {
    zone.addEventListener("dragover", (e) => {
      e.preventDefault(); // Allow drop
    });

    zone.addEventListener("drop", (e) => {
      e.preventDefault();
      if (draggedTile) {
        // If zone already has a tile, send it back
        const existingTile = zone.querySelector(".tile");
        if (existingTile) {
          root.querySelector("#builderTiles").appendChild(existingTile);
        }
        
        // Add new tile
        zone.appendChild(draggedTile);
        zone.classList.add("filled");
        zone.dataset.current = draggedTile.dataset.value;
        zone.classList.remove("correct", "wrong");
      }
    });
    
    // Allow clicking a tile in a dropzone to send it back
    zone.addEventListener("click", () => {
      const tileInZone = zone.querySelector(".tile");
      if (tileInZone) {
        root.querySelector("#builderTiles").appendChild(tileInZone);
        zone.classList.remove("filled", "correct", "wrong");
        zone.dataset.current = "";
      }
    });
  });
})(); // End of Approximation Builder IIFE

// This function needs to be global because it's called by onclick=""
function checkBuilder() {
  const root = document.getElementById('approx-builder');
  if (!root) return;
  const builderDropzones = root.querySelectorAll("#approx-builder .dropzone");
  let allCorrect = true;
  let correctCount = 0;
  const resultBox = root.querySelector("#builderResult");

  builderDropzones.forEach(zone => {
    const current = zone.dataset.current || "";
    const answer = zone.dataset.answer;
    if (current === answer) {
      zone.classList.add("correct");
      zone.classList.remove("wrong");
      correctCount++;
    } else {
      zone.classList.add("wrong");
      zone.classList.remove("correct");
      allCorrect = false;
    }
  });

  if (allCorrect) {
    resultBox.className = "result success";
    resultBox.innerHTML = `âœ… Perfect! You've built the formula. <br>
      <strong>Approx. âˆš17 = f(a) + f'(a)Â·dx = 4 + (1/8)Â·(1) = 4.125</strong>
      <br>(The actual value is ~4.123... That's really close!)`;
  } else {
    resultBox.className = "result error";
    resultBox.innerHTML = `âŒ Not quite yet. You have ${correctCount} out of 6 correct. Check the red boxes and try again.`;
  }
}


(function(){
  // --- This is the script for Implicit Chain Quest ---
  const root = document.getElementById('implicit-quest');
  if (!root) return; // Game not on page

  // Simple string normalization
  function normalize(str) {
    return str.replace(/\s+/g, '').replace(/\*/g, '').toLowerCase();
  }

  // Live feedback as user types
  const imp1 = root.querySelector('#imp1');
  const imp2 = root.querySelector('#imp2');
  const imp3 = root.querySelector('#imp3');
  const fb1 = root.querySelector('#fb1');
  const fb2 = root.querySelector('#fb2');
  const fb3 = root.querySelector('#fb3');

  if (imp1) { // Add null checks
    imp1.addEventListener('input', () => {
      const val = normalize(imp1.value);
      if (val === 'y+x(dy/dx)' || val === 'y+x*y\'' || val === '1*y+x*(dy/dx)' || val === 'y+xy\'') {
        fb1.textContent = 'âœ…';
        fb1.className = 'step-feedback correct';
      } else {
        fb1.textContent = 'ðŸ¤”';
        fb1.className = 'step-feedback incorrect';
      }
    });
  }
  if (imp2) {
    imp2.addEventListener('input', () => {
      if (normalize(imp2.value) === '1') {
        fb2.textContent = 'âœ…';
        fb2.className = 'step-feedback correct';
      } else {
        fb2.textContent = 'âŒ';
        fb2.className = 'step-feedback incorrect';
      }
    });
  }
  if (imp3) {
    imp3.addEventListener('input', () => {
      if (normalize(imp3.value) === '0') {
        fb3.textContent = 'âœ…';
        fb3.className = 'step-feedback correct';
      } else {
        fb3.textContent = 'âŒ';
        fb3.className = 'step-feedback incorrect';
      }
    });
  }
})(); // End of Implicit Chain Quest IIFE

// This function needs to be global because it's called by onclick=""
function checkImplicit() {
  const root = document.getElementById('implicit-quest');
  if (!root) return;
  const finalVal = root.querySelector('#impFinal').value.replace(/\s+/g, '').replace(/\*/g, '').toLowerCase();
  const resultBox = root.querySelector('#implicitResult');
  
  // Possible correct answers
  const answers = [
    '(-1-y)/x', 
    '-(1+y)/x'
  ];

  if (answers.includes(finalVal)) {
    resultBox.className = 'result success';
    resultBox.innerHTML = `ðŸš€ You got it! 
      <br><strong>(y + x(dy/dx)) + 1 = 0</strong>
      <br><strong>x(dy/dx) = -1 - y</strong>
      <br><strong>dy/dx = (-1 - y) / x</strong>`;
  } else {
    resultBox.className = 'result error';
    resultBox.innerHTML = `âŒ Almost! Check your algebra as you solve for dy/dx.
      <br>Hint: Start with <strong>(your answer 1) + (your answer 2) = (your answer 3)</strong> and isolate 'dy/dx'.`;
  }
}

(function(){
  // --- This is the script for Differential Gauges ---
  const root = document.getElementById('differential-gauges-game'); // Changed ID to be unique
  if (!root) return; // Game not on page

})(); // End of Differential Gauges IIFE

// This function needs to be global because it's called by onclick=""
function checkGauges() {
    const root = document.querySelector('.card.animate.delay-3'); // Use a class selector
    if (!root) return;
    
    const f_prime_input = root.querySelector('#g_f_prime');
    const dx_val_input = root.querySelector('#g_dx');
    const dy_val_input = root.querySelector('#g_dy');
    const resultBox = root.querySelector('#gaugeResult');
    const gaugeDisplay = root.querySelector('#gaugeDisplay');
    
    if (!f_prime_input || !dx_val_input || !dy_val_input || !resultBox || !gaugeDisplay) return; // Elements not found

    const f_prime = f_prime_input.value.replace(/\s+/g, '').replace(/\*/g, '').toLowerCase();
    const dx_val = dx_val_input.value.replace(/\s+/g, '');
    const dy_val = dy_val_input.value.replace(/\s+/g, '');

    let allCorrect = true;
    if (f_prime !== '2x') allCorrect = false;
    if (dx_val !== '0.02') allCorrect = false;
    if (dy_val !== '0.12') allCorrect = false;

    if (allCorrect) {
        // Show the visual
        gaugeDisplay.style.display = 'flex';
        
        // Calculate values
        const x_start = 3;
        const x_end = 3.02;
        const dy = 0.12;
        const delta_y = (x_end**2 - 1) - (x_start**2 - 1); // (9.1204 - 1) - (9 - 1) = 8.1204 - 8 = 0.1204
        
        // Set gauge max to be slightly larger than the biggest value
        const max_val = Math.max(dy, delta_y) * 1.1; // e.g., 0.1204 * 1.1 â‰ˆ 0.132
        
        // Map values to angles (-90deg is 0, +90deg is 180)
        // Angle = (value / max) * 180 - 90
        const dy_angle = (dy / max_val) * 180 - 90;
        const delta_angle = (delta_y / max_val) * 180 - 90;
        
        // Update DOM
        root.querySelector('#dyFill').style.transform = `rotate(${dy_angle}deg)`;
        root.querySelector('#deltaFill').style.transform = `rotate(${delta_angle}deg)`;
        
        root.querySelector('#dyValue').textContent = dy.toFixed(4);
        root.querySelector('#deltaValue').textContent = delta_y.toFixed(4);
        
        resultBox.className = 'result success';
        resultBox.innerHTML = `âœ… All inputs correct! Look at the gauges. 
          <br>The approximate change (<strong>$dy = 0.12$</strong>) is extremely close to the actual change (<strong>$Î´y = 0.1204$</strong>). Great work!`;

    } else {
        gaugeDisplay.style.display = 'none';
        resultBox.className = 'result error';
        resultBox.innerHTML = `âŒ Check your inputs. 
          <br><strong>Hint:</strong> $f'(x)$ is the derivative. $dx$ is $x_{\text{new}} - x_{\text{old}}$. $dy = f'(x_{\text{old}}) \cdot dx$.`;
    }
}


(function(){
  // --- This is the script for Diff Dash ---
  const root = document.getElementById('diff-game-card');
  if(!root) return;

  // elements
  const qBtns = Array.from(root.querySelectorAll('[data-q]'));
  const stepsEl = root.querySelector('#dg-steps');
  const formulaEl = root.querySelector('#dg-formula');
  const computeBtn = root.querySelector('#dg-compute');
  const showBtn = root.querySelector('#dg-show');
  const hintBtn = root.querySelector('#dg-hint');
  const resultBox = root.querySelector('#dg-result');
  const approxEl = root.querySelector('#dg-approx');
  const actualEl = root.querySelector('#dg-actual');
  const errorEl = root.querySelector('#dg-error');

  const slider = root.querySelector('#dg-guess');
  const sliderVal = root.querySelector('#dg-guess-val');
  const submitBtn = root.querySelector('#dg-submit');
  const feedback = root.querySelector('#dg-feedback');
  const progress = root.querySelector('#dg-progress');
  const scoreEl = root.querySelector('#dg-score');
  const nextBtn = root.querySelector('#dg-next');
  const resetBtn = root.querySelector('#dg-reset');

  // confetti canvas (very small, optional)
  const conf = document.createElement('canvas');
  conf.style.position='fixed'; conf.style.left=0; conf.style.top=0; conf.style.pointerEvents='none'; conf.style.zIndex=9999;
  document.body.appendChild(conf);
  const cc = conf.getContext('2d');
  function resize(){ conf.width = innerWidth; conf.height = innerHeight; }
  window.addEventListener('resize', resize); resize();

  // problems definition (using differentials)
  const probs = {
    q1: { label:'â´âˆš17', a:16, x:17,
      f: x => Math.pow(x,1/4), fp: x => (1/4)*Math.pow(x,-3/4),
      hint:'Use a=16 because 16=2^4.' },
    q2: { label:'âµâˆš31', a:32, x:31,
      f: x => Math.pow(x,1/5), fp: x => (1/5)*Math.pow(x,-4/5),
      hint:'Use a=32 because 32=2^5.' },
    q3: { label:'cos 29Â°', a:30, x:29,
      f: deg => Math.cos(deg*Math.PI/180), fp: deg => -Math.sin(deg*Math.PI/180)*(Math.PI/180),
      hint:'Use a=30Â°; cos30Â°=âˆš3/2.' },
    q4: { label:'sin 61Â°', a:60, x:61,
      f: deg => Math.sin(deg*Math.PI/180), fp: deg => Math.cos(deg*Math.PI/180)*(Math.PI/180),
      hint:'Use a=60Â°; sin60Â°=âˆš3/2.' }
  };

  let active_dg = 'q1'; // Renamed
  let lastApprox = null;
  let totalScore = 0;

  // helpers
  function fmt_dg(n, d=6){ if(!isFinite(n)) return 'N/A'; return Number(n).toFixed(d).replace(/\.?0+$/,''); } // Renamed
  function setActive_dg(k){ // Renamed
    active_dg = k;
    qBtns.forEach(b => b.classList.toggle('selected', b.dataset.q===k));
    stepsEl.innerHTML = '';
    formulaEl.textContent = `${probs[k].label} â€” a = ${probs[k].a}`;
    resultBox.style.display='none';
    feedback.textContent = 'Press Compute then slide to guess.';
    progress.style.width='0%';
    slider.value = 0; sliderVal.value = '';
  }
  qBtns.forEach(b => b.addEventListener('click', ()=> setActive_dg(b.dataset.q))); // Renamed

  // compute linear approx
  function compute_dg(){ // Renamed
    const p = probs[active_dg];
    const a = p.a, x = p.x;
    const dx = x - a;
    const fa = p.f(a), fpa = p.fp(a);
    const approx = fa + fpa * dx;
    lastApprox = approx;
    // short steps lines
    const lines = [
      `Î”x = ${x} âˆ’ ${a} = ${fmt_dg(dx,5)}`,
      `f(a) = ${fmt_dg(fa,6)} , f'(a) = ${fmt_dg(fpa,6)}`,
      `Linear approx: f(a)+f'(a)Î”x = ${fmt_dg(approx,6)}`
    ];
    stepsEl.innerHTML = lines.map(l => `<div class="simple-step">${l}</div>`).join('');
    approxEl.textContent = fmt_dg(approx,6);
    resultBox.style.display = 'block';
    actualEl.textContent = 'â€”'; errorEl.textContent = 'â€”';
    feedback.textContent = 'Slide to place your guess (or type it) and Submit.';
    // set slider sensible range around approx
    const mid = approx;
    slider.min = mid - Math.abs(mid)*0.3 - 1;
    slider.max = mid + Math.abs(mid)*0.3 + 1;
    slider.step = (Math.abs(mid)||1)/10000;
    // reset progress
    progress.style.width = '0%';
  }
  computeBtn.addEventListener('click', compute_dg); // Renamed

  showBtn.addEventListener('click', ()=>{
    if(lastApprox === null) { feedback.textContent = 'Compute first.'; return; }
    const p = probs[active_dg];
    const actual = p.f(p.x);
    actualEl.textContent = fmt_dg(actual,8);
    const err = Math.abs(actual - lastApprox);
    errorEl.textContent = fmt_dg(err,8);
  });

  hintBtn.addEventListener('click', ()=> { feedback.textContent = probs[active_dg].hint; });

  // slider <-> text sync
  slider.addEventListener('input', ()=> { sliderVal.value = slider.value; });
  sliderVal.addEventListener('input', ()=> {
    const v = Number(sliderVal.value);
    if(!isNaN(v)) slider.value = v;
  });

  // scoring: points = max(0, round(100*(1 - normalized error))) where normalized error uses magnitude scale
  function scoreFor(guess, approx){
    const actualScale = Math.max( Math.abs(approx), 0.5 ); // avoid tiny denominators
    const relErr = Math.min(1, Math.abs(guess - approx) / (actualScale * 0.2)); // 0.2*scale ~ tolerance
    const pts = Math.max(0, Math.round(100 * (1 - relErr)));
    return pts;
  }

  // submit guess
  submitBtn.addEventListener('click', ()=> {
    if(lastApprox === null){ feedback.textContent = 'Compute first.'; return; }
    const guess = Number(sliderVal.value || slider.value);
    if(isNaN(guess)){ feedback.textContent = 'Enter a number.'; return; }
    const approx = lastApprox;
    const pts = scoreFor(guess, approx);
    totalScore += pts;
    scoreEl.textContent = totalScore;
    progress.style.width = Math.min(100, pts) + '%';
    feedback.textContent = `You scored ${pts} points this round. (closer â†’ more points)`;
    // show small confetti if excellent
    if(pts >= 95) tinyConfetti_dg(); // Renamed
  });

  // next: pick next problem in order
  nextBtn.addEventListener('click', ()=>{
    const keys = Object.keys(probs);
    const idx = keys.indexOf(active_dg);
    const next = keys[(idx + 1) % keys.length];
    setActive_dg(next); // Renamed
  });

  // reset
  resetBtn.addEventListener('click', ()=> {
    totalScore = 0; scoreEl.textContent = '0';
    setActive_dg('q1'); // Renamed
  });

  // confetti (very small)
  function tinyConfetti_dg(){ // Renamed
    resize();
    const pieces = [];
    const cols = ['#9ef3dd','#9ed0ff','#ffd7a6','#c7b3ff'];
    for(let i=0;i<30;i++){
      pieces.push({
        x: innerWidth*0.5 + (Math.random()-0.5)*300,
        y: innerHeight*0.45 + (Math.random()-0.5)*140,
        vx: (Math.random()-0.5)*6, vy: -6 - Math.random()*4,
        r: 6 + Math.random()*6, col: cols[Math.floor(Math.random()*cols.length)],
        rot: Math.random()*360, vr: (Math.random()-0.5)*10
      });
    }
    const start = performance.now();
    (function anim(now){
      const t = now - start;
      cc.clearRect(0,0,conf.width,conf.height);
      pieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += 0.18; p.rot += p.vr*0.02;
        cc.save(); cc.translate(p.x,p.y); cc.rotate(p.rot*Math.PI/180);
        cc.fillStyle = p.col; cc.fillRect(-p.r/2,-p.r/2,p.r,p.r*0.8);
        cc.restore();
      });
      if(t < 1200) requestAnimationFrame(anim);
      else cc.clearRect(0,0,conf.width,conf.height);
    })(performance.now());
  }

  // init
  setActive_dg('q1'); // Renamed

})();


    /* ================================================
    === NEW JAVASCRIPT FOR INTEGRAL GAMES STARTS ===
    ================================================
    */

    // --- Game 1: Integral Potion Match ---
    (function() {
      const gameRoot = document.getElementById('integral-potion-game');
      if (!gameRoot) return; // Don't run if element isn't present

      const problemEl = gameRoot.querySelector('#potion-problem');
      const choicesEl = gameRoot.querySelector('#potion-choices');
      const resultEl = gameRoot.querySelector('#potion-result');
      const nextBtn = gameRoot.querySelector('#next-potion-btn');
      
      // START: Added solution elements
      const showStepsBtn = gameRoot.querySelector('#potion-show-steps');
      const solutionBox = gameRoot.querySelector('#potion-solution');
      const sol_q = gameRoot.querySelector('#potion-sol-q');
      const sol_n = gameRoot.querySelector('#potion-sol-n');
      const sol_n1 = gameRoot.querySelector('#potion-sol-n1');
      const sol_a = gameRoot.querySelector('#potion-sol-a');
      // END: Added solution elements

      const problems = [
        // Updated problems to include step data
        { q: "âˆ« 3xÂ² dx", a: "xÂ³ + C", o: ["3xÂ³ + C", "6x + C"], hint: "Add 1 to the exponent (2 â†’ 3), then divide by the new exponent (3/3 = 1).", n: 2, n1: 3 },
        { q: "âˆ« 5xâ´ dx", a: "xâµ + C", o: ["20xÂ³ + C", "5xâµ + C"], hint: "Add 1 to the exponent (4 â†’ 5), then divide by 5. (5/5 = 1).", n: 4, n1: 5 },
        { q: "âˆ« 8x dx", a: "4xÂ² + C", o: ["8xÂ² + C", "8 + C"], hint: "The exponent on x is 1. Add 1 (1 â†’ 2), then divide by 2. (8/2 = 4).", n: 1, n1: 2 },
        { q: "âˆ« 6 dx", a: "6x + C", o: ["6xÂ² + C", "0 + C"], hint: "The integral of any constant (like 6) is just that constant times x.", n: 0, n1: 1 },
        { q: "âˆ« xÂ³ dx", a: "xâ´/4 + C", o: ["3xÂ² + C", "xâ´ + C"], hint: "Add 1 to the exponent (3 â†’ 4), then divide by 4.", n: 3, n1: 4 }
      ];
      
      let currentProblem = null;
      let_potion_answered = false;

      function loadProblem() {
        // Get a random problem
        currentProblem = problems[Math.floor(Math.random() * problems.length)];
        let_potion_answered = false;
        
        problemEl.innerHTML = currentProblem.q;
        resultEl.style.display = 'none';
        nextBtn.style.display = 'none';
        choicesEl.innerHTML = '';
        
        // START: Reset solution box
        solutionBox.style.display = 'none';
        showStepsBtn.textContent = 'Show Calm Steps';
        showStepsBtn.style.display = 'inline-block';
        // END: Reset solution box

        // Create answer choices
        const choices = [currentProblem.a, ...currentProblem.o];
        // Shuffle choices
        choices.sort(() => Math.random() - 0.5);
        
        choices.forEach(choice => {
          const btn = document.createElement('button');
          btn.className = 'potion-btn';
          btn.innerHTML = choice;
          btn.dataset.answer = choice;
          btn.addEventListener('click', checkAnswer);
          choicesEl.appendChild(btn);
        });
      }
      
      function checkAnswer(e) {
        if (let_potion_answered) return; // Prevent multiple clicks
        let_potion_answered = true;
        
        const selected = e.currentTarget;
        const answer = selected.dataset.answer;
        
        // Disable all buttons
        choicesEl.querySelectorAll('.potion-btn').forEach(btn => {
          btn.disabled = true;
        });
        
        if (answer === currentProblem.a) {
          selected.classList.add('correct');
          resultEl.className = 'result success';
          resultEl.innerHTML = `âœ… <strong>Correct!</strong> ${currentProblem.hint}`;
        } else {
          selected.classList.add('wrong');
          resultEl.className = 'result error';
          resultEl.innerHTML = `âŒ <strong>Not quite.</strong> ${currentProblem.hint}`;
          // Also highlight the correct one
          choicesEl.querySelector(`.potion-btn[data-answer="${currentProblem.a}"]`).classList.add('correct');
        }
        
        resultEl.style.display = 'block';
        nextBtn.style.display = 'inline-block';
        showStepsBtn.style.display = 'inline-block'; // Ensure steps button is visible
      }
      
      // START: Add event listener for show steps
      showStepsBtn.addEventListener('click', () => {
        if (solutionBox.style.display === 'none' || solutionBox.style.display === '') {
          // Populate and show the solution
          sol_q.innerHTML = currentProblem.q;
          sol_n.textContent = currentProblem.n;
          sol_n1.textContent = currentProblem.n1;
          sol_a.textContent = currentProblem.a.replace(' + C', '');
          
          solutionBox.style.display = 'block';
          showStepsBtn.textContent = 'Hide Calm Steps';
        } else {
          // Hide the solution
          solutionBox.style.display = 'none';
          showStepsBtn.textContent = 'Show Calm Steps';
        }
      });
      // END: Add event listener for show steps

      nextBtn.addEventListener('click', loadProblem);
      
      // Load the first problem
      loadProblem();
      
    })(); // End of Potion Match IIFE

    
    // --- Game 2: U-Substitution Quest ---
    (function() {
      const gameRoot = document.getElementById('usub-quest-game');
      if (!gameRoot) return; // Don't run
      
      // Get all elements
      const problemEl = gameRoot.querySelector('#usub-problem');
      const nextBtn = gameRoot.querySelector('#next-usub-btn');
      
      const step1 = gameRoot.querySelector('#usub-step1');
      const uInput = gameRoot.querySelector('#usub-u-input');
      const uCheckBtn = gameRoot.querySelector('#usub-check-u');
      const uResult = gameRoot.querySelector('#usub-u-result');
      
      const step2 = gameRoot.querySelector('#usub-step2');
      const duInput = gameRoot.querySelector('#usub-du-input');
      const duCheckBtn = gameRoot.querySelector('#usub-check-du');
      const duResult = gameRoot.querySelector('#usub-du-result');
      
      const step3 = gameRoot.querySelector('#usub-step3');
      const integralInput = gameRoot.querySelector('#usub-integral-input');
      const integralCheckBtn = gameRoot.querySelector('#usub-check-integral');
      const integralResult = gameRoot.querySelector('#usub-integral-result');
      const step3Label = step3.querySelector('label');
      
      const step4 = gameRoot.querySelector('#usub-step4');
      const finalInput = gameRoot.querySelector('#usub-final-input');
      const finalCheckBtn = gameRoot.querySelector('#usub-check-final');
      const finalResult = gameRoot.querySelector('#usub-final-result');

      // START: Added solution elements
      const showStepsBtn = gameRoot.querySelector('#usub-show-steps');
      const solutionBox = gameRoot.querySelector('#usub-solution');
      const sol_q = gameRoot.querySelector('#usub-sol-q');
      const sol_u = gameRoot.querySelector('#usub-sol-u');
      const sol_du = gameRoot.querySelector('#usub-sol-du');
      const sol_intq = gameRoot.querySelector('#usub-sol-intq');
      const sol_inta = gameRoot.querySelector('#usub-sol-inta');
      const sol_final = gameRoot.querySelector('#usub-sol-final');
      // END: Added solution elements
      
      // Problem database
      const problems = [
        { 
          q: "âˆ« (xÂ² + 1)Â³ Â· 2x dx",
          u: "xÂ²+1", 
          du: "2x", 
          integral_q: "âˆ« uÂ³ du",
          integral_a: "uâ´/4", 
          final: "(xÂ²+1)â´/4"
        },
        { 
          q: "âˆ« sin(xÂ³) Â· 3xÂ² dx",
          u: "xÂ³", 
          du: "3xÂ²", 
          integral_q: "âˆ« sin(u) du",
          integral_a: "-cos(u)", 
          final: "-cos(xÂ³)"
        },
        { 
          q: "âˆ« e<sup>5x+1</sup> Â· 5 dx",
          u: "5x+1", 
          du: "5", 
          integral_q: "âˆ« e<sup>u</sup> du",
          integral_a: "e<sup>u</sup>", 
          final: "e<sup>5x+1</sup>"
        },
        { 
          q: "âˆ« (x+8)â· dx",
          u: "x+8", 
          du: "1", 
          integral_q: "âˆ« uâ· du",
          integral_a: "uâ¸/8", 
          final: "(x+8)â¸/8"
        }
      ];
      
      let currentProblem = null;
      
      // Helper function to normalize string inputs
      function normalize(str) {
        return str.replace(/\s+/g, '').replace(/\*/g, '').toLowerCase();
      }
      
      function loadProblem() {
        currentProblem = problems[Math.floor(Math.random() * problems.length)];
        
        problemEl.innerHTML = currentProblem.q;
        
        // Reset all steps
        step1.style.display = 'block';
        uInput.value = '';
        uResult.style.display = 'none';
        uInput.disabled = false;
        uCheckBtn.disabled = false;
        
        step2.style.display = 'none';
        duInput.value = '';
        duResult.style.display = 'none';
        duInput.disabled = false;
        duCheckBtn.disabled = false;

        step3.style.display = 'none';
        integralInput.value = '';
        integralResult.style.display = 'none';
        integralInput.disabled = false;
        integralCheckBtn.disabled = false;
        step3Label.innerHTML = `Step 3: Perfect! The integral is now ${currentProblem.integral_q}. What's the antiderivative?`;
        
        step4.style.display = 'none';
        finalInput.value = '';
        finalResult.style.display = 'none';
        finalInput.disabled = false;
        finalCheckBtn.disabled = false;
        
        nextBtn.style.display = 'none';

        // START: Reset solution box
        solutionBox.style.display = 'none';
        showStepsBtn.textContent = 'Show Calm Steps';
        showStepsBtn.style.display = 'inline-block';
        // END: Reset solution box
      }
      
      // --- Event Listeners for each step ---
      
      uCheckBtn.addEventListener('click', () => {
        const u_ans = normalize(uInput.value);
        if (u_ans === normalize(currentProblem.u)) {
          uResult.className = 'result success';
          uResult.innerHTML = `âœ… That's it! <strong>u = ${currentProblem.u}</strong> is the perfect choice.`;
          uInput.disabled = true;
          uCheckBtn.disabled = true;
          step2.style.display = 'block';
        } else {
          uResult.className = 'result error';
          uResult.innerHTML = "âŒ Hmm, that's not the best 'inside' function. Try looking for what's inside the parentheses or power.";
        }
        uResult.style.display = 'block';
      });
      
      duCheckBtn.addEventListener('click', () => {
        const du_ans = normalize(duInput.value);
        if (du_ans === normalize(currentProblem.du)) {
          duResult.className = 'result success';
          duResult.innerHTML = `âœ… Correct! The derivative of ${currentProblem.u} is <strong>${currentProblem.du}</strong>.`;
          duInput.disabled = true;
          duCheckBtn.disabled = true;
          step3.style.display = 'block';
        } else {
          duResult.className = 'result error';
          duResult.innerHTML = `âŒ Not quite. Try finding the derivative of <strong>${currentProblem.u}</strong> again.`;
        }
        duResult.style.display = 'block';
      });
      
      integralCheckBtn.addEventListener('click', () => {
        const int_ans = normalize(integralInput.value);
        if (int_ans === normalize(currentProblem.integral_a)) {
          integralResult.className = 'result success';
          integralResult.innerHTML = `âœ… Exactly! The integral of ${currentProblem.integral_q} is <strong>${currentProblem.integral_a} + C</strong>.`;
          integralInput.disabled = true;
          integralCheckBtn.disabled = true;
          step4.style.display = 'block';
        } else {
          integralResult.className = 'result error';
          integralResult.innerHTML = `âŒ Almost! How do you integrate ${currentProblem.integral_q}? Think about the power rule.`;
        }
        integralResult.style.display = 'block';
      });
      
      finalCheckBtn.addEventListener('click', () => {
        const final_ans = normalize(finalInput.value);
        if (final_ans === normalize(currentProblem.final)) {
          finalResult.className = 'result success';
          finalResult.innerHTML = `ðŸŽ‰ <strong>Perfect! You solved it!</strong> The final answer is <strong>${currentProblem.final} + C</strong>.`;
          finalInput.disabled = true;
          finalCheckBtn.disabled = true;
          nextBtn.style.display = 'inline-block';
        } else {
          finalResult.className = 'result error';
          finalResult.innerHTML = `âŒ So close! Just replace 'u' in <strong>${currentProblem.integral_a}</strong> with <strong>${currentProblem.u}</strong>.`;
        }
        finalResult.style.display = 'block';
      });

      // START: Add event listener for show steps
      showStepsBtn.addEventListener('click', () => {
        if (solutionBox.style.display === 'none' || solutionBox.style.display === '') {
          // Populate and show the solution
          sol_q.innerHTML = currentProblem.q;
          sol_u.innerHTML = currentProblem.u;
          sol_du.innerHTML = currentProblem.du;
          sol_intq.innerHTML = currentProblem.integral_q;
          sol_inta.innerHTML = currentProblem.integral_a;
          sol_final.innerHTML = currentProblem.final;
          
          solutionBox.style.display = 'block';
          showStepsBtn.textContent = 'Hide Calm Steps';
        } else {
          // Hide the solution
          solutionBox.style.display = 'none';
          showStepsBtn.textContent = 'Show Calm Steps';
        }
      });
      // END: Add event listener for show steps
      
      nextBtn.addEventListener('click', loadProblem);
      
      // Load the first problem
      loadProblem();
      
    })(); // End of U-Sub Quest IIFE

    /* ==============================================
    === NEW JAVASCRIPT FOR INTEGRAL GAMES ENDS ===
    ==============================================
    */
   // --- Game 3: Wizard's Scroll ---
    (function() {
      const gameRoot = document.getElementById('wizard-scroll-game');
      if (!gameRoot) return; // Don't run

      // --- We must use double backslashes (\\) for LaTeX in JavaScript ---
      const questSteps = [
        {
          step: 0,
          problem: "$$\\int \\sqrt{\\frac{1+x}{1-x}} \\, dx$$",
          guide: "Greetings, apprentice! This potion looks nasty. That root is the problem. Let's try the <b>'Algebra Wand'</b> to rationalize the *inside* of the root.",
          correctTool: "wz-spell-algebra"
        },
        {
          step: 1,
          problem: "$$\\int \\frac{1+x}{\\sqrt{1-x^2}} \\, dx$$",
          guide: "Excellent! Multiplying by $\\frac{1+x}{1+x}$ worked. Now the numerator is simple. We can use the <b>'Split Fraction'</b> scissors to make this two separate, easier problems.",
          correctTool: "wz-spell-split"
        },
        {
          step: 2,
          problem: "$$\\int \\frac{1}{\\sqrt{1-x^2}} dx + \\int \\frac{x}{\\sqrt{1-x^2}} dx$$",
          guide: "Wonderful! Look at the first integral. It's a classic form. It's a perfect match for the <b>'Arcsin Shield'</b>.",
          correctTool: "wz-spell-arcsin"
        },
        {
          step: 3,
          problem: "$$\\sin^{-1}(x) + \\int \\frac{x}{\\sqrt{1-x^2}} dx$$",
          guide: "Perfect! Now for the second integral. Notice the derivative of $1-x^2$ is $-2x$, which is almost on top. This is a job for the <b>'U-Sub Potion'</b>!",
          correctTool: "wz-spell-usub"
        },
        {
          step: 4,
          problem: "$$\\sin^{-1}(x) - \\sqrt{1-x^2} + C$$",
          guide: "ðŸŽ‰ <strong>SPELL COMPLETE!</strong> You've solved it! You combined algebra, splitting, Arcsin, and U-Substitution. Masterfully done!",
          correctTool: "wz-restart-btn"
        }
      ];
      
      // --- Game Elements ---
      const problemDisplay = gameRoot.querySelector('#wz-problem-display');
      const guideMessage = gameRoot.querySelector('#wz-guide-message');
      const allButtons = gameRoot.querySelectorAll('.wz-spellbook .calm-btn');
      const showStepsBtn = gameRoot.querySelector('#wz-show-steps-btn');
      const solutionBox = gameRoot.querySelector('#wz-solution-box');
      const restartBtn = gameRoot.querySelector('#wz-restart-btn');

      let currentStep = 0;

      // --- Game Logic ---

      function loadStep(stepIndex) {
        const step = questSteps[stepIndex];
        currentStep = stepIndex;

        // 1. Update the guide message
        guideMessage.style.opacity = '0';
        setTimeout(() => {
          guideMessage.innerHTML = step.guide;
          guideMessage.style.opacity = '1';
          // Re-render MathJax in the guide message
          if (window.MathJax) MathJax.typesetPromise([guideMessage]);
        }, 300);

        // 2. Animate the integral problem
        animateIntegralChange(step.problem);

        // 3. Highlight the correct tool
        allButtons.forEach(btn => {
          btn.classList.remove('glowing-spell');
          btn.disabled = false; // Re-enable all buttons
        });
        
        if (step.correctTool && step.correctTool !== 'wz-restart-btn') {
          const toolBtn = gameRoot.querySelector('#' + step.correctTool);
          if (toolBtn) toolBtn.classList.add('glowing-spell');
        }
        
        // 4. Handle final step
        if (step.correctTool === 'wz-restart-btn') {
          problemDisplay.classList.add('celebrate'); // You can add a .celebrate style
          allButtons.forEach(btn => btn.disabled = true);
          restartBtn.style.display = 'inline-block';
        } else {
          problemDisplay.classList.remove('celebrate');
          restartBtn.style.display = 'none';
        }
      }

      // This function handles the animation of the integral itself
      function animateIntegralChange(newMath) {
        problemDisplay.classList.add('wz-transform-out'); // Start fade out
        
        setTimeout(() => {
          problemDisplay.innerHTML = newMath;
          // Re-render MathJax in the problem display
          if (window.MathJax) MathJax.typesetPromise([problemDisplay]).then(() => {
            problemDisplay.classList.remove('wz-transform-out');
            problemDisplay.classList.add('wz-transform-in');
          });
        }, 400); // Wait for fade out
      }

      function selectSpell(e) {
        const selectedToolId = e.currentTarget.id;
        const correctToolId = questSteps[currentStep].correctTool;

        // Clear any previous shakes
        e.currentTarget.classList.remove('shake');

        if (selectedToolId === correctToolId) {
          // --- CORRECT ---
          loadStep(currentStep + 1); // Go to next step
        } else {
          // --- WRONG ---
          e.currentTarget.classList.add('shake');
          guideMessage.innerHTML = "Hmm, that spell fizzled. Try the <b>glowing one</b>... it seems eager to help!";
          // Remove shake after animation
          setTimeout(() => {
            e.currentTarget.classList.remove('shake');
          }, 500);
        }
      }
      
      // --- Show/Hide Solution (like your example) ---
      showStepsBtn.addEventListener('click', () => {
          if (solutionBox.style.display === 'none' || solutionBox.style.display === '') {
            // We'll build the solution text dynamically based on the problem
            solutionBox.innerHTML = `
              <h4>Calm Steps Summary</h4>
              <p><strong>Problem:</strong> $$\\int \\sqrt{\\frac{1+x}{1-x}} \\, dx$$</p>
              <p>1. <strong>Rationalize:</strong> Multiply inside by $\\frac{1+x}{1+x}$ to get $$\\int \\frac{\\sqrt{(1+x)^2}}{\\sqrt{1-x^2}} dx = \\int \\frac{1+x}{\\sqrt{1-x^2}} dx$$</p>
              <p>2. <strong>Split:</strong> Break into two integrals: $$\\int \\frac{1}{\\sqrt{1-x^2}} dx + \\int \\frac{x}{\\sqrt{1-x^2}} dx$$</p>
              <p>3. <strong>Solve Part 1:</strong> The first integral is a standard form: $$\\sin^{-1}(x)$$</p>
              <p>4. <strong>Solve Part 2 (U-Sub):</strong> Let $u = 1-x^2$, so $du = -2x dx$. We get $$\\int \\frac{-1/2}{\\sqrt{u}} du = -\\sqrt{u}$$</p>
              <p>5. <strong>Combine:</strong> Put it all together for the final answer: $$\\sin^{-1}(x) - \\sqrt{1-x^2} + C$$</p>
            `;
            if (window.MathJax) MathJax.typesetPromise([solutionBox]);
            solutionBox.style.display = 'block';
            showStepsBtn.textContent = 'Hide Calm Steps';
          } else {
            solutionBox.style.display = 'none';
            showStepsBtn.textContent = 'Show Calm Steps';
          }
      });
      
      // --- Restart Button ---
      restartBtn.addEventListener('click', () => loadStep(0));

      // --- Event Listeners ---
      allButtons.forEach(btn => {
        btn.addEventListener('click', selectSpell);
      });

      // --- Start Game ---
      loadStep(0);

    })(); // End of Wizard's Scroll IIFE


    /*
  JAVASCRIPT FOR CALCULUS QUEST
  Paste this in a new <script> tag right before the closing </body> tag.
*/
(function() {
  // --- Wait for MathJax to be ready before initializing the game ---
  // This is crucial!
  if (typeof MathJax !== 'undefined' && MathJax.startup) {
    MathJax.startup.promise.then(() => {
      initializeCalculusQuest();
    });
  } else {
    // Fallback if MathJax is still loading
    document.addEventListener('DOMContentLoaded', () => {
        // Give MathJax a second to finish loading
        setTimeout(initializeCalculusQuest, 1000);
    });
  }

  function initializeCalculusQuest() {
    const gameRoot = document.getElementById('calculus-quest-game');
    if (!gameRoot) return; // Exit if game HTML isn't on the page

    // --- Problem Database ---
    // All solutions written in LaTeX for MathJax
    const problemDatabase = {
      // --- ISLAND 1: PARTS ---
      'p1_1': {
        problem: "$$\\int x \\sin x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p>L-I-<b>A</b>-<b>T</b>-E. 'x' is Algebraic (A), 'sin x' is Trig (T). 'A' comes first, so:</p>
          <ul>
            <li><code>Let $$u = x$$</code></li>
            <li><code>Let $$dv = \\sin x \\, dx$$</code></li>
          </ul>
          <h4>2. Find du and v</h4>
          <ul>
            <li><code>$$du = 1 \\, dx$$</code> (Derivative of u)</li>
            <li><code>$$v = -\\cos x$$</code> (Integral of dv)</li>
          </ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(x)(-\\cos x) - \\int (-\\cos x)(1 \\, dx)$$</code></p>
          <p><code>$$-x \\cos x + \\int \\cos x \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p>The integral of $$\\cos x$$ is $$\\sin x$$.</p>
          <p><strong>Final Answer:</strong> <code>$$-x \\cos x + \\sin x + C$$</code></p>
        `
      },
      'p1_2': {
        problem: "$$\\int x^2 \\ln x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p><b>L</b>-I-<b>A</b>-T-E. 'ln x' is Log (L), 'xÂ²' is Algebraic (A). 'L' comes first, so:</p>
          <ul>
            <li><code>Let $$u = \\ln x$$</code></li>
            <li><code>Let $$dv = x^2 \\, dx$$</code></li>
          </ul>
          <h4>2. Find du and v</h4>
          <ul>
            <li><code>$$du = \\frac{1}{x} \\, dx$$</code> (Derivative of u)</li>
            <li><code>$$v = \\frac{x^3}{3}$$</code> (Integral of dv)</li>
          </ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\ln x)(\\frac{x^3}{3}) - \\int (\\frac{x^3}{3})(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^3 \\ln x}{3} - \\int \\frac{x^2}{3} \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$\\frac{x^3 \\ln x}{3} - \\frac{1}{3} \\int x^2 \\, dx$$</code></p>
          <p><code>$$\\frac{x^3 \\ln x}{3} - \\frac{1}{3} (\\frac{x^3}{3}) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^3 \\ln x}{3} - \\frac{x^3}{9} + C$$</code></p>
        `
      },
      'p1_3': {
        problem: "$$\\int x \\ln x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p><b>L</b>-I-<b>A</b>-T-E. 'ln x' is Log (L), 'x' is Algebraic (A). 'L' comes first.</p>
          <ul><li><code>Let $$u = \\ln x$$</code></li><li><code>Let $$dv = x \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{x} \\, dx$$</code></li><li><code>$$v = \\frac{x^2}{2}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\ln x)(\\frac{x^2}{2}) - \\int (\\frac{x^2}{2})(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^2 \\ln x}{2} - \\int \\frac{x}{2} \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$\\frac{x^2 \\ln x}{2} - \\frac{1}{2} (\\frac{x^2}{2}) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^2 \\ln x}{2} - \\frac{x^2}{4} + C$$</code></p>
        `
      },
      'p1_4': {
        problem: "$$\\int \\ln x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (Invisible 1 Trick)</h4>
          <p>We only see 'ln x'. We use the "Invisible 1" trick. <b>L</b>-I-<b>A</b>-T-E.</p>
          <ul>
            <li><code>Let $$u = \\ln x$$</code> (L)</li>
            <li><code>Let $$dv = 1 \\, dx$$</code> (A)</li>
          </ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{x} \\, dx$$</code></li><li><code>$$v = x$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\ln x)(x) - \\int (x)(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$x \\ln x - \\int 1 \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$x \\ln x - x + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$x \\ln x - x + C$$</code></p>
        `
      },
      'p1_5': {
        problem: "$$\\int x^3 \\ln x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p><b>L</b>-I-<b>A</b>-T-E. 'ln x' is Log (L), 'xÂ³' is Algebraic (A). 'L' comes first.</p>
          <ul><li><code>Let $$u = \\ln x$$</code></li><li><code>Let $$dv = x^3 \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{x} \\, dx$$</code></li><li><code>$$v = \\frac{x^4}{4}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\ln x)(\\frac{x^4}{4}) - \\int (\\frac{x^4}{4})(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^4 \\ln x}{4} - \\int \\frac{x^3}{4} \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$\\frac{x^4 \\ln x}{4} - \\frac{1}{4} (\\frac{x^4}{4}) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^4 \\ln x}{4} - \\frac{x^4}{16} + C$$</code></p>
        `
      },
      'p1_6': {
        problem: "$$\\int x^4 \\ln x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p><b>L</b>-I-<b>A</b>-T-E. 'ln x' is Log (L), 'xâ´' is Algebraic (A). 'L' comes first.</p>
          <ul><li><code>Let $$u = \\ln x$$</code></li><li><code>Let $$dv = x^4 \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{x} \\, dx$$</code></li><li><code>$$v = \\frac{x^5}{5}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\ln x)(\\frac{x^5}{5}) - \\int (\\frac{x^5}{5})(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^5 \\ln x}{5} - \\int \\frac{x^4}{5} \\, dx$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$\\frac{x^5 \\ln x}{5} - \\frac{1}{5} (\\frac{x^5}{5}) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^5 \\ln x}{5} - \\frac{x^5}{25} + C$$</code></p>
        `
      },
      'p1_7': {
        problem: "$$\\int \\tan^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (Invisible 1 Trick)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'tanâ»Â¹ x' is Inverse Trig (I). We use the "Invisible 1".</p>
          <ul>
            <li><code>Let $$u = \\tan^{-1} x$$</code> (I)</li>
            <li><code>Let $$dv = 1 \\, dx$$</code> (A)</li>
          </ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{1+x^2} \\, dx$$</code></li><li><code>$$v = x$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\tan^{-1} x)(x) - \\int (x)(\\frac{1}{1+x^2} \\, dx)$$</code></p>
          <p><code>$$x \\tan^{-1} x - \\int \\frac{x}{1+x^2} \\, dx$$</code></p>
          <h4>4. Solve with u-Substitution</h4>
          <p>For the new integral, let <code>$$w = 1+x^2$$</code>, so <code>$$dw = 2x \\, dx$$</code>, which means <code>$$\\frac{1}{2} dw = x \\, dx$$</code>.</p>
          <p><code>$$x \\tan^{-1} x - \\int \\frac{1}{w} (\\frac{1}{2} dw)$$</code></p>
          <p><code>$$x \\tan^{-1} x - \\frac{1}{2} \\ln |w| + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$x \\tan^{-1} x - \\frac{1}{2} \\ln(1+x^2) + C$$</code></p>
        `
      },
      'p1_8': {
        problem: "$$\\int x^2 \\sin x \\, dx$$",
        solution: `
          <h4>1. Use Tabular Method (Fast IBP)</h4>
          <p>This requires two rounds of IBP. The Tabular Method is faster.</p>
          <p>L-I-<b>A</b>-<b>T</b>-E. 'xÂ²' is Algebraic (A), 'sin x' is Trig (T).</p>
          <table class="cq-table">
            <tr><th>Differentiate $$u = x^2$$</th><th>Integrate $$dv = \\sin x$$</th><th>Sign</th></tr>
            <tr><td><code>$$x^2$$</code></td><td><code>$$\\sin x$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$2x$$</code></td><td><code>$$-\\cos x$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$2$$</code></td><td><code>$$-\\sin x$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$0$$</code></td><td><code>$$\\cos x$$</code></td><td><code>$$-$$</code></td></tr>
          </table>
          <h4>2. Multiply Diagonally</h4>
          <p><code>$$+ (x^2)(-\\cos x)$$</code></p>
          <p><code>$$- (2x)(-\\sin x)$$</code></p>
          <p><code>$$+ (2)(\\cos x)$$</code></p>
          <h4>3. Combine Terms</h4>
          <p><code>$$-x^2 \\cos x + 2x \\sin x + 2\\cos x + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$(2 - x^2) \\cos x + 2x \\sin x + C$$</code></p>
        `
      },
      'p1_9': {
        problem: "$$\\int x^2 \\tan^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'tanâ»Â¹ x' is Inverse Trig (I), 'xÂ²' is Algebraic (A). 'I' comes first.</p>
          <ul><li><code>Let $$u = \\tan^{-1} x$$</code></li><li><code>Let $$dv = x^2 \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{1+x^2} \\, dx$$</code></li><li><code>$$v = \\frac{x^3}{3}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\tan^{-1} x)(\\frac{x^3}{3}) - \\int (\\frac{x^3}{3})(\\frac{1}{1+x^2} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^3 \\tan^{-1} x}{3} - \\frac{1}{3} \\int \\frac{x^3}{1+x^2} \\, dx$$</code></p>
          <h4>4. Solve with Polynomial Long Division</h4>
          <p>The fraction <code>$$\\frac{x^3}{1+x^2}$$</code> is improper. We divide <code>$$x^3$$</code> by <code>$$x^2+1$$</code>.</p>
          <p>This gives <code>$$x - \\frac{x}{x^2+1}$$</code>. So we need to solve:</p>
          <p><code>$$\\int (x - \\frac{x}{x^2+1}) \\, dx = \\int x \\, dx - \\int \\frac{x}{x^2+1} \\, dx$$</code></p>
          <p>The first part is <code>$$\\frac{x^2}{2}$$</code>. The second part is a u-sub (let <code>$$w=x^2+1$$</code>), which solves to <code>$$\\frac{1}{2} \\ln(x^2+1)$$</code>.</p>
          <p>So, <code>$$\\int \\frac{x^3}{1+x^2} \\, dx = \\frac{x^2}{2} - \\frac{1}{2} \\ln(x^2+1)$$</code>.</p>
          <h4>5. Combine Everything</h4>
          <p><code>$$\\frac{x^3 \\tan^{-1} x}{3} - \\frac{1}{3} \\left[ \\frac{x^2}{2} - \\frac{1}{2} \\ln(x^2+1) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{3} x^3 \\tan^{-1} x - \\frac{1}{6} x^2 + \\frac{1}{6} \\ln(1+x^2) + C$$</code></p>
        `
      },
      'p1_10': {
        problem: "$$\\int x \\tan^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'tanâ»Â¹ x' is Inverse Trig (I), 'x' is Algebraic (A). 'I' comes first.</p>
          <ul><li><code>Let $$u = \\tan^{-1} x$$</code></li><li><code>Let $$dv = x \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{1+x^2} \\, dx$$</code></li><li><code>$$v = \\frac{x^2}{2}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\tan^{-1} x)(\\frac{x^2}{2}) - \\int (\\frac{x^2}{2})(\\frac{1}{1+x^2} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^2 \\tan^{-1} x}{2} - \\frac{1}{2} \\int \\frac{x^2}{1+x^2} \\, dx$$</code></p>
          <h4>4. Solve with "Add Zero" Trick</h4>
          <p>For the fraction <code>$$\\frac{x^2}{1+x^2}$$</code>, we add and subtract 1 in the numerator.</p>
          <p><code>$$\\int \\frac{x^2 + 1 - 1}{1+x^2} \\, dx = \\int (\\frac{x^2 + 1}{1+x^2} - \\frac{1}{1+x^2}) \\, dx$$</code></p>
          <p><code>$$\\int (1 - \\frac{1}{1+x^2}) \\, dx = x - \\tan^{-1} x$$</code></p>
          <h4>5. Combine Everything</h4>
          <p><code>$$\\frac{x^2 \\tan^{-1} x}{2} - \\frac{1}{2} \\left[ x - \\tan^{-1} x \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{2} x^2 \\tan^{-1} x - \\frac{1}{2} x + \\frac{1}{2} \\tan^{-1} x + C$$</code></p>
        `
      },
      'p1_11': {
        problem: "$$\\int x^3 \\tan^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'tanâ»Â¹ x' (I) comes before 'xÂ³' (A).</p>
          <ul><li><code>Let $$u = \\tan^{-1} x$$</code></li><li><code>Let $$dv = x^3 \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{1+x^2} \\, dx$$</code></li><li><code>$$v = \\frac{x^4}{4}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\tan^{-1} x)(\\frac{x^4}{4}) - \\int (\\frac{x^4}{4})(\\frac{1}{1+x^2} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^4 \\tan^{-1} x}{4} - \\frac{1}{4} \\int \\frac{x^4}{1+x^2} \\, dx$$</code></p>
          <h4>4. Solve with Polynomial Long Division</h4>
          <p>We divide <code>$$x^4$$</code> by <code>$$x^2+1$$</code>. This gives <code>$$x^2 - 1 + \\frac{1}{x^2+1}$$</code>.</p>
          <p><code>$$\\int (x^2 - 1 + \\frac{1}{x^2+1}) \\, dx$$</code></p>
          <p>This integrates to <code>$$\\frac{x^3}{3} - x + \\tan^{-1} x$$</code>.</p>
          <h4>5. Combine Everything</h4>
          <p><code>$$\\frac{x^4 \\tan^{-1} x}{4} - \\frac{1}{4} \\left[ \\frac{x^3}{3} - x + \\tan^{-1} x \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{4} x^4 \\tan^{-1} x - \\frac{1}{12} x^3 + \\frac{1}{4} x - \\frac{1}{4} \\tan^{-1} x + C$$</code></p>
        `
      },
      'p1_12': {
        problem: "$$\\int x^3 \\cos x \\, dx$$",
        solution: `
          <h4>1. Use Tabular Method (Fast IBP)</h4>
          <p>This requires three rounds of IBP. The Tabular Method is essential here.</p>
          <p>L-I-<b>A</b>-<b>T</b>-E. 'xÂ³' (A) comes before 'cos x' (T).</p>
          <table class="cq-table">
            <tr><th>Differentiate $$u = x^3$$</th><th>Integrate $$dv = \\cos x$$</th><th>Sign</th></tr>
            <tr><td><code>$$x^3$$</code></td><td><code>$$\\cos x$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$3x^2$$</code></td><td><code>$$\\sin x$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$6x$$</code></td><td><code>$$-\\cos x$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$6$$</code></td><td><code>$$-\\sin x$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$0$$</code></td><td><code>$$\\cos x$$</code></td><td></td></tr>
          </table>
          <h4>2. Multiply Diagonally</h4>
          <p><code>$$+ (x^3)(\\sin x)$$</code></p>
          <p><code>$$- (3x^2)(-\\cos x)$$</code></p>
          <p><code>$$+ (6x)(-\\sin x)$$</code></p>
          <p><code>$$- (6)(\\cos x)$$</code></p>
          <h4>3. Combine Terms</h4>
          <p><code>$$x^3 \\sin x + 3x^2 \\cos x - 6x \\sin x - 6 \\cos x + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$(x^3 - 6x) \\sin x + (3x^2 - 6) \\cos x + C$$</code></p>
        `
      },
      'p1_13': {
        problem: "$$\\int \\sin^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (Invisible 1 Trick)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'sinâ»Â¹ x' (I) comes before '1' (A).</p>
          <ul><li><code>Let $$u = \\sin^{-1} x$$</code></li><li><code>Let $$dv = 1 \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{\\sqrt{1-x^2}} \\, dx$$</code></li><li><code>$$v = x$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\sin^{-1} x)(x) - \\int (x)(\\frac{1}{\\sqrt{1-x^2}} \\, dx)$$</code></p>
          <p><code>$$x \\sin^{-1} x - \\int \\frac{x}{\\sqrt{1-x^2}} \\, dx$$</code></p>
          <h4>4. Solve with u-Substitution</h4>
          <p>For the new integral, let <code>$$w = 1-x^2$$</code>, so <code>$$dw = -2x \\, dx$$</code>, which means <code>$$-\\frac{1}{2} dw = x \\, dx$$</code>.</p>
          <p><code>$$x \\sin^{-1} x - \\int \\frac{1}{\\sqrt{w}} (-\\frac{1}{2} dw) = x \\sin^{-1} x + \\frac{1}{2} \\int w^{-1/2} \\, dw$$</code></p>
          <p><code>$$x \\sin^{-1} x + \\frac{1}{2} (2 w^{1/2}) + C = x \\sin^{-1} x + \\sqrt{w} + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$x \\sin^{-1} x + \\sqrt{1-x^2} + C$$</code></p>
        `
      },
      'p1_14': {
        problem: "$$\\int x \\sin^{-1} x \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (LIATE Rule)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. 'sinâ»Â¹ x' (I) comes before 'x' (A).</p>
          <ul><li><code>Let $$u = \\sin^{-1} x$$</code></li><li><code>Let $$dv = x \\, dx$$</code></li></ul>
          <h4>2. Find du and v</h4>
          <ul><li><code>$$du = \\frac{1}{\\sqrt{1-x^2}} \\, dx$$</code></li><li><code>$$v = \\frac{x^2}{2}$$</code></li></ul>
          <h4>3. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$(\\sin^{-1} x)(\\frac{x^2}{2}) - \\int (\\frac{x^2}{2})(\\frac{1}{\\sqrt{1-x^2}} \\, dx)$$</code></p>
          <p><code>$$\\frac{x^2 \\sin^{-1} x}{2} - \\frac{1}{2} \\int \\frac{x^2}{\\sqrt{1-x^2}} \\, dx$$</code></p>
          <h4>4. Solve with Trig Substitution</h4>
          <p>This new integral requires Trig Sub. Let <code>$$x = \\sin \\theta$$</code>, <code>$$dx = \\cos \\theta \\, d\\theta$$</code>.</p>
          <p><code>$$\\int \\frac{\\sin^2 \\theta}{\\sqrt{1-\\sin^2 \\theta}} (\\cos \\theta \\, d\\theta) = \\int \\frac{\\sin^2 \\theta}{\\cos \\theta} (\\cos \\theta \\, d\\theta) = \\int \\sin^2 \\theta \\, d\\theta$$</code></p>
          <p>Using the half-angle identity <code>$$\\sin^2 \\theta = \\frac{1 - \\cos(2\\theta)}{2}$$</code>:</p>
          <p><code>$$\\int \\frac{1 - \\cos(2\\theta)}{2} \\, d\\theta = \\frac{1}{2}(\\theta - \\frac{1}{2}\\sin(2\\theta)) = \\frac{1}{2}(\\theta - \\sin\\theta\\cos\\theta)$$</code></p>
          <p>From <code>$$x = \\sin \\theta$$</code>, we have <code>$$\\theta = \\sin^{-1} x$$</code> and <code>$$\\cos \\theta = \\sqrt{1-x^2}$$</code>.</p>
          <p>So, <code>$$\\int... = \\frac{1}{2}(\\sin^{-1} x - x\\sqrt{1-x^2})$$</code>.</p>
          <h4>5. Combine Everything</h4>
          <p><code>$$\\frac{x^2 \\sin^{-1} x}{2} - \\frac{1}{2} \\left[ \\frac{1}{2}(\\sin^{-1} x - x\\sqrt{1-x^2}) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{2} x^2 \\sin^{-1} x - \\frac{1}{4} \\sin^{-1} x + \\frac{1}{4} x\\sqrt{1-x^2} + C$$</code></p>
        `
      },
      'p1_15': {
        problem: "$$\\int e^x \\sin x \\cos x \\, dx$$",
        solution: `
          <h4>1. Use Trig Identity First</h4>
          <p>This problem is much easier if we simplify the trig part. Use the double-angle identity: <code>$$\\sin(2x) = 2\\sin x \\cos x$$</code>.</p>
          <p>This means <code>$$\\sin x \\cos x = \\frac{1}{2} \\sin(2x)$$</code>.</p>
          <p>The integral becomes: <code>$$\\int e^x (\\frac{1}{2} \\sin(2x)) \\, dx = \\frac{1}{2} \\int e^x \\sin(2x) \\, dx$$</code></p>
          <h4>2. Solve using the "Looping" Method (IBP twice)</h4>
          <p>This is now a classic "looping" integral, just like Problem P3.1, with <code>$$a=1$$</code> and <code>$$b=2$$</code>.</p>
          <p>Let's use the formula we proved in P3.1: <code>$$\\int e^{ax} \\sin(bx) \\, dx = \\frac{e^{ax}}{a^2+b^2}(a \\sin(bx) - b \\cos(bx))$$</code></p>
          <h4>3. Apply the Formula</h4>
          <p>Here, <code>$$a=1$$</code> and <code>$$b=2$$</code>.</p>
          <p><code>$$\\int e^x \\sin(2x) \\, dx = \\frac{e^x}{1^2+2^2}(1 \\sin(2x) - 2 \\cos(2x)) = \\frac{e^x}{5}(\\sin(2x) - 2 \\cos(2x))$$</code></p>
          <h4>4. Combine Everything</h4>
          <p>Don't forget the <code>$$\\frac{1}{2}$$</code> from step 1.</p>
          <p><code>$$\\frac{1}{2} \\left[ \\frac{e^x}{5}(\\sin(2x) - 2 \\cos(2x)) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{e^x}{10}(\\sin(2x) - 2 \\cos(2x)) + C$$</code></p>
        `
      },
      'p1_17': {
        problem: "$$\\int x \\cos^2 x \\, dx$$",
        solution: `
          <h4>1. Use Trig Identity First</h4>
          <p>We can't integrate <code>$$\\cos^2 x$$</code> easily. Use the half-angle identity: <code>$$\\cos^2 x = \\frac{1 + \\cos(2x)}{2}$$</code>.</p>
          <p>The integral becomes: <code>$$\\int x (\\frac{1 + \\cos(2x)}{2}) \\, dx$$</code></p>
          <p><code>$$\\frac{1}{2} \\int (x + x \\cos(2x)) \\, dx = \\frac{1}{2} \\int x \\, dx + \\frac{1}{2} \\int x \\cos(2x) \\, dx$$</code></p>
          <h4>2. Solve Integral 1</h4>
          <p><code>$$\\frac{1}{2} \\int x \\, dx = \\frac{1}{2} (\\frac{x^2}{2}) = \\frac{x^2}{4}$$</code></p>
          <h4>3. Solve Integral 2 (Integration by Parts)</h4>
          <p>For <code>$$\\int x \\cos(2x) \\, dx$$</code>:</p>
          <ul><li><code>Let $$u = x$$</code></li><li><code>Let $$dv = \\cos(2x) \\, dx$$</code></li></ul>
          <ul><li><code>$$du = 1 \\, dx$$</code></li><li><code>$$v = \\frac{1}{2} \\sin(2x)$$</code></li></ul>
          <p><code>$$uv - \\int v \\, du = (x)(\\frac{1}{2} \\sin(2x)) - \\int (\\frac{1}{2} \\sin(2x))(1 \\, dx)$$</code></p>
          <p><code>$$\\frac{1}{2} x \\sin(2x) - \\frac{1}{2} \\int \\sin(2x) \\, dx$$</code></p>
          <p><code>$$\\frac{1}{2} x \\sin(2x) - \\frac{1}{2} (-\\frac{1}{2} \\cos(2x)) = \\frac{1}{2} x \\sin(2x) + \\frac{1}{4} \\cos(2x)$$</code></p>
          <h4>4. Combine Everything</h4>
          <p><code>$$\\frac{x^2}{4} + \\frac{1}{2} \\left[ \\frac{1}{2} x \\sin(2x) + \\frac{1}{4} \\cos(2x) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^2}{4} + \\frac{1}{4} x \\sin(2x) + \\frac{1}{8} \\cos(2x) + C$$</code></p>
        `
      },
      'p1_18': {
        problem: "$$\\int x \\sin^2 x \\, dx$$",
        solution: `
          <h4>1. Use Trig Identity First</h4>
          <p>Use the half-angle identity: <code>$$\\sin^2 x = \\frac{1 - \\cos(2x)}{2}$$</code>.</p>
          <p>The integral becomes: <code>$$\\int x (\\frac{1 - \\cos(2x)}{2}) \\, dx$$</code></p>
          <p><code>$$\\frac{1}{2} \\int (x - x \\cos(2x)) \\, dx = \\frac{1}{2} \\int x \\, dx - \\frac{1}{2} \\int x \\cos(2x) \\, dx$$</code></p>
          <h4>2. Solve Integral 1</h4>
          <p><code>$$\\frac{1}{2} \\int x \\, dx = \\frac{1}{2} (\\frac{x^2}{2}) = \\frac{x^2}{4}$$</code></p>
          <h4>3. Solve Integral 2 (Integration by Parts)</h4>
          <p>This is the same integral as in Problem P1.17.</p>
          <p><code>$$\\int x \\cos(2x) \\, dx = \\frac{1}{2} x \\sin(2x) + \\frac{1}{4} \\cos(2x)$$</code></p>
          <h4>4. Combine Everything</h4>
          <p><code>$$\\frac{x^2}{4} - \\frac{1}{2} \\left[ \\frac{1}{2} x \\sin(2x) + \\frac{1}{4} \\cos(2x) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x^2}{4} - \\frac{1}{4} x \\sin(2x) - \\frac{1}{8} \\cos(2x) + C$$</code></p>
        `
      },
      'p1_19': {
        problem: "$$\\int (\\ln x)^2 \\, dx$$",
        solution: `
          <h4>1. Choose u and dv (Round 1, Invisible 1)</h4>
          <p>L-<b>I</b>-<b>A</b>-T-E. ' (ln x)Â²' is Log (L). We use the "Invisible 1".</p>
          <ul><li><code>Let $$u = (\\ln x)^2$$</code></li><li><code>Let $$dv = 1 \\, dx$$</code></li></ul>
          <ul><li><code>$$du = 2(\\ln x) \\cdot \\frac{1}{x} \\, dx$$</code> (Chain Rule)</li><li><code>$$v = x$$</code></li></ul>
          <h4>2. Apply Formula (Round 1)</h4>
          <p><code>$$uv - \\int v \\, du$$</code></p>
          <p><code>$$((\\ln x)^2)(x) - \\int (x)(2 \\ln x \\cdot \\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$x (\\ln x)^2 - \\int 2 \\ln x \\, dx$$</code></p>
          <p><code>$$x (\\ln x)^2 - 2 \\int \\ln x \\, dx$$</code></p>
          <h4>3. Choose u and dv (Round 2, for $$\\int \\ln x \\, dx$$)</h4>
          <p>This is a standard "parts" problem (Problem I.iv).</p>
          <ul><li><code>Let $$u = \\ln x$$</code></li><li><code>Let $$dv = 1 \\, dx$$</code></li></ul>
          <ul><li><code>$$du = \\frac{1}{x} \\, dx$$</code></li><li><code>$$v = x$$</code></li></ul>
          <h4>4. Apply Formula (Round 2)</h4>
          <p><code>$$uv - \\int v \\, du = (\\ln x)(x) - \\int (x)(\\frac{1}{x} \\, dx)$$</code></p>
          <p><code>$$x \\ln x - \\int 1 \\, dx = x \\ln x - x$$</code></p>
          <h4>5. Combine Everything</h4>
          <p>Substitute the result from step 4 back into the equation from step 2.</p>
          <p><code>$$x (\\ln x)^2 - 2 (x \\ln x - x) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$x (\\ln x)^2 - 2x \\ln x + 2x + C$$</code></p>
        `
      },
      'p1_20': {
        problem: "$$\\int \\ln(\tan x) \\sec^2 x \\, dx$$",
        solution: `
          <h4>1. This is a u-Substitution Problem!</h4>
          <p>This problem looks like "Parts" but it's a clever substitution.</p>
          <p>Notice that the derivative of $$\\tan x$$ is $$\\sec^2 x$$.</p>
          <ul>
            <li><code>Let $$u = \\tan x$$</code></li>
            <li><code>Then $$du = \\sec^2 x \\, dx$$</code></li>
          </ul>
          <h4>2. Substitute</h4>
          <p>The entire integral transforms perfectly:</p>
          <p><code>$$\\int \\ln(u) \\, du$$</code></p>
          <h4>3. Solve with Integration by Parts</h4>
          <p>Now we solve this new integral using the "Invisible 1" trick.</p>
          <ul><li><code>Let $$w = \\ln u$$</code></li><li><code>Let $$dv = 1 \\, du$$</code></li></ul>
          <ul><li><code>$$dw = \\frac{1}{u} \\, du$$</code></li><li><code>$$v = u$$</code></li></ul>
          <p><code>$$wv - \\int v \\, dw = (\\ln u)(u) - \\int (u)(\\frac{1}{u} \\, du)$$</code></p>
          <p><code>$$u \\ln u - \\int 1 \\, du = u \\ln u - u + C$$</code></p>
          <h4>4. Substitute Back</h4>
          <p>Finally, replace <code>$$u$$</code> with <code>$$\\tan x$$</code>.</p>
          <p><strong>Final Answer:</strong> <code>$$(\\tan x) \\ln(\\tan x) - \\tan x + C$$</code></p>
        `
      },
      'p1_21': {
        problem: "$$\\int \\frac{x \\sin^{-1} x}{\\sqrt{1-x^2}} \\, dx$$",
        solution: `
          <h4>1. This is a u-Substitution First!</h4>
          <p>This is another clever substitution. Notice the derivative of $$\\sin^{-1} x$$ is $$\\frac{1}{\\sqrt{1-x^2}}$$.</p>
          <ul>
            <li><code>Let $$u = \\sin^{-1} x$$</code></li>
            <li><code>Then $$du = \\frac{1}{\\sqrt{1-x^2}} \\, dx$$</code></li>
          </ul>
          <p>But what about the extra <code>$$x$$</code>? From our first substitution, if <code>$$u = \\sin^{-1} x$$</code>, then <code>$$x = \\sin u$$</code>.</p>
          <h4>2. Substitute</h4>
          <p>The integral transforms into:</p>
          <p><code>$$\\int (x) (\\sin^{-1} x) (\\frac{1}{\\sqrt{1-x^2}} \\, dx)$$</code></p>
          <p><code>$$\\int (\\sin u) (u) (du) = \\int u \\sin u \\, du$$</code></p>
          <h4>3. Solve with Integration by Parts</h4>
          <p>This is now a simple "Parts" problem (just like I.i but with 'u').</p>
          <ul><li><code>Let $$w = u$$</code></li><li><code>Let $$dv = \\sin u \\, du$$</code></li></ul>
          <ul><li><code>$$dw = 1 \\, du$$</code></li><li><code>$$v = -\\cos u$$</code></li></ul>
          <p><code>$$wv - \\int v \\, dw = (u)(-\\cos u) - \\int (-\\cos u)(1 \\, du)$$</code></p>
          <p><code>$$-u \\cos u + \\int \\cos u \\, du = -u \\cos u + \\sin u + C$$</code></p>
          <h4>4. Substitute Back</h4>
          <p>We need to replace <code>$$u$$</code>, <code>$$\\sin u$$</code>, and <code>$$\\cos u$$</code>.</p>
          <ul>
            <li><code>$$u = \\sin^{-1} x$$</code></li>
            <li><code>$$\\sin u = x$$</code></li>
            <li>Since $$\\sin^2 u + \\cos^2 u = 1$$, we have $$\\cos u = \\sqrt{1 - \\sin^2 u} = \\sqrt{1 - x^2}$$</code>.</li>
          </ul>
          <p><code>$$-(\\sin^{-1} x)(\\sqrt{1-x^2}) + (x) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$x - \\sqrt{1-x^2} \\sin^{-1} x + C$$</code></p>
        `
      },

      // --- ISLAND 2: TRIG ---
      'p2_1': {
        problem: "$$\\int \\tan^4 x \\, dx$$",
        solution: `
          <h4>1. Split the Power</h4>
          <p><code>$$\\int \\tan^2 x \\cdot \\tan^2 x \\, dx$$</code></p>
          <h4>2. Use Trig Identity</h4>
          <p>Use the identity <code>$$\\tan^2 x = \\sec^2 x - 1$$</code> on *one* of the terms.</p>
          <p><code>$$\\int \\tan^2 x (\\sec^2 x - 1) \\, dx$$</code></p>
          <h4>3. Distribute</h4>
          <p><code>$$\\int \\tan^2 x \\sec^2 x \\, dx - \\int \\tan^2 x \\, dx$$</code></p>
          <h4>4. Solve Integral 1 (u-Sub)</h4>
          <p>For <code>$$\\int \\tan^2 x \\sec^2 x \\, dx$$</code>:
          <ul><li><code>Let $$u = \\tan x$$</code></li><li><code>$$du = \\sec^2 x \\, dx$$</code></li></ul>
          <p>This becomes <code>$$\\int u^2 \\, du = \\frac{u^3}{3} = \\frac{\\tan^3 x}{3}$$</code>.</p>
          <h4>5. Solve Integral 2 (Identity Again)</h4>
          <p>For <code>$$\\int \\tan^2 x \\, dx$$</code>:
          <p>Use the identity again: <code>$$\\int (\\sec^2 x - 1) \\, dx$$</code></p>
          <p>This integrates to <code>$$\\tan x - x$$</code>.</p>
          <h4>6. Combine Everything</h4>
          <p><code>$$(\\frac{\\tan^3 x}{3}) - (\\tan x - x) + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{3} \\tan^3 x - \\tan x + x + C$$</code></p>
        `
      },
      'p2_2': {
        problem: "$$\\int \\sec^4 x \\, dx$$",
        solution: `
          <h4>1. Split the Power</h4>
          <p>Save a <code>$$\\sec^2 x$$</code> (which is the derivative of $$\\tan x$$).</p>
          <p><code>$$\\int \\sec^2 x \\cdot \\sec^2 x \\, dx$$</code></p>
          <h4>2. Use Trig Identity</h4>
          <p>Use the identity <code>$$\\sec^2 x = 1 + \\tan^2 x$$</code>.</p>
          <p><code>$$\\int (1 + \\tan^2 x) \\sec^2 x \\, dx$$</code></p>
          <h4>3. Use u-Substitution</h4>
          <ul><li><code>Let $$u = \\tan x$$</code></li><li><code>$$du = \\sec^2 x \\, dx$$</code></li></ul>
          <p>The integral becomes:</p>
          <p><code>$$\\int (1 + u^2) \\, du$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$u + \\frac{u^3}{3} + C$$</code></p>
          <h4>5. Substitute Back</h4>
          <p><strong>Final Answer:</strong> <code>$$\\tan x + \\frac{1}{3} \\tan^3 x + C$$</code></p>
        `
      },
      'p2_3': {
        problem: "$$\\int e^x \\sin 2x \\cos x \\, dx$$",
        solution: `
          <h4>1. Use Product-to-Sum Identity</h4>
          <p>This is a very tricky problem. We must use the identity: <code>$$\\sin A \\cos B = \\frac{1}{2}[\\sin(A+B) + \\sin(A-B)]$$</code>.</p>
          <p>Here <code>$$A=2x$$</code> and <code>$$B=x$$</code>.</p>
          <p><code>$$\\sin(2x) \\cos(x) = \\frac{1}{2}[\\sin(3x) + \\sin(x)]$$</code></p>
          <h4>2. Simplify the Integral</h4>
          <p><code>$$\\int e^x \\cdot \\frac{1}{2}[\\sin(3x) + \\sin(x)] \\, dx$$</code></p>
          <p><code>$$\\frac{1}{2} \\int e^x \\sin(3x) \\, dx + \\frac{1}{2} \\int e^x \\sin(x) \\, dx$$</code></p>
          <h4>3. Solve Both "Looping" Integrals</h4>
          <p>We use the formula from P3.1: <code>$$\\int e^{ax} \\sin(bx) \\, dx = \\frac{e^{ax}}{a^2+b^2}(a \\sin(bx) - b \\cos(bx))$$</code></p>
          <p><b>For Integral 1 (a=1, b=3):</b> <code>$$\\frac{e^x}{1^2+3^2}(1 \\sin(3x) - 3 \\cos(3x)) = \\frac{e^x}{10}(\\sin(3x) - 3 \\cos(3x))$$</code></p>
          <p><b>For Integral 2 (a=1, b=1):</b> <code>$$\\frac{e^x}{1^2+1^2}(1 \\sin(x) - 1 \\cos(x)) = \\frac{e^x}{2}(\\sin(x) - \\cos(x))$$</code></p>
          <h4>4. Combine Everything</h4>
          <p>Don't forget the <code>$$\\frac{1}{2}$$</code> in front of both!</p>
          <p><code>$$\\frac{1}{2} \\left[ \\frac{e^x}{10}(\\sin(3x) - 3 \\cos(3x)) \\right] + \\frac{1}{2} \\left[ \\frac{e^x}{2}(\\sin(x) - \\cos(x)) \\right] + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{e^x}{20}(\\sin(3x) - 3 \\cos(3x)) + \\frac{e^x}{4}(\\sin(x) - \\cos(x)) + C$$</code></p>
        `
      },
      'p2_4': {
        problem: "$$\\int \\tan^3 x \\sec x \\, dx$$",
        solution: `
          <h4>1. Split the Power</h4>
          <p>Save a <code>$$\\sec x \\tan x$$</code> (which is the derivative of $$\\sec x$$).</p>
          <p><code>$$\\int \\tan^2 x \\cdot (\\sec x \\tan x) \\, dx$$</code></p>
          <h4>2. Use Trig Identity</h4>
          <p>Use the identity <code>$$\\tan^2 x = \\sec^2 x - 1$$</code>.</p>
          <p><code>$$\\int (\\sec^2 x - 1) (\\sec x \\tan x) \\, dx$$</code></p>
          <h4>3. Use u-Substitution</h4>
          <ul><li><code>Let $$u = \\sec x$$</code></li><li><code>$$du = \\sec x \\tan x \\, dx$$</code></li></ul>
          <p>The integral becomes:</p>
          <p><code>$$\\int (u^2 - 1) \\, du$$</code></p>
          <h4>4. Solve the Final Integral</h4>
          <p><code>$$\\frac{u^3}{3} - u + C$$</code></p>
          <h4>5. Substitute Back</h4>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{3} \\sec^3 x - \\sec x + C$$</code></p>
        `
      },
      'p2_5': {
        problem: "$$\\int x^3 e^{5x} \\, dx$$",
        solution: `
          <h4>1. Use Tabular Method (Fast IBP)</h4>
          <p>This is perfect for the Tabular Method, as <code>$$x^3$$</code> differentiates to zero.</p>
          <table class="cq-table">
            <tr><th>Differentiate $$u = x^3$$</th><th>Integrate $$dv = e^{5x}$$</th><th>Sign</th></tr>
            <tr><td><code>$$x^3$$</code></td><td><code>$$e^{5x}$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$3x^2$$</code></td><td><code>$$\\frac{1}{5}e^{5x}$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$6x$$</code></td><td><code>$$\\frac{1}{25}e^{5x}$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$6$$</code></td><td><code>$$\\frac{1}{125}e^{5x}$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$0$$</code></td><td><code>$$\\frac{1}{625}e^{5x}$$</code></td><td></td></tr>
          </table>
          <h4>2. Multiply Diagonally</h4>
          <p>Multiply each term in the first column (starting with the first) by the term in the second column *one row down*. Apply the sign from the sign column.</p>
          <p><code>$$+ (x^3)(\\frac{1}{5}e^{5x})$$</code></p>
          <p><code>$$- (3x^2)(\\frac{1}{25}e^{5x})$$</code></p>
          <p><code>$$+ (6x)(\\frac{1}{125}e^{5x})$$</code></p>
          <p><code>$$- (6)(\\frac{1}{625}e^{5x})$$</code></p>
          <h4>3. Combine Terms</h4>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{5}x^3 e^{5x} - \\frac{3}{25}x^2 e^{5x} + \\frac{6}{125}x e^{5x} - \\frac{6}{625}e^{5x} + C$$</code></p>
        `
      },
      'p2_7': {
        problem: "$$\\int e^{2x} \\cos 3x \\, dx$$",
        solution: `
          <h4>1. This is a "Looping" Integral</h4>
          <p>We can use the formula derived in P3.1. A similar formula exists for cosine:</p>
          <p><code>$$\\int e^{ax} \\cos(bx) \\, dx = \\frac{e^{ax}}{a^2+b^2}(a \\cos(bx) + b \\sin(bx))$$</code></p>
          <h4>2. Apply the Formula</h4>
          <p>Here, <code>$$a=2$$</code> and <code>$$b=3$$</code>.</p>
          <p><code>$$\\int e^{2x} \\cos(3x) \\, dx = \\frac{e^{2x}}{2^2+3^2}(2 \\cos(3x) + 3 \\sin(3x))$$</code></p>
          <p><code>$$\\frac{e^{2x}}{4+9}(2 \\cos(3x) + 3 \\sin(3x))$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{e^{2x}}{13}(2 \\cos(3x) + 3 \\sin(3x)) + C$$</code></p>
        `
      },
      'p2_8': {
        problem: "$$\\int \\csc^3 x \\, dx$$",
        solution: `
          <h4>1. Integration by Parts</h4>
          <p>This is a classic, difficult integral. First, split the power.</p>
          <p><code>$$\\int \\csc x \\cdot \\csc^2 x \\, dx$$</code></p>
          <ul><li><code>Let $$u = \\csc x$$</code></li><li><code>Let $$dv = \\csc^2 x \\, dx$$</code></li></ul>
          <ul><li><code>$$du = -\\csc x \\cot x \\, dx$$</code></li><li><code>$$v = -\\cot x$$</code></li></ul>
          <h4>2. Apply the Parts Formula: $$uv - \\int v \\, du$$</h4>
          <p><code>$$I = (\\csc x)(-\\cot x) - \\int (-\\cot x)(-\\csc x \\cot x \\, dx)$$</code></p>
          <p><code>$$I = -\\csc x \\cot x - \\int \\cot^2 x \\csc x \\, dx$$</code></p>
          <h4>3. Use Trig Identity</h4>
          <p>Use the identity <code>$$\\cot^2 x = \\csc^2 x - 1$$</code>.</p>
          <p><code>$$I = -\\csc x \\cot x - \\int (\\csc^2 x - 1) \\csc x \\, dx$$</code></p>
          <p><code>$$I = -\\csc x \\cot x - \\int (\\csc^3 x - \\csc x) \\, dx$$</code></p>
          <p><code>$$I = -\\csc x \\cot x - \\int \\csc^3 x \\, dx + \\int \\csc x \\, dx$$</code></p>
          <h4>4. The "Loop": Solve for I</h4>
          <p>Notice <code>$$\\int \\csc^3 x \\, dx$$</code> is our original integral, <code>$$I$$</code>.</p>
          <p><code>$$I = -\\csc x \\cot x - I + \\int \\csc x \\, dx$$</code></p>
          <p><code>$$2I = -\\csc x \\cot x + \\int \\csc x \\, dx$$</code></p>
          <p>The standard integral of $$\\csc x$$ is <code>$$-\\ln|\\csc x + \\cot x|$$</code>.</p>
          <p><code>$$2I = -\\csc x \\cot x - \\ln|\\csc x + \\cot x| + C$$</code></p>
          <p><code>$$I = -\\frac{1}{2}\\csc x \\cot x - \\frac{1}{2}\\ln|\\csc x + \\cot x| + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$-\\frac{1}{2}\\csc x \\cot x - \\frac{1}{2}\\ln|\\csc x + \\cot x| + C$$</code></p>
        `
      },

      // --- ISLAND 3: BOSS ---
      'p3_1': {
        problem: "$$\\text{Show that } \\int e^{ax} \\sin(bx) \\, dx = \\frac{e^{ax}}{a^2+b^2}(a \\sin(bx) - b \\cos(bx)) + C$$",
        solution: `
          <p>Let <code>$$I = \\int e^{ax} \\sin(bx) \\, dx$$</code>.</p>
          <h4>1. Integration by Parts (Round 1)</h4>
          <p>L-I-A-<b>T</b>-<b>E</b>. Let's pick Trig for 'u'.</p>
          <ul><li><code>Let $$u = \\sin(bx)$$</code></li><li><code>Let $$dv = e^{ax} \\, dx$$</code></li></ul>
          <ul><li><code>$$du = b \\cos(bx) \\, dx$$</code></li><li><code>$$v = \\frac{1}{a} e^{ax}$$</code></li></ul>
          <p><code>$$I = uv - \\int v \\, du = (\\sin(bx))(\\frac{1}{a} e^{ax}) - \\int (\\frac{1}{a} e^{ax})(b \\cos(bx) \\, dx)$$</code></p>
          <p><code>$$I = \\frac{1}{a} e^{ax} \\sin(bx) - \\frac{b}{a} \\int e^{ax} \\cos(bx) \\, dx$$</code></p>
          <h4>2. Integration by Parts (Round 2)</h4>
          <p>Now we solve the new integral: <code>$$\\int e^{ax} \\cos(bx) \\, dx$$</code></p>
          <ul><li><code>Let $$u = \\cos(bx)$$</code></li><li><code>Let $$dv = e^{ax} \\, dx$$</code></li></ul>
          <ul><li><code>$$du = -b \\sin(bx) \\, dx$$</code></li><li><code>$$v = \\frac{1}{a} e^{ax}$$</code></li></ul>
          <p><code>$$\\int... = (\\cos(bx))(\\frac{1}{a} e^{ax}) - \\int (\\frac{1}{a} e^{ax})(-b \\sin(bx) \\, dx)$$</code></p>
          <p><code>$$\\int... = \\frac{1}{a} e^{ax} \\cos(bx) + \\frac{b}{a} \\int e^{ax} \\sin(bx) \\, dx$$</code></p>
          <h4>3. The "Loop": Substitute Back</h4>
          <p>The original integral <code>$$I$$</code> has reappeared! Substitute this result back into the equation from Step 1.</p>
          <p><code>$$I = \\frac{1}{a} e^{ax} \\sin(bx) - \\frac{b}{a} \\left[ \\frac{1}{a} e^{ax} \\cos(bx) + \\frac{b}{a} I \\right]$$</code></p>
          <h4>4. Solve for I</h4>
          <p><code>$$I = \\frac{1}{a} e^{ax} \\sin(bx) - \\frac{b}{a^2} e^{ax} \\cos(bx) - \\frac{b^2}{a^2} I$$</code></p>
          <p><code>$$I + \\frac{b^2}{a^2} I = \\frac{1}{a} e^{ax} \\sin(bx) - \\frac{b}{a^2} e^{ax} \\cos(bx)$$</code></p>
          <p><code>$$I (1 + \\frac{b^2}{a^2}) = \\frac{a e^{ax} \\sin(bx) - b e^{ax} \\cos(bx)}{a^2}$$</code></p>
          <p><code>$$I (\\frac{a^2 + b^2}{a^2}) = \\frac{e^{ax}(a \\sin(bx) - b \\cos(bx))}{a^2}$$</code></p>
          <p><code>$$I = \\frac{a^2}{a^2 + b^2} \\cdot \\frac{e^{ax}(a \\sin(bx) - b \\cos(bx))}{a^2}$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$I = \\frac{e^{ax}}{a^2+b^2}(a \\sin(bx) - b \\cos(bx)) + C$$</code></p>
        `
      },

      // --- ISLAND 4: TRIG SUB ---
      'p4_1': {
        problem: "$$\\int \\sqrt{a^2 - x^2} \\, dx$$",
        solution: `
          <h4>1. Choose Substitution</h4>
          <p>This is the form <code>$$a^2 - x^2$$</code>, so we use the sine substitution.</p>
          <ul>
            <li><code>Let $$x = a \\sin \\theta$$</code></li>
            <li><code>Then $$dx = a \\cos \\theta \\, d\\theta$$</code></li>
          </ul>
          <h4>2. Substitute</h4>
          <p><code>$$\\int \\sqrt{a^2 - (a \\sin \\theta)^2} \\cdot (a \\cos \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int \\sqrt{a^2 - a^2 \\sin^2 \\theta} \\cdot (a \\cos \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int \\sqrt{a^2(1 - \\sin^2 \\theta)} \\cdot (a \\cos \\theta \\, d\\theta)$$</code></p>
          <p>Using <code>$$1 - \\sin^2 \\theta = \\cos^2 \\theta$$</code>:</p>
          <p><code>$$\\int \\sqrt{a^2 \\cos^2 \\theta} \\cdot (a \\cos \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int (a \\cos \\theta) \\cdot (a \\cos \\theta \\, d\\theta) = \\int a^2 \\cos^2 \\theta \\, d\\theta$$</code></p>
          <h4>3. Solve Trig Integral</h4>
          <p>Use the half-angle identity: <code>$$\\cos^2 \\theta = \\frac{1 + \\cos(2\\theta)}{2}$$</code>.</p>
          <p><code>$$a^2 \\int \\frac{1 + \\cos(2\\theta)}{2} \\, d\\theta = \\frac{a^2}{2} \\int (1 + \\cos(2\\theta)) \\, d\\theta$$</code></p>
          <p><code>$$\\frac{a^2}{2} \\left[ \\theta + \\frac{1}{2}\\sin(2\\theta) \\right] + C$$</code></p>
          <p>Use <code>$$\\sin(2\\theta) = 2\\sin\\theta\\cos\\theta$$</code>:
          <p><code>$$\\frac{a^2}{2} \\left[ \\theta + \\sin\\theta\\cos\\theta \\right] + C$$</code></p>
          <h4>4. Convert Back to x</h4>
          <p>We need to find <code>$$\\theta$$</code>, <code>$$\\sin \\theta$$</code>, and <code>$$\\cos \\theta$$</code> in terms of <code>$$x$$</code>.</p>
          <ul>
            <li>From <code>$$x = a \\sin \\theta$$</code>, we get <code>$$\\sin \\theta = \\frac{x}{a}$$</code>.</li>
            <li>This means <code>$$\\theta = \\sin^{-1}(\\frac{x}{a})$$</code>.</li>
            <li>Draw a triangle: Opposite = <code>$$x$$</code>, Hypotenuse = <code>$$a$$</code>. The Adjacent side is <code>$$\\sqrt{a^2 - x^2}$$</code>.</li>
            <li>From the triangle, <code>$$\\cos \\theta = \\frac{\\text{Adj}}{\\text{Hyp}} = \\frac{\\sqrt{a^2 - x^2}}{a}$$</code>.</li>
          </ul>
          <h4>5. Substitute Back into Solution</h4>
          <p><code>$$\\frac{a^2}{2} \\left[ \\sin^{-1}(\\frac{x}{a}) + (\\frac{x}{a})(\\frac{\\sqrt{a^2 - x^2}}{a}) \\right] + C$$</code></p>
          <p><code>$$\\frac{a^2}{2} \\sin^{-1}(\\frac{x}{a}) + \\frac{a^2}{2} \\frac{x\\sqrt{a^2 - x^2}}{a^2} + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{a^2}{2} \\sin^{-1}(\\frac{x}{a}) + \\frac{x}{2}\\sqrt{a^2 - x^2} + C$$</code></p>
        `
      },
      'p4_2': {
        problem: "$$\\int \\sqrt{x^2 - a^2} \\, dx$$",
        solution: `
          <h4>1. Choose Substitution</h4>
          <p>This is the form <code>$$x^2 - a^2$$</code>, so we use the secant substitution.</p>
          <ul>
            <li><code>Let $$x = a \\sec \\theta$$</code></li>
            <li><code>Then $$dx = a \\sec \\theta \\tan \\theta \\, d\\theta$$</code></li>
          </ul>
          <h4>2. Substitute</h4>
          <p><code>$$\\int \\sqrt{(a \\sec \\theta)^2 - a^2} \\cdot (a \\sec \\theta \\tan \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int \\sqrt{a^2(\\sec^2 \\theta - 1)} \\cdot (a \\sec \\theta \\tan \\theta \\, d\\theta)$$</code></p>
          <p>Using <code>$$\\sec^2 \\theta - 1 = \\tan^2 \\theta$$</code>:</p>
          <p><code>$$\\int \\sqrt{a^2 \\tan^2 \\theta} \\cdot (a \\sec \\theta \\tan \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int (a \\tan \\theta) \\cdot (a \\sec \\theta \\tan \\theta \\, d\\theta) = a^2 \\int \\tan^2 \\theta \\sec \\theta \\, d\\theta$$</code></p>
          <h4>3. Solve Trig Integral</h4>
          <p>This integral is complex. We use <code>$$\\tan^2 \\theta = \\sec^2 \\theta - 1$$</code>.</p>
          <p><code>$$a^2 \\int (\\sec^2 \\theta - 1) \\sec \\theta \\, d\\theta = a^2 \\int \\sec^3 \\theta \\, d\\theta - a^2 \\int \\sec \\theta \\, d\\theta$$</code></p>
          <p>Using the standard integrals for $$\\sec^3 \\theta$$ (from P2.8) and $$\\sec \\theta$$:</p>
          <p><code>$$a^2 \\left[ \\frac{1}{2}(\\sec\\theta\\tan\\theta + \\ln|\\sec\\theta + \\tan\\theta|) \\right] - a^2 \\left[ \\ln|\\sec\\theta + \\tan\\theta| \\right] + C$$</code></p>
          <p><code>$$\\frac{a^2}{2} \\sec\\theta\\tan\\theta - \\frac{a^2}{2} \\ln|\\sec\\theta + \\tan\\theta| + C$$</code></p>
          <h4>4. Convert Back to x</h4>
          <ul>
            <li>From <code>$$x = a \\sec \\theta$$</code>, we get <code>$$\\sec \\theta = \\frac{x}{a}$$</code>.</li>
            <li>Draw a triangle: Hypotenuse = <code>$$x$$</code>, Adjacent = <code>$$a$$</code>. The Opposite side is <code>$$\\sqrt{x^2 - a^2}$$</code>.</li>
            <li>From the triangle, <code>$$\\tan \\theta = \\frac{\\text{Opp}}{\\text{Adj}} = \\frac{\\sqrt{x^2 - a^2}}{a}$$</code>.</li>
          </ul>
          <h4>5. Substitute Back into Solution</h4>
          <p><code>$$\\frac{a^2}{2} (\\frac{x}{a})(\\frac{\\sqrt{x^2 - a^2}}{a}) - \\frac{a^2}{2} \\ln|\\frac{x}{a} + \\frac{\\sqrt{x^2 - a^2}}{a}| + C$$</code></p>
          <p><code>$$\\frac{x\\sqrt{x^2 - a^2}}{2} - \\frac{a^2}{2} \\ln|\\frac{x + \\sqrt{x^2 - a^2}}{a}| + C$$</code></p>
          <p>(The <code>$$- \\frac{a^2}{2} \\ln(a)$$</code> is a constant and gets absorbed into <code>$$C$$</code>).</p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x}{2}\\sqrt{x^2 - a^2} - \\frac{a^2}{2} \\ln|x + \\sqrt{x^2 - a^2}| + C$$</code></p>
        `
      },
      'p4_3': {
        problem: "$$\\int \\sqrt{4 - 5x^2} \\, dx$$",
        solution: `
          <h4>1. Factor out the Coefficient</h4>
          <p>We need the form <code>$$a^2 - x^2$$</code>. First, factor out the <code>$$5$$</code>.</p>
          <p><code>$$\\int \\sqrt{5 (\\frac{4}{5} - x^2)} \\, dx = \\sqrt{5} \\int \\sqrt{\\frac{4}{5} - x^2} \\, dx$$</code></p>
          <p>Now we have <code>$$a^2 = \\frac{4}{5}$$</code>, so <code>$$a = \\frac{2}{\\sqrt{5}}$$</code>.</p>
          <h4>2. Use Trig Substitution</h4>
          <p>Let <code>$$x = a \\sin \\theta = \\frac{2}{\\sqrt{5}} \\sin \\theta$$</code>.
          <p>Then <code>$$dx = \\frac{2}{\\sqrt{5}} \\cos \\theta \\, d\\theta$$</code>.</p>
          <p>The integral becomes: <code>$$\\sqrt{5} \\int \\sqrt{\\frac{4}{5} - \\frac{4}{5} \\sin^2 \\theta} \\cdot (\\frac{2}{\\sqrt{5}} \\cos \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\sqrt{5} \\cdot \\frac{2}{\\sqrt{5}} \\int \\sqrt{\\frac{4}{5}(1 - \\sin^2 \\theta)} \\cdot \\cos \\theta \\, d\\theta$$</code></p>
          <p><code>$$2 \\int \\sqrt{\\frac{4}{5} \\cos^2 \\theta} \\cdot \\cos \\theta \\, d\\theta = 2 \\int (\\frac{2}{\\sqrt{5}} \\cos \\theta) \\cdot \\cos \\theta \\, d\\theta$$</code></p>
          <p><code>$$\\frac{4}{\\sqrt{5}} \\int \\cos^2 \\theta \\, d\\theta$$</code></p>
          <h4>3. Solve Trig Integral</h4>
          <p>Using the solution from P4.1, <code>$$\\int \\cos^2 \\theta \\, d\\theta = \\frac{1}{2}(\\theta + \\sin\\theta\\cos\\theta)$$.</p>
          <p><code>$$\\frac{4}{\\sqrt{5}} \\cdot \\frac{1}{2}(\\theta + \\sin\\theta\\cos\\theta) = \\frac{2}{\\sqrt{5}}(\\theta + \\sin\\theta\\cos\\theta) + C$$</code></p>
          <h4>4. Convert Back to x</h4>
          <ul>
            <li><code>$$\\sin \\theta = \\frac{x}{a} = \\frac{x\\sqrt{5}}{2}$$</code></li>
            <li><code>$$\\theta = \\sin^{-1}(\\frac{x\\sqrt{5}}{2})$$</code></li>
            <li><code>$$\\cos \\theta = \\sqrt{1 - \\sin^2 \\theta} = \\sqrt{1 - \\frac{5x^2}{4}} = \\frac{\\sqrt{4 - 5x^2}}{2}$$</code></li>
          </ul>
          <h4>5. Substitute Back into Solution</h4>
          <p><code>$$\\frac{2}{\\sqrt{5}} \\left[ \\sin^{-1}(\\frac{x\\sqrt{5}}{2}) + (\\frac{x\\sqrt{5}}{2})(\\frac{\\sqrt{4 - 5x^2}}{2}) \\right] + C$$</code></p>
          <p><code>$$\\frac{2}{\\sqrt{5}} \\sin^{-1}(\\frac{x\\sqrt{5}}{2}) + \\frac{2}{\\sqrt{5}} \\frac{x\\sqrt{5}\\sqrt{4 - 5x^2}}{4} + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{2}{\\sqrt{5}} \\sin^{-1}(\\frac{x\\sqrt{5}}{2}) + \\frac{x\\sqrt{4 - 5x^2}}{2} + C$$</code></p>
        `
      },
      'p4_4': {
        problem: "$$\\int \\sqrt{3 - 4x^2} \\, dx$$",
        solution: `
          <h4>1. Factor out the Coefficient</h4>
          <p>Factor out the <code>$$4$$</code>.</p>
          <p><code>$$\\int \\sqrt{4 (\\frac{3}{4} - x^2)} \\, dx = 2 \\int \\sqrt{\\frac{3}{4} - x^2} \\, dx$$</code></p>
          <p>Now we have <code>$$a^2 = \\frac{3}{4}$$</code>, so <code>$$a = \\frac{\\sqrt{3}}{2}$$</code>.</p>
          <h4>2. Use Trig Substitution</h4>
          <p>Let <code>$$x = a \\sin \\theta = \\frac{\\sqrt{3}}{2} \\sin \\theta$$</code>.
          <p>Then <code>$$dx = \\frac{\\sqrt{3}}{2} \\cos \\theta \\, d\\theta$$</code>.</p>
          <p>The integral becomes: <code>$$2 \\int \\sqrt{\\frac{3}{4} - \\frac{3}{4} \\sin^2 \\theta} \\cdot (\\frac{\\sqrt{3}}{2} \\cos \\theta \\, d\\theta)$$</code></p>
          <p><code>$$2 \\cdot \\frac{\\sqrt{3}}{2} \\int \\sqrt{\\frac{3}{4}(1 - \\sin^2 \\theta)} \\cdot \\cos \\theta \\, d\\theta$$</code></p>
          <p><code>$$\\sqrt{3} \\int (\\frac{\\sqrt{3}}{2} \\cos \\theta) \\cdot \\cos \\theta \\, d\\theta = \\frac{3}{2} \\int \\cos^2 \\theta \\, d\\theta$$</code></p>
          <h4>3. Solve Trig Integral</h4>
          <p>Using <code>$$\\int \\cos^2 \\theta \\, d\\theta = \\frac{1}{2}(\\theta + \\sin\\theta\\cos\\theta)$$.</p>
          <p><code>$$\\frac{3}{2} \\cdot \\frac{1}{2}(\\theta + \\sin\\theta\\cos\\theta) = \\frac{3}{4}(\\theta + \\sin\\theta\\cos\\theta) + C$$</code></p>
          <h4>4. Convert Back to x</h4>
          <ul>
            <li><code>$$\\sin \\theta = \\frac{x}{a} = \\frac{2x}{\\sqrt{3}}$$</code></li>
            <li><code>$$\\theta = \\sin^{-1}(\\frac{2x}{\\sqrt{3}})$$</code></li>
            <li><code>$$\\cos \\theta = \\sqrt{1 - \\sin^2 \\theta} = \\sqrt{1 - \\frac{4x^2}{3}} = \\frac{\\sqrt{3 - 4x^2}}{\\sqrt{3}}$$</code></li>
          </ul>
          <h4>5. Substitute Back into Solution</h4>
          <p><code>$$\\frac{3}{4} \\left[ \\sin^{-1}(\\frac{2x}{\\sqrt{3}}) + (\\frac{2x}{\\sqrt{3}})(\\frac{\\sqrt{3 - 4x^2}}{\\sqrt{3}}) \\right] + C$$</code></p>
          <p><code>$$\\frac{3}{4} \\sin^{-1}(\\frac{2x}{\\sqrt{3}}) + \\frac{3}{4} \\frac{2x\\sqrt{3 - 4x^2}}{3} + C$$</code></p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{3}{4} \\sin^{-1}(\\frac{2x}{\\sqrt{3}}) + \\frac{x\\sqrt{3 - 4x^2}}{2} + C$$</code></p>
        `
      },
      'p4_5': {
        problem: "$$\\int \\sqrt{x^2 + 4} \\, dx$$",
        solution: `
          <h4>1. Choose Substitution</h4>
          <p>This is the form <code>$$x^2 + a^2$$</code> where <code>$$a=2$$</code>. We use the tangent substitution.</p>
          <ul>
            <li><code>Let $$x = 2 \\tan \\theta$$</code></li>
            <li><code>Then $$dx = 2 \\sec^2 \\theta \\, d\\theta$$</code></li>
          </ul>
          <h4>2. Substitute</h4>
          <p><code>$$\\int \\sqrt{(2 \\tan \\theta)^2 + 4} \\cdot (2 \\sec^2 \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int \\sqrt{4( \\tan^2 \\theta + 1)} \\cdot (2 \\sec^2 \\theta \\, d\\theta)$$</code></p>
          <p>Using <code>$$1 + \\tan^2 \\theta = \\sec^2 \\theta$$</code>:</p>
          <p><code>$$\\int \\sqrt{4 \\sec^2 \\theta} \\cdot (2 \\sec^2 \\theta \\, d\\theta)$$</code></p>
          <p><code>$$\\int (2 \\sec \\theta) \\cdot (2 \\sec^2 \\theta \\, d\\theta) = 4 \\int \\sec^3 \\theta \\, d\\theta$$</code></p>
          <h4>3. Solve Trig Integral</h4>
          <p>The integral of <code>$$\\sec^3 \\theta$$</code> is a standard, difficult integral (see P2.8).</p>
          <p><code>$$\\int \\sec^3 \\theta \\, d\\theta = \\frac{1}{2}(\\sec\\theta\\tan\\theta + \\ln|\\sec\\theta + \\tan\\theta|)$$</code></p>
          <p>So our integral becomes: <code>$$4 \\cdot \\frac{1}{2}(\\sec\\theta\\tan\\theta + \\ln|\\sec\\theta + \\tan\\theta|) + C$$</code></p>
          <p><code>$$2(\\sec\\theta\\tan\\theta + \\ln|\\sec\\theta + \\tan\\theta|) + C$$</code></p>
          <h4>4. Convert Back to x</h4>
          <p>We need to find <code>$$\\tan \\theta$$</code> and <code>$$\\sec \\theta$$</code> in terms of <code>$$x$$</code>.</p>
          <ul>
            <li>From <code>$$x = 2 \\tan \\theta$$</code>, we get <code>$$\\tan \\theta = \\frac{x}{2}$$</code>.</li>
            <li>Draw a triangle: Opposite = <code>$$x$$</code>, Adjacent = <code>$$2$$</code>. The Hypotenuse is <code>$$\\sqrt{x^2 + 4}$$</code>.</li>
            <li>From the triangle, <code>$$\\sec \\theta = \\frac{\\text{Hyp}}{\\text{Adj}} = \\frac{\\sqrt{x^2 + 4}}{2}$$</code>.</li>
          </ul>
          <h4>5. Substitute Back into Solution</h4>
          <p><code>$$2 \\left[ (\\frac{\\sqrt{x^2 + 4}}{2})(\\frac{x}{2}) + \\ln|\\frac{\\sqrt{x^2 + 4}}{2} + \\frac{x}{2}| \\right] + C$$</code></p>
          <p><code>$$\\frac{x\\sqrt{x^2 + 4}}{2} + 2 \\ln|\\frac{\\sqrt{x^2 + 4} + x}{2}| + C$$</code></p>
          <p>(Note: The <code>$$- 2\\ln(2)$$</code> from the <code>$$/2$$</code> in the log is a constant, so it gets absorbed into <code>$$C$$</code>).</p>
          <p><strong>Final Answer:</strong> <code>$$\\frac{x}{2}\\sqrt{x^2 + 4} + 2 \\ln|x + \\sqrt{x^2 + 4}| + C$$</code></p>
        `
      },
      'p4_6': {
        problem: "$$\\int x^2 e^{ax} \\, dx$$",
        solution: `
          <h4>1. Use Tabular Method (Fast IBP)</h4>
          <p>This is a classic "Parts" problem, perfect for the Tabular Method.</p>
          <p>L-I-<b>A</b>-T-<b>E</b>. 'xÂ²' (A) comes before 'eáµƒË£' (E).</p>
          <table class="cq-table">
            <tr><th>Differentiate $$u = x^2$$</th><th>Integrate $$dv = e^{ax}$$</th><th>Sign</th></tr>
            <tr><td><code>$$x^2$$</code></td><td><code>$$e^{ax}$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$2x$$</code></td><td><code>$$\\frac{1}{a}e^{ax}$$</code></td><td><code>$$-$$</code></td></tr>
            <tr><td><code>$$2$$</code></td><td><code>$$\\frac{1}{a^2}e^{ax}$$</code></td><td><code>$$+$$</code></td></tr>
            <tr><td><code>$$0$$</code></td><td><code>$$\\frac{1}{a^3}e^{ax}$$</code></td><td><code>$$-$$</code></td></tr>
          </table>
          <h4>2. Multiply Diagonally</h4>
          <p><code>$$+ (x^2)(\\frac{1}{a}e^{ax})$$</code></p>
          <p><code>$$- (2x)(\\frac{1}{a^2}e^{ax})$$</code></p>
          <p><code>$$+ (2)(\\frac{1}{a^3}e^{ax})$$</code></p>
          <h4>3. Combine Terms</h4>
          <p><strong>Final Answer:</strong> <code>$$\\frac{1}{a} x^2 e^{ax} - \\frac{2}{a^2} x e^{ax} + \\frac{2}{a^3} e^{ax} + C$$</code></p>
        `
      },
    };

    // --- Modal Logic ---
    const modal = document.getElementById('quest-modal');
    const modalCloseBtn = document.getElementById('cq-modal-close');
    const modalTitle = document.getElementById('cq-modal-title');
    const modalProblem = document.getElementById('cq-modal-problem');
    const modalSolution = document.getElementById('cq-modal-solution');

    // Function to open the modal
    function openModal(problemId) {
      const problemData = problemDatabase[problemId];
      if (!problemData) {
        // Create a default message for problems I haven't written solutions for yet
        const btn = gameRoot.querySelector(`[data-id="${problemId}"]`);
        const problemText = btn ? btn.innerHTML : "This problem";
        
        modalProblem.innerHTML = problemText;
        modalSolution.innerHTML = `<p>A solution for this problem is being prepared. Try another one!</p>`;
        
        // Typeset the problem text
        if (window.MathJax) MathJax.typesetPromise([modalProblem]);

      } else {
        // We have a solution!
        modalProblem.innerHTML = problemData.problem;
        modalSolution.innerHTML = problemData.solution;

        // CRITICAL: Tell MathJax to typeset the new content
        // We do this *after* setting the innerHTML
        if (window.MathJax) MathJax.typesetPromise([modalProblem, modalSolution]);
      }
      
      modalTitle.textContent = `Solution for Problem ${problemId.replace('p1_', 'I.').replace('p2_', 'II.').replace('p3_', 'III.').replace('p4_', 'IV.')}`;
      modal.style.display = 'block';
    }

    // Function to close the modal
    function closeModal() {
      modal.style.display = 'none';
      modalProblem.innerHTML = '';
      modalSolution.innerHTML = '';
    }

    // --- Event Listeners ---
    
    // Add click listener to all problem buttons
    const problemButtons = gameRoot.querySelectorAll('.cq-problem-btn');
    problemButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        openModal(btn.dataset.id);
      });
    });

    // Close modal listeners
    modalCloseBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
      // Close if user clicks on the dark background
      if (event.target === modal) {
        closeModal();
      }
    });

    // This function adds the table styles to the <head>
    function addTableStyles() {
      const styleId = 'cq-table-styles';
      if (document.getElementById(styleId)) return; // Styles already added
      
      const styleSheet = document.createElement("style");
      styleSheet.id = styleId;
      styleSheet.type = "text/css";
      styleSheet.innerText = `
        .cq-table {
          border-collapse: collapse;
          margin: 15px 0;
          font-size: 1em;
          width: 100%;
          font-family: 'Courier New', Courier, monospace;
        }
        .cq-table th, .cq-table td {
          border: 1px solid var(--gray);
          padding: 8px 12px;
          text-align: left;
        }
        .cq-table th {
          background-color: var(--gray-light);
          color: var(--primary-dark);
        }
        .cq-table tr:nth-child(even) {
          background-color: var(--white);
        }
      `;
      document.head.appendChild(styleSheet);
    }
    
    addTableStyles(); // Run the function to add the styles

  } // End of initializeCalculusQuest

})();

// --- START: Fraction Architect Game Script ---
(function() {
    // Check if the game is on the page
    const gameRoot = document.getElementById('architect-game');
    if (!gameRoot) {
        return; // Don't run if the game HTML isn't here
    }

    // --- Game Elements ---
    const problemDisplay = gameRoot.querySelector('#problem-display');
    const guideMessage = gameRoot.querySelector('#guide-message');
    const buildPhase = gameRoot.querySelector('#build-phase');
    const solvePhase = gameRoot.querySelector('#solve-phase');
    const solveABox = gameRoot.querySelector('#solve-a-box');
    const solveBBox = gameRoot.querySelector('#solve-b-box');
    const solveAButton = gameRoot.querySelector('#solve-a-btn');
    const solveBButton = gameRoot.querySelector('#solve-b-btn');
    const dropzones = gameRoot.querySelectorAll('.dropzone');
    const bricks = gameRoot.querySelectorAll('.brick');
    const restartBtn = gameRoot.querySelector('#restart-btn');
    
    let draggedBrick = null;
    let correctDrops = 0;

    // --- Game State & Problems ---
    // Note: All backslashes for MathJax are doubled (\\)
    const problem = {
        start: "$$ \\int \\frac{3x + 1}{x^2 - x - 6} dx $$",
        factored: "$$ \\int \\frac{3x + 1}{(x - 3)(x + 2)} dx $$",
        blueprint: "$$ \\int \\left( \\frac{A}{x - 3} + \\frac{B}{x + 2} \\right) dx $$",
        solved: "$$ \\int \\left( \\frac{2}{x - 3} + \\frac{1}{x + 2} \\right) dx $$",
        final: "$$ 2\\ln|x-3| + \\ln|x+2| + C $$"
    };
    
    const guides = {
        start: "Hello, Architect! This problem looks messy. Let's <strong>factor the denominator</strong> first to see what we're working with. (I've done it for you below!)",
        build: "Great! The denominator has two different factors: <code>(x-3)</code> and <code>(x+2)</code>. <strong>Drag the correct 'bricks' from the toolbox</strong> to build the blueprint.",
        solveA: "âœ… Blueprint complete! Now for the magic. Let's find <strong>A</strong> using the 'Cover-Up' trick. <strong>Click 'Find A'</strong> to see the animation.",
        solveB: "Amazing! We found <strong>A = 2</strong>. Now let's find <strong>B</strong>. <strong>Click 'Find B'</strong>.",
        final: "ðŸŽ‰ You did it! We found <strong>B = 1</strong>. You've broken the hard problem into two simple ones. The rest is just easy integration!"
    };

    // --- Drag & Drop Logic ---
    bricks.forEach(brick => {
        brick.addEventListener('dragstart', (e) => {
            draggedBrick = brick;
            e.dataTransfer.setData('text/plain', brick.dataset.value);
            setTimeout(() => brick.classList.add('dragging'), 0);
        });
        
        brick.addEventListener('dragend', () => {
            if (draggedBrick) {
                 draggedBrick.classList.remove('dragging');
            }
            draggedBrick = null;
        });
    });
    
    dropzones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault(); // Allow dropping
            if (!zone.classList.contains('filled')) {
                zone.classList.add('hover');
            }
        });
        
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('hover');
        });
        
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('hover');
            if (zone.classList.contains('filled') || !draggedBrick) return;

            const data = e.dataTransfer.getData('text/plain');
            
            if (data === zone.dataset.correctAnswer) {
                // --- CORRECT DROP ---
                zone.classList.add('filled');
                zone.innerHTML = `$$ ${data} $$`;
                if (window.MathJax) MathJax.typesetPromise([zone]);
                draggedBrick.style.display = 'none'; // Hide the brick
                correctDrops++;
                
                // Check if all drops are correct
                if (correctDrops === dropzones.length) {
                    setTimeout(goToSolvePhase, 1000);
                }
            } else {
                // --- WRONG DROP ---
                draggedBrick.classList.add('wiggle-reject');
                setTimeout(() => {
                    if (draggedBrick) {
                        draggedBrick.classList.remove('wiggle-reject');
                    }
                }, 400);
            }
        });
    });

    // --- Game Flow Logic ---
    function startGame() {
        correctDrops = 0;
        problemDisplay.innerHTML = problem.start;
        guideMessage.innerHTML = guides.start;
        
        // Animate to factored form
        setTimeout(() => {
            problemDisplay.innerHTML = problem.factored;
            guideMessage.innerHTML = guides.build;
            if (window.MathJax) MathJax.typesetPromise([problemDisplay]);
        }, 2500);

        // Reset UI
        buildPhase.style.display = 'block';
        solvePhase.style.display = 'none';
        
        // Reset Solve Phase
        solveABox.style.display = 'block';
        solveABox.classList.remove('fade-in');
        solveABox.innerHTML = `
            <p>Let's find <strong>A</strong>. We cover <code>(x-3)</code> and plug in <code>x=3</code>.</p>
            <div style="font-size: 1.5em; position: relative; padding: 20px 0;">
                $$ \\frac{3x + 1}{\\color{red}{(x - 3)}}(x + 2)} $$
            </div>
            <button class="calm-btn" id="solve-a-btn">Find A</button>
        `;
        // Re-add event listener after rebuilding HTML
        gameRoot.querySelector('#solve-a-btn').addEventListener('click', onSolveAClick);

        solveBBox.style.display = 'none';
        solveBBox.classList.remove('fade-in');
        solveBBox.innerHTML = `
            <p>Now find <strong>B</strong>. We cover <code>(x+2)</code> and plug in <code>x=-2</code>.</p>
            <div style="font-size: 1.5em; position: relative; padding: 20px 0;">
                $$ \\frac{3x + 1}{(x - 3)}\\color{blue}{(x + 2)} $$
            </div>
            <button class="calm-btn" id="solve-b-btn">Find B</button>
        `;
        // Re-add event listener
        gameRoot.querySelector('#solve-b-btn').addEventListener('click', onSolveBClick);
        
        dropzones.forEach(zone => {
            zone.classList.remove('filled');
            zone.innerHTML = '...';
        });
        bricks.forEach(brick => {
            brick.style.display = 'block';
        });
        
        if (window.MathJax) MathJax.typesetPromise([gameRoot]);
    }
    
    function goToSolvePhase() {
        problemDisplay.innerHTML = problem.blueprint;
        guideMessage.innerHTML = guides.solveA;
        buildPhase.style.display = 'none';
        solvePhase.style.display = 'block';
        solveABox.classList.add('fade-in');
        if (window.MathJax) MathJax.typesetPromise([gameRoot]);
    }
    
    // --- Solve Button Animations ---
    function onSolveAClick(e) {
        e.target.disabled = true;
        solveABox.innerHTML = `
            <p>To find A, plug <code>x=3</code> into the covered problem:</p>
            <div style="font-size: 1.5em; padding: 20px 0;">
                $$ A = \\frac{3(3) + 1}{(3) + 2} = \\frac{10}{5} = \\strong{2} $$
            </div>
        `;
        if (window.MathJax) MathJax.typesetPromise([solveABox]);
        
        setTimeout(() => {
            guideMessage.innerHTML = guides.solveB;
            solveBBox.style.display = 'block';
            solveBBox.classList.add('fade-in');
        }, 1500);
    }
    
    function onSolveBClick(e) {
        e.target.disabled = true;
        solveBBox.innerHTML = `
            <p>To find B, plug <code>x=-2</code> into the covered problem:</p>
            <div style="font-size: 1.5em; padding: 20px 0;">
                $$ B = \\frac{3(-2) + 1}{(-2) - 3} = \\frac{-5}{-5} = \\strong{1} $$
            </div>
        `;
        if (window.MathJax) MathJax.typesetPromise([solveBBox]);
        
        setTimeout(() => {
            guideMessage.innerHTML = guides.final;
            problemDisplay.innerHTML = problem.solved;
            if (window.MathJax) MathJax.typesetPromise([problemDisplay]);
        }, 1500);

        setTimeout(() => {
            problemDisplay.innerHTML = problem.final;
            if (window.MathJax) MathJax.typesetPromise([problemDisplay]);
        }, 3500);
    }
    
    restartBtn.addEventListener('click', startGame);

    // --- Add initial event listeners ---
    gameRoot.querySelector('#solve-a-btn').addEventListener('click', onSolveAClick);
    gameRoot.querySelector('#solve-b-btn').addEventListener('click', onSolveBClick);

    // --- Start Game ---
    startGame();
})();
// --- START: Antiderivative Coaster Game Script ---
(function() {
    // Check if the game is on the page
    const gameRoot = document.getElementById('coaster-game');
    if (!gameRoot) {
        return; // Don't run if the game HTML isn't here
    }

    // --- Game Elements ---
    const problemDisplay = gameRoot.querySelector('#problem-display');
    const guideMessage = gameRoot.querySelector('#guide-message');
    const calcBox = gameRoot.querySelector('#calculation-box');
    const findABtn = gameRoot.querySelector('#find-a-btn');
    const findBBtn = gameRoot.querySelector('#find-b-btn');
    const restartBtn = gameRoot.querySelector('#restart-btn');
    const car = gameRoot.querySelector('#coaster-car');
    const canvas = gameRoot.querySelector('#coaster-chart');
    
    let chart;
    let F_b_val = null;
    let F_a_val = null;

    // --- The Antiderivative Function ---
    // F(x) = x^3/3 + x
    function F(x) {
        return (x * x * x) / 3 + x;
    }
    
    // --- Chart.js Setup ---
    function createChart() {
        if (chart) {
            chart.destroy();
        }
        // Check if canvas context exists
        if (!canvas) return; 
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        // Generate data points for the "track"
        const data = [];
        for (let x = -1; x <= 3; x += 0.25) {
            data.push({x: x, y: F(x)});
        }
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'F(x) = xÂ³/3 + x',
                    data: data,
                    borderColor: 'var(--primary)',
                    borderWidth: 4,
                    tension: 0.1,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000 // Animate the drawing of the track
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        min: -0.5,
                        max: 2.5
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // --- Animation Logic ---
    function animateCarTo(x_val) {
        if (!chart) return; // Don't run if chart isn't ready
        const y_val = F(x_val);
        
        // Convert data coords to pixel coords
        const pixelX = chart.scales.x.getPixelForValue(x_val);
        const pixelY = chart.scales.y.getPixelForValue(y_val);
        
        car.style.opacity = '1';
        car.style.left = `${pixelX - 15}px`; // Adjust for car size
        car.style.top = `${pixelY - 15}px`;
    }
    
    // --- Game Flow Logic ---
    function startGame() {
        guideMessage.innerHTML = "Let's ride! First, the 'track' (antiderivative) is built for us: <strong>F(x) = xÂ³/3 + x</strong>";
        problemDisplay.innerHTML = "$$ \\int_{0}^{2} (x^2 + 1) dx $$";
        if (window.MathJax) MathJax.typesetPromise([problemDisplay]);
        
        // Reset buttons and values
        findBBtn.disabled = false;
        findABtn.disabled = true;
        restartBtn.style.display = 'none';
        calcBox.classList.remove('visible');
        calcBox.innerHTML = '';
        car.style.opacity = '0';
        F_b_val = null;
        F_a_val = null;
        
        createChart();
    }

    findBBtn.addEventListener('click', () => {
        guideMessage.innerHTML = "Finding height at the <strong>end (b=2)</strong>...";
        animateCarTo(2);
        F_b_val = F(2); // (2^3)/3 + 2 = 8/3 + 6/3 = 14/3
        
        calcBox.classList.add('visible');
        calcBox.innerHTML = `
            <strong>Step 1: Calculate F(b) = F(2)</strong><br>
            F(2) = (2)Â³/3 + (2)<br>
            F(2) = 8/3 + 2<br>
            F(2) = 14/3 â‰ˆ 4.67
        `;
        
        findBBtn.disabled = true;
        findABtn.disabled = false;
    });
    
    findABtn.addEventListener('click', () => {
        guideMessage.innerHTML = "Finding height at the <strong>start (a=0)</strong>...";
        animateCarTo(0);
        F_a_val = F(0); // 0
        
        calcBox.innerHTML += `
            <br><br><strong>Step 2: Calculate F(a) = F(0)</strong><br>
            F(0) = (0)Â³/3 + (0)<br>
            F(0) = 0
        `;
        
        findABtn.disabled = true;
        setTimeout(showFinalAnswer, 1500); // Show final step automatically
    });
    
    function showFinalAnswer() {
        guideMessage.innerHTML = "Done! The answer is the <strong>difference in height: F(b) - F(a)</strong>.";
        
        calcBox.innerHTML += `
            <br><br><strong>Step 3: Find F(b) - F(a)</strong><br>
            (14/3) - (0) = <span class="final-answer">14/3</span>
        `;
        
        restartBtn.style.display = 'block';
    }

    restartBtn.addEventListener('click', startGame);

    // --- Start Game ---
    // We add a small delay to make sure Chart.js is ready
    setTimeout(startGame, 100);

})();
// --- END: Antiderivative Coaster Game Script ---
// --- START: Area Surveyor Game Script ---
(function() {
    // Check if the game is on the page
    const gameRoot = document.getElementById('area-surveyor-game');
    if (!gameRoot) {
        return; // Don't run if the game HTML isn't here
    }

    // --- Game Elements ---
    const problemDisplay = gameRoot.querySelector('#as-problem-display');
    const guideMessage = gameRoot.querySelector('#as-guide-message');
    const phase1 = gameRoot.querySelector('#as-phase-1-bounds');
    const phase2 = gameRoot.querySelector('#as-phase-2-build');
    const phase3 = gameRoot.querySelector('#as-phase-3-solve');
    const restartBtn = gameRoot.querySelector('#as-restart-btn');
    
    let draggedBrick = null;
    let correctDrops = 0;
    let chart;

    // --- Game Flow & Animations ---
    function runPhase1() {
        setTimeout(() => gameRoot.querySelector('#as-bound-1').classList.add('visible'), 500);
        setTimeout(() => gameRoot.querySelector('#as-bound-2').classList.add('visible'), 1500);
        setTimeout(() => gameRoot.querySelector('#as-bound-3').classList.add('visible'), 2500);
        setTimeout(() => gameRoot.querySelector('#as-bound-4').classList.add('visible'), 3500);
        setTimeout(goToPhase2, 4500);
    }
    
    function goToPhase2() {
        guideMessage.innerHTML = "Great! Our bounds are $a=0$ and $b=4$. Now, <strong>drag the bricks</strong> to build the definite integral blueprint.";
        phase1.style.display = 'none';
        phase2.style.display = 'block';
        if (window.MathJax) MathJax.typesetPromise([gameRoot]);
    }

    function goToPhase3() {
        guideMessage.innerHTML = "Perfect! You built the integral: $$\\int_{0}^{4} (4x - x^2) dx$$<br>Now, let's find the 'track' (the antiderivative) step-by-step.";
        phase2.style.display = 'none';
        phase3.style.display = 'block';
        
        // Animate the solution steps
        setTimeout(() => gameRoot.querySelector('#as-solve-1').classList.add('visible'), 500);
        setTimeout(() => gameRoot.querySelector('#as-solve-2').classList.add('visible'), 1500);
        setTimeout(() => gameRoot.querySelector('#as-solve-3').classList.add('visible'), 2500);
        setTimeout(() => gameRoot.querySelector('#as-solve-4').classList.add('visible'), 3500);
        setTimeout(() => gameRoot.querySelector('#as-solve-5').classList.add('visible'), 4500);
        setTimeout(() => gameRoot.querySelector('#as-solve-6').classList.add('visible'), 5500);
        
        setTimeout(() => {
            guideMessage.innerHTML = "And here is a graph of the area we just found! Well done!";
            drawChart();
            restartBtn.style.display = 'block';
        }, 6500);
        
        if (window.MathJax) MathJax.typesetPromise([phase3]);
    }

    // --- Drag & Drop Logic ---
    const bricks = gameRoot.querySelectorAll('.brick');
    const dropzones = gameRoot.querySelectorAll('.dropzone');

    bricks.forEach(brick => {
        brick.addEventListener('dragstart', (e) => {
            draggedBrick = brick;
            e.dataTransfer.setData('text/plain', brick.dataset.value);
            setTimeout(() => brick.classList.add('dragging'), 0);
        });
        
        brick.addEventListener('dragend', () => {
            if (draggedBrick) draggedBrick.classList.remove('dragging');
            draggedBrick = null;
        });
    });
    
    dropzones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            if (!zone.classList.contains('filled')) zone.classList.add('hover');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('hover'));
        
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('hover');
            if (zone.classList.contains('filled') || !draggedBrick) return;

            const data = e.dataTransfer.getData('text/plain');
            
            if (data === zone.dataset.correctAnswer) {
                // --- CORRECT DROP ---
                zone.classList.add('filled');
                zone.innerHTML = `$$ ${data} $$`; // LaTeX in JS needs no extra slashes here
                if (window.MathJax) MathJax.typesetPromise([zone]);
                draggedBrick.style.display = 'none'; 
                correctDrops++;
                
                if (correctDrops === dropzones.length) {
                    setTimeout(goToPhase3, 1000);
                }
            } else {
                // --- WRONG DROP ---
                draggedBrick.classList.add('wiggle-reject');
                setTimeout(() => {
                    if (draggedBrick) draggedBrick.classList.remove('wiggle-reject');
                }, 400);
            }
        });
    });

    // --- Chart.js Logic ---
    function drawChart() {
        const canvas = gameRoot.querySelector('#as-coaster-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (chart) chart.destroy();
        
        // f(x) = 4x - x^2
        const data = [];
        const labels = [];
        for (let x = -1; x <= 5; x += 0.25) {
            labels.push(x);
            data.push(4*x - x*x);
        }
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'y = 4x - xÂ²',
                    data: data,
                    borderColor: 'var(--primary)',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', // Fill color
                    fill: {
                        target: 'origin', // Fill to x-axis
                        above: 'rgba(59, 130, 246, 0.2)', // Area above x-axis
                        below: 'rgba(239, 68, 68, 0.2)' // Area below x-axis
                    },
                    borderWidth: 3,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { min: 0, max: 4 }, // Focus on our bounds
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
    
    // --- Start/Restart Logic ---
    function startGame() {
        correctDrops = 0;
        phase1.style.display = 'block';
        phase2.style.display = 'none';
        phase3.style.display = 'none';
        restartBtn.style.display = 'none';
        guideMessage.innerHTML = "Let's find our 'survey plot' bounds, $a$ and $b$. We must find the x-intercepts by setting $y=0$.";
        
        // Reset phase 1
        gameRoot.querySelectorAll('.bound-step').forEach(el => el.classList.remove('visible'));
        
        // Reset phase 2
        dropzones.forEach(zone => {
            zone.classList.remove('filled');
            let text = '...';
            if (zone.id === 'as-drop-f') text = 'f(x)?';
            if (zone.id === 'as-drop-a') text = 'a?';
            if (zone.id === 'as-drop-b') text = 'b?';
            zone.innerHTML = text;
        });
        bricks.forEach(brick => brick.style.display = 'block');
        
        // Reset phase 3
        gameRoot.querySelectorAll('.solve-step').forEach(el => el.classList.remove('visible'));
        if (chart) chart.destroy();

        // Rerender MathJax
        if (window.MathJax) MathJax.typesetPromise([gameRoot]);
        
        // Start the animations
        runPhase1();
    }
    
    restartBtn.addEventListener('click', startGame);
    
    // --- Initial Start ---
    // We run this to make sure MathJax is loaded before starting
    if (typeof MathJax !== 'undefined' && MathJax.startup) {
        MathJax.startup.promise.then(startGame);
    } else {
        // Fallback if MathJax is still loading
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(startGame, 500); 
        });
    }

})();
// --- END: Area Surveyor Game Script ---
// --- START: Variable Sorter Game Script ---
(function() {
    // Check if the game is on the page
    const gameRoot = document.getElementById('variable-sorter-game');
    if (!gameRoot) {
        return; // Don't run if the game HTML isn't here
    }

    // --- Game Elements ---
    const problemDisplay = gameRoot.querySelector('#vs-problem-display');
    const guideMessage = gameRoot.querySelector('#vs-guide-message');
    const sortPhase = gameRoot.querySelector('#vs-sort-phase');
    const solvePhase = gameRoot.querySelector('#vs-solve-phase');
    const yDropArea = gameRoot.querySelector('#vs-y-drop-area');
    const xDropArea = gameRoot.querySelector('#vs-x-drop-area');
    const toolbox = gameRoot.querySelector('#vs-toolbox');
    const restartBtn = gameRoot.querySelector('#vs-restart-btn');
    
    let draggedBrick = null;
    let correctDrops = 0;

    // --- Game Data ---
    // NOTE: All LaTeX commands are escaped with (\\)
    const problem = {
        start: "$$ y dx + x dy = 0 $$",
        rearranged: "$$ x dy = -y dx $$",
        bricks: [
            { id: 'vs-b1', content: '$$ \\frac{1}{y} $$', zone: 'y' },
            { id: 'vs-b2', content: '$$ dy $$', zone: 'y' },
            { id: 'vs-b3', content: '$$ -\\frac{1}{x} $$', zone: 'x' },
            { id: 'vs-b4', content: '$$ dx $$', zone: 'x' }
        ],
        steps: [
            { id: '#vs-solve-1', text: '$$ \\int \\frac{1}{y} dy = \\int -\\frac{1}{x} dx $$' },
            { id: '#vs-solve-2', text: '$$ \\ln|y| = -\\ln|x| + C $$' },
            { id: '#vs-solve-3', text: '$$ \\ln|y| + \\ln|x| = C $$' },
            { id: '#vs-solve-4', text: '$$ \\ln|xy| = C $$' },
            { id: '#vs-solve-5', text: '$$ e^{\\ln|xy|} = e^C $$' },
            { id: '#vs-solve-6', text: '$$ xy = C $$' },
            { id: '#vs-solve-7', text: '<span class="final-answer">$$ y = \\frac{C}{x} $$</span>' }
        ]
    };
    
    const guides = {
        start: "Let's solve this! First, we need to separate the variables. I'll move the <code>y dx</code> term over for you.",
        sort: "Great! Now <strong>drag the $y$ terms to the Y-Zone</strong> and the <strong>$x$ terms to the X-Zone</strong> to build the integral.",
        solve: "âœ… Perfect! You've sorted the equation. Now, just watch as the game animates the final solution steps for you."
    };

    // --- Drag & Drop Logic ---
    function createBricks() {
        toolbox.innerHTML = ''; // Clear old bricks
        problem.bricks.forEach(brickData => {
            const brick = document.createElement('div');
            brick.id = brickData.id;
            brick.className = 'brick';
            brick.draggable = true;
            brick.innerHTML = brickData.content;
            brick.dataset.zone = brickData.zone;
            toolbox.appendChild(brick);
        });
        addDragListeners();
    }
    
    function addDragListeners() {
        const bricks = toolbox.querySelectorAll('.brick');
        bricks.forEach(brick => {
            brick.addEventListener('dragstart', (e) => {
                draggedBrick = brick;
                e.dataTransfer.setData('text/plain', brick.id);
                setTimeout(() => brick.classList.add('dragging'), 0);
            });
            
            brick.addEventListener('dragend', () => {
                if (draggedBrick) draggedBrick.classList.remove('dragging');
                draggedBrick = null;
            });
        });
    }
    
    [yDropArea, xDropArea].forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            zone.classList.add('hover');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('hover'));
        
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('hover');
            if (!draggedBrick) return;

            const correctZone = draggedBrick.dataset.zone;
            
            if ((correctZone === 'y' && zone.id === 'vs-y-drop-area') || (correctZone === 'x' && zone.id === 'vs-x-drop-area')) {
                // --- CORRECT DROP ---
                draggedBrick.classList.add('dropped');
                draggedBrick.draggable = false;
                if (correctZone === 'x') draggedBrick.classList.add('x-brick');
                zone.appendChild(draggedBrick);
                correctDrops++;
                
                if (correctDrops === problem.bricks.length) {
                    setTimeout(goToSolvePhase, 1000);
                }
            } else {
                // --- WRONG DROP ---
                draggedBrick.classList.add('wiggle-reject');
                setTimeout(() => {
                    if (draggedBrick) draggedBrick.classList.remove('wiggle-reject');
                }, 400);
            }
        });
    });

    // --- Game Flow Logic ---
    function startGame() {
        correctDrops = 0;
        problemDisplay.innerHTML = problem.start;
        guideMessage.innerHTML = guides.start;
        
        // Animate to rearranged form
        setTimeout(() => {
            problemDisplay.innerHTML = problem.rearranged;
            guideMessage.innerHTML = guides.sort;
            if (window.MathJax) MathJax.typesetPromise([problemDisplay]);
        }, 2500);

        // Reset UI
        sortPhase.style.display = 'grid';
        solvePhase.style.display = 'none';
        yDropArea.innerHTML = '';
        xDropArea.innerHTML = '';
        restartBtn.style.display = 'none';
        
        // Hide all solve steps
        problem.steps.forEach(step => {
            const el = gameRoot.querySelector(step.id);
            el.innerHTML = '';
            el.classList.remove('visible');
        });
        
        createBricks();
        if (window.MathJax) MathJax.typesetPromise([gameRoot]);
    }
    
    function goToSolvePhase() {
        guideMessage.innerHTML = guides.solve;
        sortPhase.style.display = 'none';
        solvePhase.style.display = 'block';
        
        // Animate the solution steps
        let delay = 500;
        problem.steps.forEach(step => {
            setTimeout(() => {
                const el = gameRoot.querySelector(step.id);
                el.innerHTML = step.text;
                el.classList.add('visible');
                if (window.MathJax) MathJax.typesetPromise([el]);
            }, delay);
            delay += 1500; // Time between steps
        });
        
        setTimeout(() => {
            restartBtn.style.display = 'block';
        }, delay);
    }
    
    restartBtn.addEventListener('click', startGame);

    // --- Initial Start ---
    // We run this to make sure MathJax is loaded before starting
    if (typeof MathJax !== 'undefined' && MathJax.startup) {
        MathJax.startup.promise.then(startGame);
    } else {
        // Fallback if MathJax is still loading
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(startGame, 500); 
        });
    }

})();
// --- END: Variable Sorter Game Script ---



  </script>
</body>
</html>